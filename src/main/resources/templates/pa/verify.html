<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout/base :: layout(~{::content})}"
>
  <body>
    <th:block th:fragment="content">
      <style>
        /* Enhanced Visualization Styles */
        .asn1-tree { font-family: 'Courier New', monospace; line-height: 1.6; }
        .asn1-node:hover { background-color: rgba(var(--primary), 0.1); transition: background-color 0.2s ease; }
        @keyframes chainPulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .chain-arrow { animation: chainPulse 2s ease-in-out infinite; }
        details summary { cursor: pointer; user-select: none; }
        details[open] summary svg { transform: rotate(180deg); transition: transform 0.2s ease; }
      </style>
      <div
        class="w-full px-4 lg:px-6 py-4"
        x-data="paVerifyPageState()"
        @alpine:init="init()"
      >
        <!-- Page Header -->
        <div class="mb-8">
          <div class="flex items-center gap-4">
            <div class="p-3 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-600 shadow-lg">
              <!-- Heroicon: identification -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-white">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Zm6-10.125a1.875 1.875 0 1 1-3.75 0 1.875 1.875 0 0 1 3.75 0Zm1.294 6.336a6.721 6.721 0 0 1-3.17.789 6.721 6.721 0 0 1-3.168-.789 3.376 3.376 0 0 1 6.338 0Z" />
              </svg>
            </div>
            <div>
              <h1 class="text-2xl font-bold" :class="$store.theme.darkMode ? 'text-gray-100' : 'text-gray-900'">
                Passive Authentication 검증
              </h1>
              <p class="text-sm" :class="$store.theme.darkMode ? 'text-gray-400' : 'text-gray-500'">
                전자여권 칩 데이터(SOD, Data Groups)를 업로드하여 ICAO 9303 표준에 따른 Passive Authentication을 수행합니다.
              </p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
          <!-- Left Column: File Upload -->
          <div class="lg:col-span-1">
            <div class="rounded-2xl transition-all duration-300 hover:shadow-xl"
                 :class="$store.theme.darkMode ? 'bg-base-100 shadow-lg shadow-black/20' : 'bg-white shadow-lg shadow-gray-200/50'">
              <div class="p-5">
                <div class="flex items-center gap-3 mb-4">
                  <div class="p-2.5 rounded-xl" :class="$store.theme.darkMode ? 'bg-teal-900/30' : 'bg-teal-50'">
                    <!-- Heroicon: arrow-up-tray -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-teal-500">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                    </svg>
                  </div>
                  <h2 class="text-lg font-bold" :class="$store.theme.darkMode ? 'text-gray-100' : 'text-gray-900'">데이터 파일 업로드</h2>
                </div>

                <!-- File Upload -->
                <div class="form-control mb-3">
                  <label class="label py-1">
                    <span class="label-text font-semibold flex items-center gap-1">
                      <!-- Heroicon: folder-open -->
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-info">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.05a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6A2.25 2.25 0 0 1 6 3.75h3.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 0 1.06.44H18A2.25 2.25 0 0 1 20.25 9v.776" />
                      </svg>
                      데이터 파일 선택 (복수 선택 가능)
                    </span>
                  </label>
                  <input
                    type="file"
                    @change="handleDirectoryUpload($event)"
                    multiple
                    accept=".bin"
                    class="file-input file-input-bordered file-input-sm w-full"
                  />
                  <label class="label py-1">
                    <span class="label-text-alt text-base-content/70 flex items-center gap-1">
                      <!-- Heroicon: information-circle -->
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                      </svg>
                      SOD, DG1, DG2 등 .bin 파일 선택
                    </span>
                  </label>
                </div>

                <!-- MRZ Text File Upload (Optional) -->
                <div class="form-control mb-3">
                  <label class="label py-1">
                    <span class="label-text font-semibold flex items-center gap-1">
                      <!-- Heroicon: document-text -->
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-accent">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                      </svg>
                      MRZ 텍스트 파일 (선택사항)
                    </span>
                    <span class="badge badge-xs badge-ghost">Optional</span>
                  </label>
                  <input
                    type="file"
                    @change="handleMrzFileUpload($event)"
                    accept=".txt"
                    class="file-input file-input-bordered file-input-sm w-full"
                  />
                  <label class="label py-1">
                    <span class="label-text-alt text-base-content/70 flex items-center gap-1">
                      <!-- Heroicon: information-circle -->
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                      </svg>
                      mrz.txt 파일 (TD3 포맷: 2줄 × 44자)
                    </span>
                  </label>
                </div>

                <!-- MRZ File Preview -->
                <div x-show="mrzFile" class="alert alert-info py-2 px-3 mb-3">
                  <!-- Heroicon: document-text -->
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                  </svg>
                  <div class="flex-1">
                    <div class="text-sm font-semibold mb-1">MRZ 파일 로드됨</div>
                    <div class="text-xs font-mono" x-text="mrzFile?.name"></div>
                  </div>
                  <button @click="clearMrzFile()" class="btn btn-xs btn-ghost">✕</button>
                </div>

                <!-- MRZ Parsed Data Preview -->
                <div x-show="mrzParsedData" class="rounded-lg p-3 mb-3" :class="$store.theme.darkMode ? 'bg-base-200' : 'bg-gray-50'">
                  <div class="flex items-center gap-2 mb-2">
                    <!-- Heroicon: identification -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-accent">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Zm6-10.125a1.875 1.875 0 1 1-3.75 0 1.875 1.875 0 0 1 3.75 0Zm1.294 6.336a6.721 6.721 0 0 1-3.17.789 6.721 6.721 0 0 1-3.168-.789 3.376 3.376 0 0 1 6.338 0Z" />
                    </svg>
                    <span class="text-sm font-semibold">MRZ 파싱 결과</span>
                    <span class="badge badge-xs badge-accent">mrz.txt</span>
                  </div>
                  <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-xs">
                    <div class="flex justify-between">
                      <span class="text-base-content/60">성명</span>
                      <span class="font-mono" x-text="mrzParsedData?.fullName || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-base-content/60">여권번호</span>
                      <span class="font-mono" x-text="mrzParsedData?.documentNumber || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-base-content/60">국적</span>
                      <span class="font-mono" x-text="mrzParsedData?.nationality || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-base-content/60">생년월일</span>
                      <span class="font-mono" x-text="mrzParsedData?.dateOfBirth || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-base-content/60">성별</span>
                      <span class="font-mono" x-text="mrzParsedData?.sex === 'M' ? '남성' : mrzParsedData?.sex === 'F' ? '여성' : '-'"></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-base-content/60">만료일</span>
                      <span class="font-mono" x-text="mrzParsedData?.expirationDate || '-'"></span>
                    </div>
                  </div>
                  <!-- MRZ Raw Display -->
                  <details class="mt-2">
                    <summary class="text-xs text-base-content/60 cursor-pointer hover:text-base-content">원본 MRZ 보기</summary>
                    <pre class="mt-1 text-[10px] font-mono p-2 rounded overflow-x-auto" :class="$store.theme.darkMode ? 'bg-base-300' : 'bg-gray-100'" x-text="mrzParsedData?.mrzFull || ''"></pre>
                  </details>
                </div>

                <!-- Uploaded Files Summary -->
                <div x-show="uploadedFiles.length > 0" class="alert alert-success py-2 px-3 mb-3">
                  <!-- Heroicon: check-circle -->
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                  </svg>
                  <div class="flex-1">
                    <div class="text-sm font-semibold mb-1">업로드 완료 (<span x-text="uploadedFiles.length"></span>개)</div>
                    <div class="text-xs space-y-0.5">
                      <div x-show="sodFile" class="flex items-center gap-1">
                        <!-- Heroicon: shield-check -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-primary">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" />
                        </svg>
                        <span class="font-mono" x-text="'SOD: ' + sodFile?.name"></span>
                      </div>
                      <template x-for="(file, idx) in dgFiles" :key="idx">
                        <div class="flex items-center gap-1">
                          <!-- Heroicon: circle-stack -->
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-info">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
                          </svg>
                          <span class="font-mono" x-text="'DG' + file.number + ': ' + file.name"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- Verify Button -->
                <button
                  @click="performVerification()"
                  :disabled="!sodFile || verifying"
                  class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium text-white bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <template x-if="verifying">
                    <span class="loading loading-spinner loading-xs"></span>
                  </template>
                  <template x-if="!verifying">
                    <!-- Heroicon: play -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                    </svg>
                  </template>
                  <span x-text="verifying ? '검증 중...' : '검증 시작'"></span>
                </button>

                <!-- Clear Button -->
                <button
                  @click="clearAllData()"
                  :disabled="verifying"
                  class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 mt-2 rounded-xl text-sm font-medium transition-all duration-200 border disabled:opacity-50"
                  :class="$store.theme.darkMode ? 'text-gray-300 border-gray-600 hover:bg-gray-700' : 'text-gray-600 border-gray-300 hover:bg-gray-50'"
                >
                  <!-- Heroicon: x-mark -->
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                  </svg>
                  초기화
                </button>
              </div>
            </div>

            <!-- Data Preview Card -->
            <div
              x-show="sodData"
              class="card bg-base-100 shadow-xl border mt-4"
              :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'"
            >
              <div class="card-body p-5">
                <h3 class="card-title text-base flex items-center gap-2">
                  <!-- Heroicon: eye -->
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-info">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                  </svg>
                  데이터 미리보기
                </h3>

                <!-- SOD Info -->
                <div class="text-sm space-y-2" x-show="sodInfo">
                  <div>
                    <span class="font-semibold">DSC Subject:</span>
                    <p class="text-xs break-all mt-1" x-text="sodInfo?.dscSubject"></p>
                  </div>
                  <div>
                    <span class="font-semibold">DSC Serial:</span>
                    <span class="badge badge-sm" x-text="sodInfo?.dscSerial"></span>
                  </div>
                  <div>
                    <span class="font-semibold">Hash Algorithm:</span>
                    <span class="badge badge-info badge-sm" x-text="sodInfo?.hashAlgorithm"></span>
                  </div>
                  <div>
                    <span class="font-semibold">Data Groups:</span>
                    <div class="flex flex-wrap gap-1 mt-1">
                      <template x-for="dg in sodInfo?.dataGroups || []">
                        <span class="badge badge-sm badge-outline" x-text="'DG' + dg"></span>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- File Sizes -->
                <div class="divider my-2"></div>
                <div class="text-xs opacity-70 space-y-1">
                  <div x-show="sodFile">
                    SOD: <span x-text="formatFileSize(sodData?.byteLength)"></span>
                  </div>
                  <div x-show="dg1File">
                    DG1: <span x-text="formatFileSize(dg1Data?.byteLength)"></span>
                  </div>
                  <div x-show="dg2File">
                    DG2: <span x-text="formatFileSize(dg2Data?.byteLength)"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Verification Steps & Results -->
          <div class="lg:col-span-2">
            <!-- Alert Messages -->
            <div x-show="errorMessage" class="alert alert-error shadow-lg mb-4 py-2">
              <!-- Heroicon: x-circle -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              <span class="text-sm" x-text="errorMessage"></span>
              <button @click="errorMessage = null" class="btn btn-sm btn-ghost">✕</button>
            </div>

            <div x-show="successMessage" class="alert alert-success shadow-lg mb-4 py-2">
              <!-- Heroicon: check-circle -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              <span class="text-sm" x-text="successMessage"></span>
            </div>

            <!-- Verification Steps Timeline -->
            <div class="rounded-2xl transition-all duration-300"
                 :class="$store.theme.darkMode ? 'bg-base-100 shadow-lg shadow-black/20' : 'bg-white shadow-lg shadow-gray-200/50'">
              <div class="p-5">
                <div class="flex items-center gap-3 mb-5">
                  <div class="p-2.5 rounded-xl" :class="$store.theme.darkMode ? 'bg-cyan-900/30' : 'bg-cyan-50'">
                    <!-- Heroicon: clipboard-document-list -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-cyan-500">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" />
                    </svg>
                  </div>
                  <h2 class="text-lg font-bold" :class="$store.theme.darkMode ? 'text-gray-100' : 'text-gray-900'">검증 단계 (ICAO 9303)</h2>
                </div>

                <!-- Step 1: SOD Parsing -->
                <div class="flex items-start gap-3 pb-4" :class="currentStep >= 1 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.parsing)">
                      <template x-if="steps.parsing.status === 'pending'">
                        <span class="font-bold text-sm">1</span>
                      </template>
                      <template x-if="steps.parsing.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.parsing.status === 'success'">
                        <!-- Heroicon: check -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.parsing.status === 'error'">
                        <!-- Heroicon: x-mark -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 1: SOD 파싱</h3>
                    <p class="text-xs opacity-70 mb-1">CMS SignedData 구조 분석 및 Data Group 해시 추출</p>
                    <div x-show="steps.parsing.status !== 'pending'" class="text-sm">
                      <div x-show="steps.parsing.message" class="mb-1 text-xs" x-text="steps.parsing.message"></div>
                      <div x-show="steps.parsing.details" class="bg-base-200 p-2 rounded-lg">
                        <pre class="text-xs overflow-x-auto" x-text="JSON.stringify(steps.parsing.details, null, 2)"></pre>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="divider my-0"></div>

                <!-- Step 2: DSC Extraction -->
                <div class="flex items-start gap-3 pb-4" :class="currentStep >= 2 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.dscExtraction)">
                      <template x-if="steps.dscExtraction.status === 'pending'">
                        <span class="font-bold text-sm">2</span>
                      </template>
                      <template x-if="steps.dscExtraction.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.dscExtraction.status === 'success'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.dscExtraction.status === 'error'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 2: DSC 추출</h3>
                    <p class="text-xs opacity-70 mb-1">SOD에서 Document Signer Certificate 추출</p>
                    <div x-show="steps.dscExtraction.status !== 'pending'" class="text-sm">
                      <div x-show="steps.dscExtraction.message" class="mb-1 text-xs" x-text="steps.dscExtraction.message"></div>
                      <div x-show="steps.dscExtraction.details" class="bg-base-200 p-2 rounded-lg">
                        <div class="space-y-0.5 text-xs">
                          <div><span class="font-semibold">Subject:</span> <span x-text="steps.dscExtraction.details?.subject"></span></div>
                          <div><span class="font-semibold">Serial:</span> <span x-text="steps.dscExtraction.details?.serial"></span></div>
                          <div><span class="font-semibold">Issuer:</span> <span x-text="steps.dscExtraction.details?.issuer"></span></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="divider my-0"></div>

                <!-- Step 3: CSCA Lookup -->
                <div class="flex items-start gap-3 pb-4" :class="currentStep >= 3 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.cscaLookup)">
                      <template x-if="steps.cscaLookup.status === 'pending'">
                        <span class="font-bold text-sm">3</span>
                      </template>
                      <template x-if="steps.cscaLookup.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.cscaLookup.status === 'success'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.cscaLookup.status === 'error'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 3: CSCA 조회</h3>
                    <p class="text-xs opacity-70 mb-1">LDAP에서 Country Signing CA 인증서 조회</p>
                    <div x-show="steps.cscaLookup.status !== 'pending'" class="text-sm">
                      <div x-show="steps.cscaLookup.message" class="mb-1 text-xs" x-text="steps.cscaLookup.message"></div>
                      <div x-show="steps.cscaLookup.details" class="bg-base-200 p-2 rounded-lg text-xs">
                        <div><span class="font-semibold">DN:</span> <span x-text="steps.cscaLookup.details?.dn"></span></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="divider my-0"></div>

                <!-- Step 4: Trust Chain -->
                <div class="flex items-start gap-3 pb-4" :class="currentStep >= 4 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.trustChain)">
                      <template x-if="steps.trustChain.status === 'pending'">
                        <span class="font-bold text-sm">4</span>
                      </template>
                      <template x-if="steps.trustChain.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.trustChain.status === 'success'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.trustChain.status === 'error'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 4: Trust Chain 검증</h3>
                    <p class="text-xs opacity-70 mb-1">DSC가 CSCA에 의해 서명되었는지 검증</p>
                    <div x-show="steps.trustChain.status !== 'pending'" class="text-sm">
                      <div x-show="steps.trustChain.message" class="text-xs" x-text="steps.trustChain.message"></div>
                    </div>
                  </div>
                </div>

                <div class="divider my-0"></div>

                <!-- Step 5: SOD Signature -->
                <div class="flex items-start gap-3 pb-4" :class="currentStep >= 5 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.sodSignature)">
                      <template x-if="steps.sodSignature.status === 'pending'">
                        <span class="font-bold text-sm">5</span>
                      </template>
                      <template x-if="steps.sodSignature.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.sodSignature.status === 'success'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.sodSignature.status === 'error'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 5: SOD 서명 검증</h3>
                    <p class="text-xs opacity-70 mb-1">LDSSecurityObject가 DSC로 서명되었는지 검증</p>
                    <div x-show="steps.sodSignature.status !== 'pending'" class="text-sm">
                      <div x-show="steps.sodSignature.message" class="text-xs" x-text="steps.sodSignature.message"></div>
                    </div>
                  </div>
                </div>

                <div class="divider my-0"></div>

                <!-- Step 6: Data Group Hash -->
                <div class="flex items-start gap-3 pb-4" :class="currentStep >= 6 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.dataGroupHash)">
                      <template x-if="steps.dataGroupHash.status === 'pending'">
                        <span class="font-bold text-sm">6</span>
                      </template>
                      <template x-if="steps.dataGroupHash.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.dataGroupHash.status === 'success'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.dataGroupHash.status === 'error'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 6: Data Group 해시 검증</h3>
                    <p class="text-xs opacity-70 mb-1">SOD의 예상 해시값과 실제 계산된 해시값 비교</p>
                    <div x-show="steps.dataGroupHash.status !== 'pending'" class="text-sm">
                      <div x-show="steps.dataGroupHash.message" class="mb-2 font-semibold text-xs" x-text="steps.dataGroupHash.message"></div>

                      <!-- Detailed Hash Comparison Cards -->
                      <div x-show="steps.dataGroupHash.details" class="space-y-2">
                        <template x-for="(detail, dgNumber) in steps.dataGroupHash.details || {}" :key="dgNumber">
                          <div class="card bg-base-200 shadow-sm border-l-4"
                               :class="detail.valid ? 'border-success' : 'border-error'">
                            <div class="card-body p-2">
                              <!-- Card Header -->
                              <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                  <span class="badge badge-xs badge-primary" x-text="dgNumber"></span>
                                  <span class="text-xs font-semibold" x-text="getDgDescription(dgNumber)"></span>
                                </div>
                                <div class="flex items-center gap-1">
                                  <template x-if="detail.valid">
                                    <!-- Heroicon: check-circle -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-success">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                    </svg>
                                  </template>
                                  <template x-if="!detail.valid">
                                    <!-- Heroicon: x-circle -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-error">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                    </svg>
                                  </template>
                                  <span class="text-xs font-semibold"
                                        :class="detail.valid ? 'text-success' : 'text-error'"
                                        x-text="detail.valid ? 'Match' : 'Mismatch'"></span>
                                </div>
                              </div>

                              <!-- Hash Values Comparison -->
                              <div class="grid grid-cols-1 gap-1 text-xs">
                                <!-- Expected Hash (from SOD) -->
                                <div>
                                  <div class="flex items-center gap-1 mb-0.5">
                                    <!-- Heroicon: book-open -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-info">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                                    </svg>
                                    <span class="font-semibold opacity-70">Expected (SOD):</span>
                                  </div>
                                  <code class="block bg-base-300 p-1.5 rounded text-[10px] break-all font-mono"
                                        x-text="detail.expectedHash"></code>
                                </div>

                                <!-- Calculated Hash (from uploaded file) -->
                                <div>
                                  <div class="flex items-center gap-1 mb-0.5">
                                    <!-- Heroicon: calculator -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3" :class="detail.valid ? 'text-success' : 'text-error'">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V13.5Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25V18Zm2.498-6.75h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V13.5Zm0 2.25h.007v.008h-.007v-.008Zm0 2.25h.007v.008h-.007V18Zm2.504-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5Zm0 2.25h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V18Zm2.498-6.75h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V13.5ZM8.25 6h7.5v2.25h-7.5V6ZM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 0 0 2.25 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0 0 12 2.25Z" />
                                    </svg>
                                    <span class="font-semibold opacity-70">Calculated:</span>
                                  </div>
                                  <code class="block p-1.5 rounded text-[10px] break-all font-mono"
                                        :class="detail.valid ? 'bg-success/10 text-success' : 'bg-error/10 text-error'"
                                        x-text="detail.actualHash"></code>
                                </div>
                              </div>

                              <!-- Match Indicator -->
                              <div class="mt-1 pt-1 border-t border-base-300">
                                <div class="flex items-center gap-1">
                                  <template x-if="detail.valid">
                                    <!-- Heroicon: check-badge -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-success">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
                                    </svg>
                                  </template>
                                  <template x-if="!detail.valid">
                                    <!-- Heroicon: exclamation-triangle -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-error">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                                    </svg>
                                  </template>
                                  <span class="text-xs font-semibold"
                                        :class="detail.valid ? 'text-success' : 'text-error'"
                                        x-text="detail.valid ? 'Hashes Match - Data Integrity Verified' : 'Hash Mismatch - Data May Be Tampered'"></span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="divider my-0"></div>

                <!-- Step 7: CRL Check -->
                <div class="flex items-start gap-3 pb-4" :class="currentStep >= 7 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.crlCheck)">
                      <template x-if="steps.crlCheck.status === 'pending'">
                        <span class="font-bold text-sm">7</span>
                      </template>
                      <template x-if="steps.crlCheck.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.crlCheck.status === 'success'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.crlCheck.status === 'error'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                      <template x-if="steps.crlCheck.status === 'warning'">
                        <!-- Heroicon: exclamation-triangle -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 7: CRL 검사</h3>
                    <p class="text-xs opacity-70 mb-1">DSC 인증서 폐기 여부 확인 (RFC 5280)</p>
                    <div x-show="steps.crlCheck.status !== 'pending'" class="text-sm">
                      <div x-show="steps.crlCheck.message" class="text-xs" x-text="steps.crlCheck.message"></div>
                    </div>
                  </div>
                </div>

                <div class="divider my-0"></div>

                <!-- Step 8: Data Group Parsing -->
                <div class="flex items-start gap-3" :class="currentStep >= 8 ? '' : 'opacity-50'">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center"
                         :class="getStepClass(steps.dgParsing)">
                      <template x-if="steps.dgParsing.status === 'pending'">
                        <span class="font-bold text-sm">8</span>
                      </template>
                      <template x-if="steps.dgParsing.status === 'running'">
                        <span class="loading loading-spinner loading-sm"></span>
                      </template>
                      <template x-if="steps.dgParsing.status === 'success'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                      </template>
                      <template x-if="steps.dgParsing.status === 'error'">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </template>
                    </div>
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="font-bold">Step 8: Data Group 파싱</h3>
                    <p class="text-xs opacity-70 mb-1">DG1 (MRZ) 및 DG2 (얼굴 이미지) 데이터 추출</p>
                    <div x-show="steps.dgParsing.status !== 'pending'" class="text-sm">
                      <div x-show="steps.dgParsing.message" class="mb-2 text-xs" x-text="steps.dgParsing.message"></div>

                      <!-- DG2 (Face Image) + DG1 (MRZ) - Side by Side Layout -->
                      <div class="flex flex-row gap-2">

                        <!-- DG2 Face Image (Left - Compact) -->
                        <div x-show="steps.dgParsing.dg2Data" class="bg-base-200 p-2 rounded-lg flex-shrink-0 w-24">
                          <div class="border-l-2 border-accent pl-2 h-full">
                            <div class="font-semibold text-xs mb-1 flex items-center gap-1">
                              <!-- Heroicon: user-circle -->
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-accent">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                              </svg>
                              DG2
                            </div>

                            <!-- Face Image Display (Small) -->
                            <div x-show="steps.dgParsing.dg2Data?.faceImages?.[0]?.imageDataUrl" class="flex flex-col items-center">
                              <img
                                :src="steps.dgParsing.dg2Data?.faceImages?.[0]?.imageDataUrl"
                                alt="Passport Face Image"
                                class="w-16 h-20 object-cover rounded shadow border border-accent/30"
                              />
                              <div class="mt-1 text-center text-[10px] opacity-70">
                                <span class="badge badge-xs badge-accent" x-text="steps.dgParsing.dg2Data?.faceImages?.[0]?.imageFormat || 'N/A'"></span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- DG1 MRZ Data (Right - Expanded) -->
                        <div x-show="steps.dgParsing.dg1Data" class="bg-base-200 p-2 rounded-lg flex-grow min-w-0">
                          <div class="border-l-2 border-primary pl-2 h-full">
                            <div class="font-semibold text-xs mb-1 flex items-center gap-1">
                              <!-- Heroicon: identification -->
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-primary">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Zm6-10.125a1.875 1.875 0 1 1-3.75 0 1.875 1.875 0 0 1 3.75 0Zm1.294 6.336a6.721 6.721 0 0 1-3.17.789 6.721 6.721 0 0 1-3.168-.789 3.376 3.376 0 0 1 6.338 0Z" />
                              </svg>
                              DG1 - MRZ
                            </div>

                            <!-- MRZ Data Grid (Compact but readable) -->
                            <div class="grid grid-cols-2 gap-1 text-xs">
                              <div class="col-span-2">
                                <span class="badge badge-xs badge-success">Name</span>
                                <code class="ml-1 bg-base-300 px-1 py-0.5 rounded text-xs font-semibold" x-text="steps.dgParsing.dg1Data?.fullName || 'N/A'"></code>
                              </div>
                              <div>
                                <span class="badge badge-xs badge-primary">Doc No.</span>
                                <code class="ml-1 bg-base-300 px-1 py-0.5 rounded font-mono text-xs font-semibold" x-text="steps.dgParsing.dg1Data?.documentNumber || 'N/A'"></code>
                              </div>
                              <div>
                                <span class="badge badge-xs badge-ghost">Nation</span>
                                <code class="ml-1 bg-base-300 px-1 py-0.5 rounded text-xs font-semibold" x-text="steps.dgParsing.dg1Data?.nationality || 'N/A'"></code>
                              </div>
                              <div>
                                <span class="badge badge-xs badge-info">Birth</span>
                                <code class="ml-1 bg-base-300 px-1 py-0.5 rounded text-xs" x-text="steps.dgParsing.dg1Data?.dateOfBirth || 'N/A'"></code>
                              </div>
                              <div>
                                <span class="badge badge-xs badge-warning">Expiry</span>
                                <code class="ml-1 bg-base-300 px-1 py-0.5 rounded text-xs" x-text="steps.dgParsing.dg1Data?.expirationDate || 'N/A'"></code>
                              </div>
                              <div>
                                <span class="badge badge-xs badge-ghost">Sex</span>
                                <code class="ml-1 bg-base-300 px-1 py-0.5 rounded text-xs" x-text="steps.dgParsing.dg1Data?.sex || 'N/A'"></code>
                              </div>
                              <div>
                                <span class="badge badge-xs badge-ghost">Type</span>
                                <code class="ml-1 bg-base-300 px-1 py-0.5 rounded text-xs" x-text="steps.dgParsing.dg1Data?.documentType || 'N/A'"></code>
                              </div>
                            </div>

                            <!-- Raw MRZ (Expandable) -->
                            <details class="mt-1">
                              <summary class="cursor-pointer text-xs hover:text-primary transition-colors flex items-center gap-1">
                                <!-- Heroicon: qr-code -->
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
                                </svg>
                                Raw MRZ
                                <!-- Heroicon: chevron-down -->
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 ml-auto transition-transform">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                                </svg>
                              </summary>
                              <pre class="mt-1 bg-base-300 p-1.5 rounded text-[10px] font-mono whitespace-pre overflow-x-auto" x-text="steps.dgParsing.dg1Data?.mrzFull"></pre>
                            </details>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Final Result Card -->
            <div
              x-show="verificationResult"
              class="card bg-base-100 shadow-xl border mt-4"
              :class="[
                $store.theme.darkMode ? 'border-gray-700' : 'border-gray-200',
                verificationResult?.status === 'VALID' ? 'border-success' : 'border-error'
              ]"
            >
              <div class="card-body p-5">
                <h2 class="card-title text-lg flex items-center gap-2">
                  <template x-if="verificationResult?.status === 'VALID'">
                    <!-- Heroicon: check-circle -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-success">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  </template>
                  <template x-if="verificationResult?.status !== 'VALID'">
                    <!-- Heroicon: x-circle -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-error">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  </template>
                  <span x-text="verificationResult?.status === 'VALID' ? '검증 성공' : '검증 실패'"></span>
                </h2>

                <div class="grid grid-cols-2 gap-3 mt-3">
                  <div class="stat bg-base-200 rounded-lg p-3">
                    <div class="stat-title text-xs">검증 ID</div>
                    <div class="stat-value text-xs break-all" x-text="verificationResult?.verificationId"></div>
                  </div>
                  <div class="stat bg-base-200 rounded-lg p-3">
                    <div class="stat-title text-xs">검증 시각</div>
                    <div class="stat-value text-xs" x-text="formatTimestamp(verificationResult?.verificationTimestamp)"></div>
                  </div>
                </div>

                <div x-show="verificationResult?.errorDetails" class="alert alert-error mt-3 py-2">
                  <span class="text-sm" x-text="verificationResult?.errorDetails"></span>
                </div>

                <!-- View Details Button -->
                <div class="card-actions justify-end mt-3">
                  <a
                    :href="'/pa/history?id=' + verificationResult?.verificationId"
                    class="btn btn-sm btn-outline"
                  >
                    <!-- Heroicon: arrow-top-right-on-square -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                    </svg>
                    상세 보기
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Alpine.js Component Script -->
      <script>
      function paVerifyPageState() {
        console.log('[DEBUG] PA Verify Page State initialized');
        return {
          // File states
          selectedTestData: '',
          sodFile: null,
          dg1File: null,
          dg2File: null,
          sodData: null,
          dg1Data: null,
          dg2Data: null,
          sodInfo: null,
          uploadedFiles: [],
          dgFiles: [],

          // MRZ text file states
          mrzFile: null,
          mrzText: null,
          mrzParsedData: null,

          // Verification states
          verifying: false,
          currentStep: 0,
          steps: {
            parsing: { status: 'pending', message: '', details: null },
            dscExtraction: { status: 'pending', message: '', details: null },
            cscaLookup: { status: 'pending', message: '', details: null },
            trustChain: { status: 'pending', message: '', details: null },
            sodSignature: { status: 'pending', message: '', details: null },
            dataGroupHash: { status: 'pending', message: '', details: null },
            crlCheck: { status: 'pending', message: '', details: null },
            dgParsing: { status: 'pending', message: '', details: null, dg1Data: null, dg2Data: null }
          },
          verificationResult: null,

          // Messages
          errorMessage: null,
          successMessage: null,

          init() {
            console.log('PA Verify Page initialized');
          },

          async loadTestData() {
            if (!this.selectedTestData) return;

            try {
              const response = await fetch(`/api/pa/test-data/${this.selectedTestData}`);
              if (!response.ok) throw new Error('테스트 데이터 로드 실패');

              const data = await response.json();

              // Convert base64 to ArrayBuffer
              this.sodData = this.base64ToArrayBuffer(data.sod);
              if (data.dg1) this.dg1Data = this.base64ToArrayBuffer(data.dg1);
              if (data.dg2) this.dg2Data = this.base64ToArrayBuffer(data.dg2);

              // Set file objects for UI display
              this.sodFile = { name: `${this.selectedTestData}-sod.bin` };
              if (data.dg1) this.dg1File = { name: `${this.selectedTestData}-dg1.bin` };
              if (data.dg2) this.dg2File = { name: `${this.selectedTestData}-dg2.bin` };

              // Load SOD info
              await this.loadSodInfo();

              this.successMessage = '테스트 데이터가 로드되었습니다.';
              setTimeout(() => this.successMessage = null, 3000);
            } catch (error) {
              console.error('Test data load error:', error);
              this.errorMessage = `테스트 데이터 로드 실패: ${error.message}`;
            }
          },

          async handleDirectoryUpload(event) {
            const files = Array.from(event.target.files);
            if (!files || files.length === 0) return;

            this.uploadedFiles = [];
            this.dgFiles = [];
            this.sodFile = null;
            this.dg1File = null;
            this.dg2File = null;

            try {
              for (const file of files) {
                const fileName = file.name.toLowerCase();
                console.log('[DEBUG] Processing file:', file.name, 'Size:', file.size, 'bytes');

                // Detect file type based on filename
                if (fileName.includes('sod') && fileName.endsWith('.bin')) {
                  this.sodFile = file;
                  this.sodData = await file.arrayBuffer();
                  this.uploadedFiles.push({ type: 'SOD', name: file.name, size: file.size });
                  await this.loadSodInfo();
                } else if (fileName.match(/^dg1\.bin$/)) {
                  // Exact match for dg1.bin (not dg10, dg11, dg14, etc.)
                  this.dg1File = file;
                  this.dg1Data = await file.arrayBuffer();
                  // Debug: Calculate SHA-256 hash of uploaded DG1
                  const hash = await this.calculateSha256(this.dg1Data);
                  console.log('[DEBUG] DG1 File SHA-256:', hash);
                  console.log('[DEBUG] DG1 File Size:', file.size, 'bytes');
                  this.uploadedFiles.push({ type: 'DG1', name: file.name, size: file.size });
                  this.dgFiles.push({ number: 1, name: file.name });
                } else if (fileName.match(/^dg2\.bin$/)) {
                  // Exact match for dg2.bin (not dg20, dg21, etc.)
                  this.dg2File = file;
                  this.dg2Data = await file.arrayBuffer();
                  // Debug: Calculate SHA-256 hash of uploaded DG2
                  const hash = await this.calculateSha256(this.dg2Data);
                  console.log('[DEBUG] DG2 File SHA-256:', hash);
                  console.log('[DEBUG] DG2 File Size:', file.size, 'bytes');
                  this.uploadedFiles.push({ type: 'DG2', name: file.name, size: file.size });
                  this.dgFiles.push({ number: 2, name: file.name });
                } else if (fileName.startsWith('dg') && fileName.endsWith('.bin')) {
                  // Handle other DG files (dg3, dg4, ..., dg14, dg15, dg16, etc.)
                  const match = fileName.match(/^dg(\d+)\.bin$/);
                  if (match) {
                    const dgNumber = parseInt(match[1]);
                    this.dgFiles.push({ number: dgNumber, name: file.name });
                    this.uploadedFiles.push({ type: `DG${dgNumber}`, name: file.name, size: file.size });
                  }
                }
              }

              if (this.uploadedFiles.length > 0) {
                this.successMessage = `${this.uploadedFiles.length}개 파일이 업로드되었습니다. (SOD: ${this.sodFile ? '✓' : '✗'}, Data Groups: ${this.dgFiles.length})`;
                setTimeout(() => this.successMessage = null, 5000);
              } else {
                this.errorMessage = '인식 가능한 파일이 없습니다. (sod.bin, dg1.bin, dg2.bin 등)';
              }
            } catch (error) {
              console.error('Directory upload error:', error);
              this.errorMessage = `파일 업로드 실패: ${error.message}`;
            }
          },

          async loadSodInfo() {
            if (!this.sodData) return;

            try {
              const base64Sod = this.arrayBufferToBase64(this.sodData);
              const response = await fetch('/api/pa/parse-sod', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sodBase64: base64Sod })
              });

              if (!response.ok) throw new Error('SOD 파싱 실패');

              this.sodInfo = await response.json();
            } catch (error) {
              console.error('SOD info load error:', error);
            }
          },

          async performVerification() {
            if (!this.sodData) {
              this.errorMessage = 'SOD 파일이 필요합니다.';
              return;
            }

            this.verifying = true;
            this.errorMessage = null;
            this.successMessage = null;
            this.verificationResult = null;
            this.resetSteps();
            this.currentStep = 1;

            try {
              // Debug: Calculate hashes BEFORE Base64 encoding
              if (this.dg1Data) {
                const dg1Hash = await this.calculateSha256(this.dg1Data);
                console.log('[DEBUG] DG1 SHA-256 BEFORE Base64:', dg1Hash);
              }
              if (this.dg2Data) {
                const dg2Hash = await this.calculateSha256(this.dg2Data);
                console.log('[DEBUG] DG2 SHA-256 BEFORE Base64:', dg2Hash);
              }

              // Prepare request data
              const requestData = {
                sod: this.arrayBufferToBase64(this.sodData),
                dataGroups: {}
              };

              if (this.dg1Data) {
                const base64 = this.arrayBufferToBase64(this.dg1Data);
                console.log('[DEBUG] DG1 Base64 length:', base64.length);
                requestData.dataGroups['DG1'] = base64;
              }
              if (this.dg2Data) {
                const base64 = this.arrayBufferToBase64(this.dg2Data);
                console.log('[DEBUG] DG2 Base64 length:', base64.length);
                requestData.dataGroups['DG2'] = base64;
              }

              // Call verification API
              const response = await fetch('/api/pa/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
              });

              const result = await response.json();

              if (!response.ok) {
                throw new Error(result.message || '검증 실패');
              }

              // Update steps based on result
              this.updateStepsFromResult(result);
              this.verificationResult = result;

              if (result.status === 'VALID') {
                this.successMessage = '✓ Passive Authentication 검증 성공';
              } else {
                this.errorMessage = `✗ 검증 실패: ${result.errorDetails || '알 수 없는 오류'}`;
              }

            } catch (error) {
              console.error('Verification error:', error);
              this.errorMessage = `검증 중 오류 발생: ${error.message}`;
              this.markAllStepsError();
            } finally {
              this.verifying = false;
            }
          },

          resetSteps() {
            Object.keys(this.steps).forEach(key => {
              this.steps[key] = { status: 'pending', message: '', details: null };
            });
          },

          updateStepsFromResult(result) {
            console.log('[DEBUG] updateStepsFromResult called with:', result);

            // Extract verification details from API response
            const certChain = result.certificateChainValidation;
            const sodSig = result.sodSignatureValidation;
            const dgValidation = result.dataGroupValidation;

            // Step 1: SOD Parsing
            this.steps.parsing.status = 'success';
            this.steps.parsing.message = '✓ SOD 파싱 완료';
            this.steps.parsing.details = {
              hashAlgorithm: sodSig?.hashAlgorithm || 'SHA-256',
              signatureAlgorithm: sodSig?.signatureAlgorithm || 'SHA256withRSA'
            };

            // Step 2: DSC Extraction
            this.steps.dscExtraction.status = 'success';
            this.steps.dscExtraction.message = '✓ DSC 인증서 추출 완료';
            this.steps.dscExtraction.details = {
              subject: certChain?.dscSubject || 'N/A',
              serial: certChain?.dscSerialNumber || 'N/A',
              issuer: certChain?.cscaSubject || 'N/A'
            };

            // Step 3: CSCA Lookup
            this.steps.cscaLookup.status = certChain?.valid ? 'success' : 'error';
            this.steps.cscaLookup.message = certChain?.valid ? '✓ CSCA 인증서 조회 성공' : '✗ CSCA 조회 실패';
            this.steps.cscaLookup.details = {
              dn: certChain?.cscaSubject || 'N/A'
            };

            // Step 4: Trust Chain Validation
            this.steps.trustChain.status = certChain?.valid ? 'success' : 'error';
            this.steps.trustChain.message = certChain?.valid ? '✓ Trust Chain 검증 성공' : '✗ Trust Chain 검증 실패';

            // Step 5: SOD Signature Validation
            this.steps.sodSignature.status = sodSig?.valid ? 'success' : 'error';
            this.steps.sodSignature.message = sodSig?.valid ? '✓ SOD 서명 검증 성공' : '✗ SOD 서명 검증 실패';

            // Step 6: Data Group Hash Validation
            const allValid = dgValidation?.invalidGroups === 0;
            this.steps.dataGroupHash.status = allValid ? 'success' : 'error';
            this.steps.dataGroupHash.message = allValid
              ? `✓ 모든 Data Group 해시 검증 성공 (${dgValidation?.validGroups}/${dgValidation?.totalGroups})`
              : `✗ Data Group 해시 불일치 발견 (유효: ${dgValidation?.validGroups}, 무효: ${dgValidation?.invalidGroups})`;

            // Format DG details for display
            if (dgValidation?.details) {
              const dgDetails = {};
              Object.entries(dgValidation.details).forEach(([dgNumber, detail]) => {
                dgDetails[dgNumber] = {
                  valid: detail.valid,
                  expectedHash: detail.expectedHash,
                  actualHash: detail.actualHash
                };
              });
              this.steps.dataGroupHash.details = dgDetails;
            }

            // Step 7: CRL Check - 상세 상태 표시
            const crlChecked = certChain?.crlChecked || false;
            const revoked = certChain?.revoked || false;
            const crlStatus = certChain?.crlStatus || 'UNKNOWN';
            const crlMessage = certChain?.crlMessage || '';

            // CRL 상태에 따른 status 및 message 설정
            if (crlStatus === 'VALID') {
              this.steps.crlCheck.status = 'success';
              this.steps.crlCheck.message = '✓ ' + crlMessage;
            } else if (crlStatus === 'REVOKED') {
              this.steps.crlCheck.status = 'error';
              this.steps.crlCheck.message = '✗ ' + crlMessage;
            } else if (crlStatus === 'CRL_UNAVAILABLE') {
              this.steps.crlCheck.status = 'warning';
              this.steps.crlCheck.message = '⚠ ' + crlMessage;
            } else if (crlStatus === 'CRL_EXPIRED') {
              this.steps.crlCheck.status = 'warning';
              this.steps.crlCheck.message = '⚠ ' + crlMessage;
            } else if (crlStatus === 'CRL_INVALID') {
              this.steps.crlCheck.status = 'error';
              this.steps.crlCheck.message = '✗ ' + crlMessage;
            } else {
              // Fallback for legacy responses
              this.steps.crlCheck.status = crlChecked && !revoked ? 'success' : (revoked ? 'error' : 'warning');
              this.steps.crlCheck.message = crlChecked
                ? (revoked ? '✗ 인증서가 폐기되었습니다' : '✓ CRL 확인 완료 - 폐기되지 않음')
                : '⚠ CRL 상태를 확인할 수 없음';
            }

            // Step 8: Data Group Parsing (if DG1 or DG2 available)
            if (this.dg1Data || this.dg2Data) {
              this.parseDg1AndDg2();
            } else {
              this.steps.dgParsing.status = 'success';
              this.steps.dgParsing.message = '⚠ DG1/DG2 파일이 업로드되지 않음 - 생략됨';
            }

            this.currentStep = 8;
          },

          async parseDg1AndDg2() {
            this.steps.dgParsing.status = 'running';
            this.steps.dgParsing.message = 'DG1/DG2 데이터 파싱 중...';

            try {
              let successCount = 0;

              // Parse DG1 (MRZ)
              if (this.dg1Data) {
                const dg1Base64 = this.arrayBufferToBase64(this.dg1Data);
                const dg1Response = await fetch('/api/pa/parse-dg1', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ dg1Base64 })
                });

                if (dg1Response.ok) {
                  this.steps.dgParsing.dg1Data = await dg1Response.json();
                  console.log('[DEBUG] DG1 parsed:', this.steps.dgParsing.dg1Data);
                  successCount++;
                }
              }

              // Parse DG2 (Face Image)
              if (this.dg2Data) {
                const dg2Base64 = this.arrayBufferToBase64(this.dg2Data);
                const dg2Response = await fetch('/api/pa/parse-dg2', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ dg2Base64 })
                });

                if (dg2Response.ok) {
                  this.steps.dgParsing.dg2Data = await dg2Response.json();
                  console.log('[DEBUG] DG2 parsed:', this.steps.dgParsing.dg2Data);
                  successCount++;
                }
              }

              this.steps.dgParsing.status = 'success';
              this.steps.dgParsing.message = `✓ ${successCount}개 Data Group 파싱 완료`;
            } catch (error) {
              console.error('DG parsing error:', error);
              this.steps.dgParsing.status = 'error';
              this.steps.dgParsing.message = '✗ Data Group 파싱 실패: ' + error.message;
            }
          },

          markAllStepsError() {
            Object.keys(this.steps).forEach(key => {
              if (this.steps[key].status === 'pending') {
                this.steps[key].status = 'error';
                this.steps[key].message = '검증 중단됨';
              }
            });
          },

          getStepClass(step) {
            switch (step.status) {
              case 'pending': return 'bg-base-300 text-base-content';
              case 'running': return 'bg-info text-info-content';
              case 'success': return 'bg-success text-success-content';
              case 'error': return 'bg-error text-error-content';
              case 'warning': return 'bg-warning text-warning-content';
              default: return 'bg-base-300 text-base-content';
            }
          },

          clearAllData() {
            this.selectedTestData = '';
            this.sodFile = null;
            this.dg1File = null;
            this.dg2File = null;
            this.sodData = null;
            this.dg1Data = null;
            this.dg2Data = null;
            this.sodInfo = null;
            this.uploadedFiles = [];
            this.dgFiles = [];
            // Clear MRZ data
            this.mrzFile = null;
            this.mrzText = null;
            this.mrzParsedData = null;
            this.verificationResult = null;
            this.resetSteps();
            this.currentStep = 0;
            this.errorMessage = null;
            this.successMessage = null;
          },

          // MRZ file upload handler
          async handleMrzFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
              this.mrzFile = file;
              this.mrzText = await file.text();
              console.log('[DEBUG] MRZ text loaded:', this.mrzText.length, 'characters');

              // Parse MRZ text via API
              const response = await fetch('/api/pa/parse-mrz-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mrzText: this.mrzText })
              });

              if (response.ok) {
                this.mrzParsedData = await response.json();
                console.log('[DEBUG] MRZ parsed successfully:', this.mrzParsedData);
                this.successMessage = 'MRZ 파일이 파싱되었습니다.';
                setTimeout(() => this.successMessage = null, 3000);
              } else {
                const error = await response.json();
                console.error('[DEBUG] MRZ parse error:', error);
                this.errorMessage = `MRZ 파싱 실패: ${error.error || 'Unknown error'}`;
                this.mrzParsedData = null;
              }
            } catch (error) {
              console.error('[DEBUG] MRZ file read error:', error);
              this.errorMessage = `MRZ 파일 읽기 실패: ${error.message}`;
              this.mrzFile = null;
              this.mrzText = null;
              this.mrzParsedData = null;
            }
          },

          // Clear MRZ file
          clearMrzFile() {
            this.mrzFile = null;
            this.mrzText = null;
            this.mrzParsedData = null;
          },

          // Utility functions
          async calculateSha256(arrayBuffer) {
            const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
          },

          getDgDescription(dgNumber) {
            const descriptions = {
              'DG1': 'Machine Readable Zone (MRZ)',
              'DG2': 'Face Biometric Image',
              'DG3': 'Fingerprints',
              'DG4': 'Iris Data',
              'DG5': 'Displayed Portrait',
              'DG6': 'Reserved',
              'DG7': 'Displayed Signature',
              'DG8': 'Data Features',
              'DG9': 'Structure Features',
              'DG10': 'Substance Features',
              'DG11': 'Additional Personal Details',
              'DG12': 'Additional Document Details',
              'DG13': 'Optional Details',
              'DG14': 'Security Options (EAC)',
              'DG15': 'Active Authentication Public Key',
              'DG16': 'Person(s) to Notify'
            };
            return descriptions[dgNumber] || 'Unknown Data Group';
          },

          arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            // Correct method: Use Array.from().map() to avoid UTF-16 encoding issues
            // This prevents corruption of binary data with bytes >= 128
            const binary = Array.from(bytes)
              .map(byte => String.fromCharCode(byte))
              .join('');
            return btoa(binary);
          },

          base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
          },

          formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
          },

          formatTimestamp(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
          }
        };
      }
      </script>
    </th:block>
  </body>
</html>
