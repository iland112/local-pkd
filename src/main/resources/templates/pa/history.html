<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout/base :: layout(~{::content})}"
>
  <body>
    <th:block th:fragment="content">
      <div
        class="w-full px-4 lg:px-6 py-4"
        x-data="paHistoryPageState()"
        @alpine:init="init()"
      >
        <!-- Page Header -->
        <div class="mb-6">
          <h1 class="text-2xl font-bold text-base-content mb-1 flex items-center gap-2">
            <!-- Heroicon: clock -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-primary">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            Passive Authentication 검증 이력
          </h1>
          <p class="text-base-content opacity-70 text-sm">
            전자여권 검증 이력을 조회하고 필터링할 수 있습니다.
          </p>
        </div>

        <!-- Filters Card -->
        <div class="card bg-base-100 shadow-xl border mb-4" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
          <div class="card-body p-5">
            <h2 class="card-title text-lg mb-3 flex items-center gap-2">
              <!-- Heroicon: funnel -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-info">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" />
              </svg>
              검색 필터
            </h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <!-- Country Filter -->
              <div class="form-control">
                <label class="label py-1">
                  <span class="label-text font-semibold text-sm">발급 국가</span>
                </label>
                <select
                  x-model="filters.country"
                  @change="applyFilters()"
                  class="select select-bordered h-9 min-h-0 text-sm w-full"
                >
                  <option value="">전체</option>
                  <option value="KR">대한민국 (KR)</option>
                  <option value="US">미국 (US)</option>
                  <option value="JP">일본 (JP)</option>
                  <option value="CN">중국 (CN)</option>
                  <option value="GB">영국 (GB)</option>
                </select>
              </div>

              <!-- Status Filter -->
              <div class="form-control">
                <label class="label py-1">
                  <span class="label-text font-semibold text-sm">검증 결과</span>
                </label>
                <select
                  x-model="filters.status"
                  @change="applyFilters()"
                  class="select select-bordered h-9 min-h-0 text-sm w-full"
                >
                  <option value="">전체</option>
                  <option value="VALID">Valid</option>
                  <option value="INVALID">Invalid</option>
                  <option value="ERROR">Error</option>
                </select>
              </div>

              <!-- Date Range From -->
              <div class="form-control">
                <label class="label py-1">
                  <span class="label-text font-semibold text-sm">시작 날짜</span>
                </label>
                <input
                  type="date"
                  x-model="filters.dateFrom"
                  @change="applyFilters()"
                  class="input input-bordered h-9 min-h-0 text-sm w-full"
                />
              </div>

              <!-- Date Range To -->
              <div class="form-control">
                <label class="label py-1">
                  <span class="label-text font-semibold text-sm">종료 날짜</span>
                </label>
                <input
                  type="date"
                  x-model="filters.dateTo"
                  @change="applyFilters()"
                  class="input input-bordered h-9 min-h-0 text-sm w-full"
                />
              </div>
            </div>

            <!-- Filter Actions -->
            <div class="flex justify-end gap-2 mt-3">
              <button
                @click="clearFilters()"
                class="btn btn-ghost btn-sm"
              >
                <!-- Heroicon: arrow-path -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                초기화
              </button>
              <button
                @click="applyFilters()"
                class="btn btn-primary btn-sm"
              >
                <!-- Heroicon: magnifying-glass -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>
                검색
              </button>
            </div>
          </div>
        </div>

        <!-- Statistics Summary -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <div class="stat bg-base-100 shadow-xl border rounded-lg p-3" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
            <div class="stat-figure text-primary">
              <!-- Heroicon: document-text -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
              </svg>
            </div>
            <div class="stat-title text-xs">총 검증 건수</div>
            <div class="stat-value text-xl text-primary" x-text="statistics.total"></div>
          </div>

          <div class="stat bg-base-100 shadow-xl border rounded-lg p-3" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
            <div class="stat-figure text-success">
              <!-- Heroicon: check-circle -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
            </div>
            <div class="stat-title text-xs">Valid</div>
            <div class="stat-value text-xl text-success" x-text="statistics.valid"></div>
            <div class="stat-desc text-xs" x-text="statistics.validPercent + '%'"></div>
          </div>

          <div class="stat bg-base-100 shadow-xl border rounded-lg p-3" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
            <div class="stat-figure text-error">
              <!-- Heroicon: x-circle -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
            </div>
            <div class="stat-title text-xs">Invalid</div>
            <div class="stat-value text-xl text-error" x-text="statistics.invalid"></div>
            <div class="stat-desc text-xs" x-text="statistics.invalidPercent + '%'"></div>
          </div>

          <div class="stat bg-base-100 shadow-xl border rounded-lg p-3" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
            <div class="stat-figure text-warning">
              <!-- Heroicon: exclamation-triangle -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              </svg>
            </div>
            <div class="stat-title text-xs">Error</div>
            <div class="stat-value text-xl text-warning" x-text="statistics.error"></div>
            <div class="stat-desc text-xs" x-text="statistics.errorPercent + '%'"></div>
          </div>
        </div>

        <!-- History Table -->
        <div class="card bg-base-100 shadow-xl border" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
          <div class="card-body p-5">
            <h2 class="card-title text-lg mb-3 flex items-center gap-2">
              <!-- Heroicon: table-cells -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
              </svg>
              검증 이력
              <span class="badge badge-sm" x-text="totalRecords + '건'"></span>
            </h2>

            <!-- Loading State -->
            <div x-show="loading" class="flex justify-center items-center py-16">
              <span class="loading loading-spinner loading-lg text-primary"></span>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && records.length === 0" class="flex flex-col items-center justify-center py-16 text-center">
              <!-- Heroicon: inbox -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-base-content opacity-30 mb-3">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z" />
              </svg>
              <p class="text-lg font-semibold text-base-content opacity-70">검증 이력이 없습니다</p>
              <p class="text-sm text-base-content opacity-50 mt-1">첫 번째 PA 검증을 수행해보세요!</p>
              <a href="/pa/verify" class="btn btn-primary btn-sm mt-4">
                <!-- Heroicon: plus-circle -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                검증 수행하기
              </a>
            </div>

            <!-- Table -->
            <div x-show="!loading && records.length > 0" class="overflow-x-auto">
              <table class="table table-zebra table-sm w-full">
                <thead>
                  <tr>
                    <th>검증 ID</th>
                    <th>발급 국가</th>
                    <th>여권 번호</th>
                    <th>검증 결과</th>
                    <th>검증 시각</th>
                    <th>요청자</th>
                    <th>상세</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="record in records" :key="record.verificationId">
                    <tr>
                      <!-- Verification ID -->
                      <td>
                        <span class="font-mono text-xs" x-text="record.verificationId.substring(0, 8) + '...'"></span>
                      </td>

                      <!-- Country -->
                      <td>
                        <div class="flex items-center gap-2">
                          <img :src="'/svg/' + record.issuingCountry.toLowerCase() + '.svg'"
                               :alt="record.issuingCountry"
                               class="w-5 h-4 object-cover rounded-sm shadow-sm border border-base-300"
                               onerror="this.style.display='none'"/>
                          <span x-text="record.issuingCountry"></span>
                        </div>
                      </td>

                      <!-- Document Number -->
                      <td>
                        <span class="font-mono text-xs" x-text="record.documentNumber"></span>
                      </td>

                      <!-- Status -->
                      <td>
                        <span
                          class="badge badge-xs"
                          :class="{
                            'badge-success': record.status === 'VALID',
                            'badge-error': record.status === 'INVALID',
                            'badge-warning': record.status === 'ERROR'
                          }"
                          x-text="record.status"
                        ></span>
                      </td>

                      <!-- Verified At -->
                      <td>
                        <span class="text-xs" x-text="formatTimestamp(record.verificationTimestamp)"></span>
                      </td>

                      <!-- Requested By -->
                      <td>
                        <span class="text-xs" x-text="record.requestedBy || 'anonymous'"></span>
                      </td>

                      <!-- Actions -->
                      <td>
                        <button
                          @click="viewDetails(record)"
                          class="btn btn-ghost btn-xs"
                        >
                          <!-- Heroicon: eye -->
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                          </svg>
                          보기
                        </button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div x-show="!loading && records.length > 0" class="flex justify-center mt-4">
              <div class="join">
                <button
                  class="join-item btn btn-sm"
                  @click="goToPage(currentPage - 1)"
                  :disabled="currentPage === 0"
                >
                  <!-- Heroicon: chevron-left -->
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                  </svg>
                </button>

                <template x-for="page in visiblePages" :key="page">
                  <button
                    class="join-item btn btn-sm"
                    :class="page === currentPage ? 'btn-primary' : ''"
                    @click="goToPage(page)"
                    x-text="page + 1"
                  ></button>
                </template>

                <button
                  class="join-item btn btn-sm"
                  @click="goToPage(currentPage + 1)"
                  :disabled="currentPage >= totalPages - 1"
                >
                  <!-- Heroicon: chevron-right -->
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Details Modal -->
        <dialog x-ref="detailsModal" class="modal">
          <div class="modal-box max-w-4xl">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-bold text-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-info">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                </svg>
                검증 상세 정보
              </h3>
              <!-- Status Badge -->
              <span
                class="badge badge-lg gap-1"
                :class="{
                  'badge-success': selectedRecord?.status === 'VALID',
                  'badge-error': selectedRecord?.status === 'INVALID',
                  'badge-warning': selectedRecord?.status === 'ERROR'
                }"
              >
                <template x-if="selectedRecord?.status === 'VALID'">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                </template>
                <template x-if="selectedRecord?.status === 'INVALID'">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                </template>
                <template x-if="selectedRecord?.status === 'ERROR'">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>
                </template>
                <span x-text="selectedRecord?.status"></span>
              </span>
            </div>

            <div x-show="selectedRecord" class="space-y-6">
              <!-- Basic Info Grid -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 검증 ID & 시각 (Full Width) -->
                <div class="md:col-span-3 bg-base-200 rounded-lg p-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-1">검증 ID</p>
                      <p class="font-mono text-sm break-all" x-text="selectedRecord?.verificationId"></p>
                    </div>
                    <div>
                      <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-1">검증 시각</p>
                      <p class="text-sm" x-text="formatTimestamp(selectedRecord?.verificationTimestamp)"></p>
                    </div>
                  </div>
                </div>

                <!-- 발급 국가 -->
                <div class="bg-base-200 rounded-lg p-4">
                  <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-1">발급 국가</p>
                  <div class="flex items-center gap-3">
                    <img :src="'/svg/' + (selectedRecord?.issuingCountry?.toLowerCase() || 'xx') + '.svg'"
                         :alt="selectedRecord?.issuingCountry"
                         class="w-8 h-6 object-cover rounded shadow-sm border border-base-300"
                         onerror="this.style.display='none'"/>
                    <span class="text-lg font-medium" x-text="selectedRecord?.issuingCountry"></span>
                  </div>
                </div>

                <!-- 여권 번호 -->
                <div class="bg-base-200 rounded-lg p-4">
                  <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-1">여권 번호</p>
                  <p class="font-mono text-lg font-medium" x-text="selectedRecord?.documentNumber || '-'"></p>
                </div>

                <!-- 요청자 -->
                <div class="bg-base-200 rounded-lg p-4">
                  <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-1">요청자</p>
                  <p class="text-lg font-medium" x-text="selectedRecord?.requestedBy || 'anonymous'"></p>
                </div>
              </div>

              <!-- DG1/DG2 Data Display (VALID records only) -->
              <div x-show="selectedRecord?.status === 'VALID'">
                <div class="divider text-sm font-semibold">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Zm6-10.125a1.875 1.875 0 1 1-3.75 0 1.875 1.875 0 0 1 3.75 0Zm1.294 6.336a6.721 6.721 0 0 1-3.17.789 6.721 6.721 0 0 1-3.168-.789 3.376 3.376 0 0 1 6.338 0Z" />
                  </svg>
                  여권 데이터
                </div>

                <!-- Loading indicator for DG data -->
                <div x-show="dgLoading" class="flex justify-center py-8">
                  <span class="loading loading-spinner loading-md"></span>
                  <span class="ml-3 text-sm">데이터 로딩 중...</span>
                </div>

                <!-- Error message for DG data -->
                <div x-show="dgError && !dgLoading" class="alert alert-warning py-3">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                  </svg>
                  <span class="text-sm" x-text="dgError"></span>
                </div>

                <!-- DG2 (Face Image) + DG1 (MRZ) - Grid Layout -->
                <div x-show="!dgLoading && !dgError && (dgData?.hasDg1 || dgData?.hasDg2)" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <!-- DG2 Face Image (1 column) -->
                  <div x-show="dgData?.hasDg2 && dgData?.dg2?.faceImages?.[0]?.imageDataUrl" class="md:col-span-1">
                    <div class="bg-base-200 rounded-lg p-3 h-full">
                      <div class="flex items-center gap-2 mb-2">
                        <div class="w-2 h-2 rounded-full bg-accent"></div>
                        <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider">DG2</p>
                      </div>
                      <div class="flex flex-col items-center">
                        <img :src="dgData?.dg2?.faceImages?.[0]?.imageDataUrl"
                             alt="Passport Face Image"
                             class="w-full max-w-[140px] aspect-[3/4] object-cover rounded-lg shadow-md border-2 border-accent/20"/>
                        <span class="badge badge-xs badge-accent mt-1.5" x-text="dgData?.dg2?.faceImages?.[0]?.imageFormat || 'N/A'"></span>
                      </div>
                    </div>
                  </div>

                  <!-- DG1 MRZ Data (3 columns) -->
                  <div x-show="dgData?.hasDg1 && dgData?.dg1" class="md:col-span-3">
                    <div class="bg-base-200 rounded-lg p-4 h-full">
                      <div class="flex items-center gap-2 mb-3">
                        <div class="w-2 h-2 rounded-full bg-primary"></div>
                        <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider">DG1 - MRZ 데이터</p>
                      </div>
                      <!-- MRZ Grid Layout -->
                      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <div class="bg-base-100 rounded-md p-3">
                          <p class="text-xs text-base-content/50 mb-1">성 (Surname)</p>
                          <p class="font-mono font-medium" x-text="dgData?.dg1?.surname || '-'"></p>
                        </div>
                        <div class="bg-base-100 rounded-md p-3 md:col-span-2">
                          <p class="text-xs text-base-content/50 mb-1">이름 (Given Names)</p>
                          <p class="font-mono font-medium" x-text="dgData?.dg1?.givenNames || '-'"></p>
                        </div>
                        <div class="bg-base-100 rounded-md p-3">
                          <p class="text-xs text-base-content/50 mb-1">여권번호</p>
                          <p class="font-mono font-medium text-primary" x-text="dgData?.dg1?.documentNumber || '-'"></p>
                        </div>
                        <div class="bg-base-100 rounded-md p-3">
                          <p class="text-xs text-base-content/50 mb-1">국적</p>
                          <div class="flex items-center gap-2">
                            <img :src="'/svg/' + (dgData?.dg1?.nationality?.toLowerCase() || 'xx') + '.svg'"
                                 :alt="dgData?.dg1?.nationality"
                                 class="w-6 h-4 object-cover rounded-sm shadow-sm border border-base-300"
                                 onerror="this.style.display='none'"/>
                            <span class="font-mono font-medium" x-text="dgData?.dg1?.nationality || '-'"></span>
                          </div>
                        </div>
                        <div class="bg-base-100 rounded-md p-3">
                          <p class="text-xs text-base-content/50 mb-1">성별</p>
                          <p class="font-mono font-medium" x-text="dgData?.dg1?.sex === 'M' ? '남성 (M)' : dgData?.dg1?.sex === 'F' ? '여성 (F)' : dgData?.dg1?.sex || '-'"></p>
                        </div>
                        <div class="bg-base-100 rounded-md p-3">
                          <p class="text-xs text-base-content/50 mb-1">생년월일</p>
                          <p class="font-mono font-medium" x-text="dgData?.dg1?.dateOfBirth || '-'"></p>
                        </div>
                        <div class="bg-base-100 rounded-md p-3 md:col-span-2">
                          <p class="text-xs text-base-content/50 mb-1">만료일</p>
                          <p class="font-mono font-medium text-warning" x-text="dgData?.dg1?.expirationDate || '-'"></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- No DG data available message -->
                <div x-show="!dgLoading && !dgError && !dgData?.hasDg1 && !dgData?.hasDg2" class="text-center py-8">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mx-auto text-base-content/30 mb-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z" />
                  </svg>
                  <p class="text-sm text-base-content/60">저장된 DG 데이터가 없습니다.</p>
                </div>
              </div>

              <!-- Verification Details -->
              <div x-show="selectedRecord?.details">
                <div class="divider text-sm font-semibold">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" />
                  </svg>
                  검증 상세
                </div>
                <div class="bg-base-200 p-4 rounded-lg">
                  <pre class="text-xs overflow-x-auto whitespace-pre-wrap" x-text="JSON.stringify(selectedRecord?.details, null, 2)"></pre>
                </div>
              </div>

              <!-- Error Details -->
              <div x-show="selectedRecord?.errorDetails" class="alert alert-error">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                </svg>
                <div>
                  <h4 class="font-bold text-sm">오류 상세</h4>
                  <p class="text-sm" x-text="selectedRecord?.errorDetails"></p>
                </div>
              </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-action mt-6 pt-4 border-t border-base-300">
              <button @click="closeDetailsModal()" class="btn btn-ghost">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
                닫기
              </button>
            </div>
          </div>
          <form method="dialog" class="modal-backdrop">
            <button>close</button>
          </form>
        </dialog>
      </div>
    </div>

    <!-- Alpine.js Component Script -->
    <script>
        function paHistoryPageState() {
        return {
          // Data
          records: [],
          selectedRecord: null,

          // DG Data for detail modal
          dgData: null,
          dgLoading: false,
          dgError: null,

          // Pagination
          currentPage: 0,
          pageSize: 20,
          totalRecords: 0,
          totalPages: 0,

          // Filters
          filters: {
            country: '',
            status: '',
            dateFrom: '',
            dateTo: ''
          },

          // Statistics
          statistics: {
            total: 0,
            valid: 0,
            invalid: 0,
            error: 0,
            validPercent: 0,
            invalidPercent: 0,
            errorPercent: 0
          },

          // UI State
          loading: false,

          async init() {
            console.log('PA History Page initialized');
            await this.loadHistory();
            this.calculateStatistics();
          },

          async loadHistory() {
            this.loading = true;

            try {
              // Build query params
              const params = new URLSearchParams({
                page: this.currentPage,
                size: this.pageSize,
                sort: 'completedAt,desc'
              });

              if (this.filters.country) params.append('issuingCountry', this.filters.country);
              if (this.filters.status) params.append('status', this.filters.status);

              const response = await fetch(`/api/pa/history?${params.toString()}`);

              if (!response.ok) {
                throw new Error('Failed to load history');
              }

              const data = await response.json();

              this.records = data.content || [];
              this.totalRecords = data.totalElements || 0;
              this.totalPages = data.totalPages || 0;
              this.currentPage = data.number || 0;

              console.log(`Loaded ${this.records.length} records`);

            } catch (error) {
              console.error('Failed to load history:', error);
              this.records = [];
            } finally {
              this.loading = false;
            }
          },

          async applyFilters() {
            this.currentPage = 0;
            await this.loadHistory();
            this.calculateStatistics();
          },

          clearFilters() {
            this.filters = {
              country: '',
              status: '',
              dateFrom: '',
              dateTo: ''
            };
            this.applyFilters();
          },

          async goToPage(page) {
            if (page < 0 || page >= this.totalPages) return;
            this.currentPage = page;
            await this.loadHistory();
          },

          get visiblePages() {
            const maxVisible = 5;
            const pages = [];
            let start = Math.max(0, this.currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(this.totalPages, start + maxVisible);

            if (end - start < maxVisible) {
              start = Math.max(0, end - maxVisible);
            }

            for (let i = start; i < end; i++) {
              pages.push(i);
            }

            return pages;
          },

          calculateStatistics() {
            // This would ideally come from the API
            // For now, calculate from loaded records
            this.statistics.total = this.totalRecords;
            this.statistics.valid = this.records.filter(r => r.status === 'VALID').length;
            this.statistics.invalid = this.records.filter(r => r.status === 'INVALID').length;
            this.statistics.error = this.records.filter(r => r.status === 'ERROR').length;

            if (this.statistics.total > 0) {
              this.statistics.validPercent = Math.round((this.statistics.valid / this.statistics.total) * 100);
              this.statistics.invalidPercent = Math.round((this.statistics.invalid / this.statistics.total) * 100);
              this.statistics.errorPercent = Math.round((this.statistics.error / this.statistics.total) * 100);
            }
          },

          async viewDetails(record) {
            this.selectedRecord = record;
            this.dgData = null;
            this.dgError = null;
            this.$refs.detailsModal.showModal();

            // Load DG data for VALID records
            if (record.status === 'VALID' && record.verificationId) {
              await this.loadDgData(record.verificationId);
            }
          },

          async loadDgData(verificationId) {
            this.dgLoading = true;
            this.dgError = null;

            try {
              const response = await fetch(`/api/pa/${verificationId}/datagroups`);

              if (!response.ok) {
                throw new Error('Failed to load DG data');
              }

              this.dgData = await response.json();
              console.log('DG data loaded:', this.dgData);

            } catch (error) {
              console.error('Failed to load DG data:', error);
              this.dgError = 'DG 데이터를 불러올 수 없습니다: ' + error.message;
            } finally {
              this.dgLoading = false;
            }
          },

          closeDetailsModal() {
            this.$refs.detailsModal.close();
            this.selectedRecord = null;
            this.dgData = null;
            this.dgError = null;
          },

          formatTimestamp(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
          }
        };
      }
    </script>
    </th:block>
  </body>
</html>
