<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout/base :: layout(~{::content})}"
>
  <body>
    <th:block th:fragment="content">
      <div
        class="w-full px-4 lg:px-6 py-4"
        x-data="uploadPageState()"
        @alpine:init="init()"
        @beforeunload.window="destroySseConnection()"
      >

        <!-- Success Alert -->
        <div th:if="${success}" class="alert alert-success mb-4 shadow-lg" x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 5000)">
          <!-- Heroicon: check-circle -->
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          <span th:text="${success}">Success message</span>
          <button @click="show = false" class="btn btn-sm btn-ghost">✕</button>
        </div>

        <!-- Error Alert -->
        <div th:if="${error}" class="alert alert-error mb-4 shadow-lg" x-data="{ show: true }" x-show="show">
          <!-- Heroicon: x-circle -->
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          <span th:text="${error}">Error message</span>
          <button @click="show = false" class="btn btn-sm btn-ghost">✕</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 items-stretch">
          <!-- Left Column: Upload Form -->
          <div id="uploadFunctionCard" class="col-span-1 lg:col-span-3">
            <div class="card bg-base-100 shadow-xl h-full border" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
              <div class="card-body flex flex-col p-5">
                <h2 class="card-title text-xl flex items-center gap-2">
                  <!-- Heroicon: cloud-arrow-up -->
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" />
                  </svg>
                  <span>파일 업로드</span>
                </h2>
                <p class="text-sm text-base-content opacity-70 mb-3">
                  LDIF, Master List 파일을 처리 서버에 업로드합니다.
                </p>

                <!-- Processing Mode Selector Fragment -->
                <div class="mb-4 pb-4 border-b" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-base-300'">
                  <th:block th:replace="~{fragments/processing-mode-selector :: mode-selector(selected='AUTO')}" />
                </div>

                <!-- Upload Form -->
                <form id="uploadForm" @submit.prevent="handleUpload()" class="flex flex-col flex-grow">
                  <!-- Drag and Drop File Input -->
                  <div
                    class="form-control w-full flex-grow"
                    @dragover.prevent="isDragging = true"
                    @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleFileDrop($event)"
                  >
                    <label class="label py-1">
                      <span class="label-text font-semibold flex items-center gap-1">
                        <!-- Heroicon: arrow-up-tray -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-primary">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                        </svg>
                        파일 선택
                      </span>
                    </label>
                    <div
                      x-ref="dropzone"
                      class="relative border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-colors duration-300"
                      :class="{
                        'border-primary bg-primary bg-opacity-10': isDragging,
                        'border-base-300 hover:border-primary hover:bg-base-200': !isDragging && !selectedFile,
                        'border-info bg-info bg-opacity-30': selectedFile
                      }"
                      @click="$refs.fileInput.click()"
                    >
                      <input
                        id="fileInput"
                        x-ref="fileInput"
                        type="file"
                        name="file"
                        :accept="fileAccept"
                        class="hidden"
                        required
                        @change="handleFileSelection($event)"
                      />
                      <div class="flex flex-col items-center justify-center space-y-2">
                        <!-- Heroicon: cloud-arrow-up -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12" :class="selectedFile ? 'text-info-content' : 'text-base-content opacity-50'">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" />
                        </svg>
                        <p x-show="!selectedFile" class="text-base-content opacity-70">
                          파일을 여기로 드래그하거나 클릭하여 선택하세요.
                        </p>
                        <p x-show="selectedFile" class="font-semibold text-base-content" x-text="fileInfo"></p>
                        <p class="text-xs text-base-content opacity-50">
                          (LDIF, ML 파일 지원 / 최대 100MB)
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- File Type Warning -->
                  <div x-show="!isValidFileType" class="alert alert-warning mt-3">
                    <!-- Heroicon: exclamation-triangle -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>
                    <span>지원하지 않는 파일 형식입니다. LDIF 또는 ML 파일을 선택해주세요.</span>
                  </div>

                  <!-- Hidden Fields -->
                  <input type="hidden" name="forceUpload" value="false" />
                  <input type="hidden" name="processingMode" x-model="processingMode" />

                  <!-- Action Buttons -->
                  <div class="card-actions justify-end mt-4">
                    <button type="button" onclick="window.location.href='/upload-history'" class="btn btn-outline btn-sm gap-2">
                      <!-- Heroicon: clock -->
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                      </svg>
                      업로드 이력
                    </button>
                    <button type="submit" id="uploadBtn" class="btn btn-primary btn-sm gap-2" :disabled="isProcessing || !selectedFile || !isValidFileType">
                      <span x-show="isProcessing" class="loading loading-spinner loading-sm"></span>
                      <!-- Heroicon: arrow-up-tray -->
                      <svg x-show="!isProcessing" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                      </svg>
                      업로드
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Right Column: Progress & Results -->
          <div class="col-span-1 lg:col-span-2">
            <!-- Upload Process Card -->
            <div id="uploadProcessCard"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform -translate-y-2"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
            >
              <div class="card bg-base-100 shadow-xl h-full border" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
                <div class="card-body flex flex-col p-5">
                  <h3 class="card-title text-lg mb-3 flex flex-col items-start">
                    <div class="flex items-center gap-2">
                      <!-- Heroicon: queue-list -->
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-info">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" />
                      </svg>
                      <span>처리 진행 상황</span>
                    </div>
                    <span x-show="fileName" class="font-mono text-xs ml-7 opacity-70"> 파일명:(<span x-text="fileName"></span>)</span>
                  </h3>

                  <!-- Stage Progress Steps -->
                  <ul class="steps steps-vertical w-full flex-grow">
                    <li class="step mb-3" :class="{
                          'step-primary': uploadStage.status === 'IN_PROGRESS',
                          'step-success': uploadStage.status === 'COMPLETED',
                          'step-error': uploadStage.status === 'FAILED'
                        }">
                      <div class="flex flex-col items-start text-left w-full">
                        <div class="step-title text-sm font-medium">파일 업로드</div>
                        <div class="text-xs opacity-70 whitespace-normal w-full overflow-hidden text-ellipsis" x-text="uploadStage.message"></div>
                        <progress class="progress progress-primary w-full h-1.5" :value="uploadStage.percentage" max="100" x-show="uploadStage.percentage > 0"></progress>
                        <div class="text-xs font-mono w-full" x-show="uploadStage.percentage > 0" x-text="uploadStage.percentage + '%'"></div>
                      </div>
                    </li>
                    <li class="step mb-3" :class="{
                          'step-primary': parseStage.status === 'IN_PROGRESS',
                          'step-success': parseStage.status === 'COMPLETED',
                          'step-error': parseStage.status === 'FAILED'
                        }">
                      <div class="flex flex-col items-start text-left w-full">
                        <div class="step-title text-sm font-medium">파일 파싱</div>
                        <div class="text-xs opacity-70 whitespace-normal w-full overflow-hidden text-ellipsis" x-text="parseStage.message"></div>
                        <progress class="progress progress-primary w-full h-1.5" :value="parseStage.percentage" max="100" x-show="parseStage.percentage > 0"></progress>
                        <div class="text-xs font-mono w-full" x-show="parseStage.percentage > 0" x-text="parseStage.percentage + '%'"></div>
                        <template x-if="parseStage.details">
                          <div class="text-xs mt-1 p-2 bg-base-200 rounded w-full" x-html="parseStage.details"></div>
                        </template>
                      </div>
                    </li>
                    <!-- Step 3: 인증서 검증 + DB 저장 -->
                    <li class="step mb-3" :class="{
                          'step-primary': validateStage.status === 'IN_PROGRESS' || dbSaveStage.status === 'IN_PROGRESS',
                          'step-success': dbSaveStage.status === 'COMPLETED',
                          'step-error': validateStage.status === 'FAILED' || dbSaveStage.status === 'FAILED'
                        }">
                      <div class="flex flex-col items-start text-left w-full">
                        <div class="step-title text-sm font-medium">검증 + DB 저장</div>
                        <div class="text-xs opacity-70 whitespace-normal w-full overflow-hidden text-ellipsis" x-text="getValidateDbStageMessage()"></div>
                        <progress class="progress progress-primary w-full h-1.5" :value="getValidateDbStagePercentage()" max="100" x-show="getValidateDbStagePercentage() > 0"></progress>
                        <div class="text-xs font-mono w-full" x-show="getValidateDbStagePercentage() > 0" x-text="getValidateDbStagePercentage() + '%'"></div>
                        <template x-if="validateStage.details || dbSaveStage.details">
                          <div class="text-xs mt-1 p-2 bg-base-200 rounded w-full">
                            <div x-show="validateStage.details" class="mb-1">
                              <span class="font-semibold text-warning">검증:</span> <span x-html="validateStage.details"></span>
                            </div>
                            <div x-show="dbSaveStage.details">
                              <span class="font-semibold text-info">DB:</span> <span x-html="dbSaveStage.details"></span>
                            </div>
                          </div>
                        </template>
                      </div>
                    </li>
                    <!-- Step 4: LDAP 저장 -->
                    <li class="step" :class="{
                          'step-primary': ldapStage.status === 'IN_PROGRESS',
                          'step-success': ldapStage.status === 'COMPLETED',
                          'step-error': ldapStage.status === 'FAILED'
                        }">
                      <div class="flex flex-col items-start text-left w-full">
                        <div class="step-title text-sm font-medium">LDAP 저장</div>
                        <div class="text-xs opacity-70 whitespace-normal w-full overflow-hidden text-ellipsis" x-text="ldapStage.message"></div>
                        <progress class="progress progress-primary w-full h-1.5" :value="ldapStage.percentage" max="100" x-show="ldapStage.percentage > 0"></progress>
                        <div class="text-xs font-mono w-full" x-show="ldapStage.percentage > 0" x-text="ldapStage.percentage + '%'"></div>
                        <template x-if="ldapStage.details">
                          <div class="text-xs mt-1 p-2 bg-base-200 rounded w-full" x-html="ldapStage.details"></div>
                        </template>
                      </div>
                    </li>
                  </ul>

                  <!-- Manual Mode Control Panel -->
                  <div x-show="processingMode === 'MANUAL' && uploadId && overallStatus !== 'FINALIZED' && overallStatus !== 'FAILED'" class="mt-4 border-t pt-3" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-base-300'">
                    <h4 class="font-bold text-sm mb-2">수동 처리 제어</h4>
                    <p class="text-xs opacity-70 mb-2">각 단계를 순서대로 수동으로 실행합니다</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <!-- 1. Parse Button -->
                        <button
                            :disabled="parsingCompleted || parsingInProgress"
                            @click="triggerParse()"
                            class="btn btn-sm"
                            :class="{
                                'btn-success': parsingCompleted,
                                'btn-primary': !parsingCompleted && !parsingInProgress,
                                'loading': parsingInProgress
                            }">
                            <template x-if="!parsingInProgress">
                              <svg x-show="parsingCompleted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                              </svg>
                              <svg x-show="!parsingCompleted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                              </svg>
                            </template>
                            <span x-text="parsingCompleted ? '파싱 완료' : (parsingInProgress ? '파싱 중...' : '1. 파싱')"></span>
                        </button>

                        <!-- 2. Validate + DB Save Button -->
                        <button
                            :disabled="!parsingCompleted || dbSaveCompleted || validationInProgress || dbSaveInProgress"
                            @click="triggerValidate()"
                            class="btn btn-sm"
                            :class="{
                                'btn-success': dbSaveCompleted,
                                'btn-primary': parsingCompleted && !dbSaveCompleted && !validationInProgress && !dbSaveInProgress,
                                'loading': validationInProgress || dbSaveInProgress
                            }">
                            <template x-if="!validationInProgress && !dbSaveInProgress">
                              <svg x-show="dbSaveCompleted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                              </svg>
                              <svg x-show="!dbSaveCompleted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                              </svg>
                            </template>
                            <span x-text="dbSaveCompleted ? '검증+DB 완료' : ((validationInProgress || dbSaveInProgress) ? '처리 중...' : '2. 검증+DB')"></span>
                        </button>

                        <!-- 3. LDAP Save Button -->
                        <button
                            :disabled="!dbSaveCompleted || ldapCompleted || ldapInProgress"
                            @click="triggerLdapUpload()"
                            class="btn btn-sm"
                            :class="{
                                'btn-success': ldapCompleted,
                                'btn-primary': dbSaveCompleted && !ldapCompleted && !ldapInProgress,
                                'loading': ldapInProgress
                            }">
                            <template x-if="!ldapInProgress">
                              <svg x-show="ldapCompleted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                              </svg>
                              <svg x-show="!ldapCompleted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                              </svg>
                            </template>
                            <span x-text="ldapCompleted ? 'LDAP 완료' : (ldapInProgress ? 'LDAP 저장 중...' : '3. LDAP 저장')"></span>
                        </button>
                    </div>
                  </div>

                  <!-- Final Status Message -->
                  <div x-show="overallStatus === 'FINALIZED' || overallStatus === 'FAILED'" class="mt-4 alert" :class="{'alert-success': overallStatus === 'FINALIZED', 'alert-error': overallStatus === 'FAILED'}">
                    <!-- Heroicon: check-circle or exclamation-triangle -->
                    <svg x-show="overallStatus === 'FINALIZED'" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <svg x-show="overallStatus === 'FAILED'" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>
                    <span x-text="overallMessage"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Error Card -->
            <div x-show="errorMessages.length > 0" class="mt-4"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
            >
              <div class="card bg-red-100 border border-red-400 text-red-700 shadow-xl">
                  <div class="card-body p-4">
                      <div class="flex justify-between items-center">
                        <h3 class="card-title text-base flex items-center gap-2">
                          <!-- Heroicon: exclamation-triangle -->
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                          </svg>
                          오류 발생
                        </h3>
                        <button @click="errorMessages = []" class="btn btn-sm btn-ghost">✕</button>
                      </div>
                      <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                          <template x-for="(error, index) in errorMessages" :key="index">
                              <li x-text="error"></li>
                          </template>
                      </ul>
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Duplicate Warning Modal -->
      <dialog id="duplicateModal" class="modal">
        <div class="modal-box max-w-2xl border" :class="$store.theme.darkMode ? 'border-gray-700' : 'border-gray-200'">
          <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
          </form>
          <h3 class="font-bold text-lg text-warning mb-4 flex items-center gap-2">
            <!-- Heroicon: exclamation-triangle -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
            중복 파일 경고
          </h3>

          <div class="alert alert-warning mb-4">
            <p id="duplicateMessage"></p>
          </div>

          <div class="overflow-x-auto">
            <table class="table table-sm">
              <tbody>
                <tr>
                  <th>파일명</th>
                  <td id="dupFileName" class="font-mono text-xs">-</td>
                </tr>
                <tr>
                  <th>업로드 ID</th>
                  <td id="dupFileId" class="font-mono text-xs">-</td>
                </tr>
                <tr>
                  <th>업로드 일시</th>
                  <td id="dupUploadDate">-</td>
                </tr>
                <tr>
                  <th>상태</th>
                  <td id="dupStatus">-</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="modal-action">
              <button class="btn btn-outline btn-sm" onclick="document.getElementById('duplicateModal').close()">취소</button>
              <button class="btn btn-info btn-sm gap-2" @click="viewExistingFile()">
                <!-- Heroicon: eye -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
                기존 파일 보기
              </button>
              <button class="btn btn-error btn-sm gap-2" @click="forceUpload()">
                <!-- Heroicon: arrow-path -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                강제 업로드
              </button>
          </div>
        </div>
      </dialog>
    </div>

    <script>
        function uploadPageState() {
          return {
            // Drag & Drop state
            isDragging: false,

            // File state
            fileType: 'unknown',
            fileAccept: '.ldif,.ml',
            isValidFileType: true,
            fileInfo: '',
            selectedFile: null,
            fileName: '',

            // Upload & Processing state
            isProcessing: false,
            existingFileId: null,
            uploadId: null,
            sseEventSource: null,
            processingMode: 'AUTO',

            // SSE reconnection state
            sseReconnectAttempts: 0,
            maxSseReconnectAttempts: 5,
            sseReconnectDelay: 2000,
            sseReconnectTimer: null,

            // Stage-specific progress
            uploadStage: { active: true, message: '파일을 선택하여 업로드를 시작하세요.', percentage: 0, status: 'IDLE', details: '' },
            parseStage: { active: true, message: '업로드 대기 중', percentage: 0, status: 'IDLE', details: '' },
            validateStage: { active: true, message: '업로드 대기 중', percentage: 0, status: 'IDLE', details: '' },
            dbSaveStage: { active: true, message: '검증 대기 중', percentage: 0, status: 'IDLE', details: '' },
            ldapStage: { active: true, message: '검증 대기 중', percentage: 0, status: 'IDLE', details: '' },

            // Overall status
            overallStatus: 'IDLE',
            overallMessage: '',

            // Manual mode completion flags
            parsingCompleted: false,
            validationCompleted: false,
            dbSaveCompleted: false,
            ldapCompleted: false,

            // Manual mode in-progress flags
            parsingInProgress: false,
            validationInProgress: false,
            dbSaveInProgress: false,
            ldapInProgress: false,

            // Error collection
            errorMessages: [],

            // Toast duplicate prevention
            shownNotifications: new Set(),

            init() {
              this.$el.addEventListener('processing-mode-changed', (event) => {
                  this.processingMode = event.detail.mode;
              });
              const savedUploadId = sessionStorage.getItem('currentUploadId');
              if (savedUploadId) {
                  this.uploadId = savedUploadId;
                  this.startSseConnection();
              }
            },

            resetProgressState() {
                this.isProcessing = false;
                this.uploadId = null;
                sessionStorage.removeItem('currentUploadId');
                this.sseReconnectAttempts = 0;
                this.sseReconnectDelay = 2000;
                if (this.sseReconnectTimer) clearTimeout(this.sseReconnectTimer);
                if (this.sseEventSource) this.sseEventSource.close();
                this.uploadStage = { active: true, message: '파일을 선택하여 업로드를 시작하세요.', percentage: 0, status: 'IDLE', details: '' };
                this.parseStage = { active: true, message: '업로드 대기 중', percentage: 0, status: 'IDLE', details: '' };
                this.validateStage = { active: true, message: '업로드 대기 중', percentage: 0, status: 'IDLE', details: '' };
                this.dbSaveStage = { active: true, message: '검증 대기 중', percentage: 0, status: 'IDLE', details: '' };
                this.ldapStage = { active: true, message: '검증 대기 중', percentage: 0, status: 'IDLE', details: '' };
                this.overallStatus = 'IDLE';
                this.overallMessage = '';
                this.parsingCompleted = false;
                this.validationCompleted = false;
                this.dbSaveCompleted = false;
                this.ldapCompleted = false;
                this.parsingInProgress = false;
                this.validationInProgress = false;
                this.dbSaveInProgress = false;
                this.ldapInProgress = false;
                this.errorMessages = [];
                this.shownNotifications = new Set();
                this.fileName = '';
            },

            handleFileDrop(event) {
              this.isDragging = false;
              const files = event.dataTransfer.files;
              if (files.length > 0) {
                this.$refs.fileInput.files = files;
                const changeEvent = new Event('change', { bubbles: true });
                this.$refs.fileInput.dispatchEvent(changeEvent);
              }
            },

            handleFileSelection(event) {
              this.selectedFile = event.target.files[0];
              if (!this.selectedFile) {
                  this.fileInfo = '';
                  this.isValidFileType = true;
                  this.fileName = '';
                  return;
              };
              this.fileInfo = `${this.selectedFile.name} (${formatFileSize(this.selectedFile.size)})`;
              this.fileName = this.selectedFile.name;

              const fileName = this.selectedFile.name.toLowerCase();
              if (fileName.endsWith('.ldif')) {
                this.setFileType('ldif');
              } else if (fileName.endsWith('.ml')) {
                this.setFileType('ml');
              } else {
                this.setFileType('unknown');
              }
            },

            setFileType(type) {
                this.fileType = type;
                this.isValidFileType = type !== 'unknown';
            },

            async handleUpload() {
              if (!this.selectedFile || !this.isValidFileType) {
                showNotification('업로드할 올바른 형식의 파일을 선택해주세요.', 'warning');
                return;
              }
              const MAX_FILE_SIZE = 100 * 1024 * 1024;
              if (this.selectedFile.size > MAX_FILE_SIZE) {
                showNotification('파일 크기는 100MB 이하여야 합니다.', 'error');
                return;
              }
              this.resetProgressState();
              this.uploadStage.active = true;
              try {
                this.updateUploadProgress('파일 업로드 중...', 50, 'IN_PROGRESS');
                await this.submitFormAjax();
              } catch (error) {
                this.isProcessing = false;
                this.handleUploadError(error, '업로드');
              }
            },

            updateUploadProgress(message, percentage, status = 'IN_PROGRESS') {
                this.uploadStage.message = message;
                this.uploadStage.percentage = percentage;
                this.uploadStage.status = status;
            },

            async submitFormAjax() {
              const formData = new FormData(document.querySelector('#uploadForm'));
              const response = await fetch('/file/upload', {
                method: 'POST',
                body: formData
              });
              if (!response.ok) {
                 const error = await response.json();
                 throw new Error(error.message || '서버에서 업로드를 실패했습니다.');
              }
              const result = await response.json();
              this.uploadId = result.uploadId;
              this.updateUploadProgress('업로드 완료', 100, 'COMPLETED');
              if (this.processingMode === 'AUTO') {
                this.startSseConnection();
              } else {
                this.isProcessing = false;
              }
            },

            forceUpload() {
                document.querySelector('input[name="forceUpload"]').value = 'true';
                document.getElementById('duplicateModal').close();
                this.submitFormAjax().catch(error => this.handleUploadError(error, '강제 업로드'));
            },

            handleUploadError(error, context) {
                console.error(`${context} error:`, error);
                this.errorMessages.push(`${context} 중 오류: ${error.message}`);
                this.uploadStage.status = 'FAILED';
                this.uploadStage.message = '실패: ' + error.message;
                this.overallStatus = 'FAILED';
                this.isProcessing = false;
            },

            viewExistingFile() {
                if(this.existingFileId) window.open(`/history/${this.existingFileId}`, '_blank');
            },

            startSseConnection() {
                if (!this.uploadId) return;
                if (this.sseReconnectTimer) clearTimeout(this.sseReconnectTimer);
                if (this.sseEventSource) this.sseEventSource.close();
                this.isProcessing = true;
                sessionStorage.setItem('currentUploadId', this.uploadId);
                console.log(`Starting SSE for ${this.uploadId}`);
                this.sseEventSource = new EventSource(`/progress/stream/${this.uploadId}`);
                this.sseEventSource.addEventListener('connected', e => {
                    console.log('SSE connected:', e.data);
                    this.sseReconnectAttempts = 0;
                });
                this.sseEventSource.addEventListener('heartbeat', () => this.sseReconnectAttempts = 0);
                this.sseEventSource.addEventListener('progress', e => this.handleProgressEvent(e));
                this.sseEventSource.onerror = () => this.handleSseError();
            },

            handleSseError() {
              if (this.sseEventSource) this.sseEventSource.close();
              if (this.sseReconnectAttempts < this.maxSseReconnectAttempts) {
                  this.sseReconnectAttempts++;
                  const delay = 2000 * Math.pow(2, this.sseReconnectAttempts - 1);
                  this.sseReconnectTimer = setTimeout(() => this.startSseConnection(), delay);
              } else {
                  this.errorMessages.push('SSE 연결을 복구할 수 없습니다.');
                  this.overallStatus = 'FAILED';
                  this.isProcessing = false;
              }
            },

            handleProgressEvent(event) {
                const progress = JSON.parse(event.data);
                if (progress.uploadId !== this.uploadId) return;
                this.sseReconnectAttempts = 0;

                const stageMap = {
                    'UPLOAD': this.uploadStage, 'PARSE': this.parseStage,
                    'VALIDATE': this.validateStage, 'DB_SAVE': this.dbSaveStage, 'LDAP_UPLOAD': this.ldapStage
                };
                const inProgressMap = {
                    'PARSE': 'parsingInProgress', 'VALIDATE': 'validationInProgress',
                    'DB_SAVE': 'dbSaveInProgress', 'LDAP_UPLOAD': 'ldapInProgress'
                };
                const completedMap = {
                    'PARSING_COMPLETED': 'parsingCompleted', 'VALIDATION_COMPLETED': 'validationCompleted',
                    'DB_SAVING_COMPLETED': 'dbSaveCompleted', 'LDAP_SAVING_COMPLETED': 'ldapCompleted'
                };

                const targetStage = stageMap[progress.step];
                if (targetStage) {
                    targetStage.active = true;
                    if(inProgressMap[progress.step]) this[inProgressMap[progress.step]] = true;

                    targetStage.message = progress.message;
                    targetStage.percentage = progress.percentage;
                    // 상태를 단순화: VALIDATION_IN_PROGRESS → IN_PROGRESS 등
                    targetStage.status = this.normalizeStatus(progress.status);
                    targetStage.details = this.formatStageDetails(progress);
                }

                if (completedMap[progress.status]) {
                    this[completedMap[progress.status]] = true;
                    if(inProgressMap[progress.step]) this[inProgressMap[progress.step]] = false;

                    const notificationKey = `${progress.uploadId}_${progress.status}`;
                    if (!this.shownNotifications.has(notificationKey)) {
                        this.shownNotifications.add(notificationKey);
                        const stageNames = {
                            'PARSING_COMPLETED': '파싱',
                            'VALIDATION_COMPLETED': '인증서 검증',
                            'DB_SAVING_COMPLETED': 'DB 저장',
                            'LDAP_SAVING_COMPLETED': 'LDAP 저장'
                        };
                        if (stageNames[progress.status]) {
                            showNotification(`${stageNames[progress.status]} 단계가 완료되었습니다.`, 'success');
                        }
                    }
                }

                if (progress.step === 'PAUSE') {
                    if (completedMap[progress.stage]) this[completedMap[progress.stage]] = true;
                    this.isProcessing = false;
                    return;
                }

                if (progress.errorMessage) {
                    this.errorMessages.push(`[${progress.step}] ${progress.errorMessage}`);
                }

                if (progress.step === 'FINALIZED' || progress.status === 'FAILED') {
                    this.finalizeProcessing(progress);
                }
            },

            finalizeProcessing(progress) {
                this.overallStatus = progress.step === 'FINALIZED' ? 'FINALIZED' : 'FAILED';
                this.overallMessage = progress.message;
                this.isProcessing = false;
                this.parsingInProgress = false;
                this.validationInProgress = false;
                this.dbSaveInProgress = false;
                this.ldapInProgress = false;
                sessionStorage.removeItem('currentUploadId');
                if (this.sseReconnectTimer) clearTimeout(this.sseReconnectTimer);
                if (this.sseEventSource) this.sseEventSource.close();

                const stages = [this.uploadStage, this.parseStage, this.validateStage, this.dbSaveStage, this.ldapStage];
                if(this.overallStatus === 'FINALIZED') {
                    stages.forEach(stage => {
                        if (stage.status !== 'IDLE') {
                            stage.percentage = 100;
                            stage.status = 'COMPLETED';
                        }
                    });
                } else {
                    stages.forEach(stage => {
                        if (stage.status !== 'IDLE' && stage.status !== 'COMPLETED') stage.status = 'FAILED';
                    });
                }
                const finalNotificationKey = `${progress.uploadId}_FINALIZED`;
                if (!this.shownNotifications.has(finalNotificationKey)) {
                    this.shownNotifications.add(finalNotificationKey);
                    showNotification(progress.message, this.overallStatus === 'FINALIZED' ? 'success' : 'error');
                }
            },

            async triggerManualStep(step) {
                if (!this.uploadId) { showNotification('업로드된 파일이 없습니다.', 'warning'); return; }
                this.isProcessing = true;
                this.errorMessages = this.errorMessages.filter(e => !e.startsWith(`[${step}]`));

                const stepNames = {'PARSE': '파싱', 'VALIDATE': '검증', 'UPLOAD_TO_LDAP': 'LDAP 저장'};
                const inProgressMap = {'PARSE': 'parsingInProgress', 'VALIDATE': 'validationInProgress', 'UPLOAD_TO_LDAP': 'ldapInProgress'};
                const stageMap = {
                    'PARSE': this.parseStage, 'VALIDATE': this.validateStage, 'UPLOAD_TO_LDAP': this.ldapStage
                };

                this[inProgressMap[step]] = true;
                stageMap[step].status = 'IN_PROGRESS';
                this.startSseConnection();
                await new Promise(resolve => setTimeout(resolve, 500));

                try {
                    const endpoint = `/api/processing/${step.toLowerCase().replace(/_/g, '-')}/${this.uploadId}`;
                    const response = await fetch(endpoint, { method: 'POST' });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || '수동 처리 시작에 실패했습니다.');
                    }
                } catch (error) {
                    this.errorMessages.push(`[${step}] ${error.message}`);
                    this.isProcessing = false;
                    this[inProgressMap[step]] = false;
                    stageMap[step].status = 'FAILED';
                }
            },

            triggerParse() { this.triggerManualStep('PARSE'); },
            triggerValidate() { this.triggerManualStep('VALIDATE'); },
            triggerLdapUpload() { this.triggerManualStep('UPLOAD_TO_LDAP'); },

            // Step 3: 검증 + DB 저장 통합 메시지
            getValidateDbStageMessage() {
                if (this.dbSaveStage.status === 'COMPLETED') {
                    return '검증 + DB 저장 완료';
                } else if (this.dbSaveStage.status === 'IN_PROGRESS') {
                    return this.dbSaveStage.message || 'DB 저장 중...';
                } else if (this.dbSaveStage.status === 'FAILED') {
                    return this.dbSaveStage.message || 'DB 저장 실패';
                } else if (this.validateStage.status === 'COMPLETED') {
                    return '검증 완료, DB 저장 중...';
                } else if (this.validateStage.status === 'IN_PROGRESS') {
                    return this.validateStage.message || '인증서 검증 중...';
                } else if (this.validateStage.status === 'FAILED') {
                    return this.validateStage.message || '검증 실패';
                }
                return '파싱 완료 대기 중';
            },

            // Step 3: 검증 + DB 저장 통합 퍼센트
            getValidateDbStagePercentage() {
                if (this.dbSaveStage.status === 'COMPLETED') {
                    return 100;
                } else if (this.dbSaveStage.status === 'IN_PROGRESS') {
                    // DB 저장은 50-100% 범위
                    return 50 + Math.round(this.dbSaveStage.percentage / 2);
                } else if (this.validateStage.status === 'COMPLETED') {
                    return 50;
                } else if (this.validateStage.status === 'IN_PROGRESS') {
                    // 검증은 0-50% 범위
                    return Math.round(this.validateStage.percentage / 2);
                }
                return 0;
            },

            // 백엔드 상태를 단순화된 UI 상태로 변환
            // VALIDATION_IN_PROGRESS → IN_PROGRESS, VALIDATION_COMPLETED → COMPLETED 등
            normalizeStatus(status) {
                if (!status) return 'IDLE';
                if (status.includes('_IN_PROGRESS') || status.includes('_STARTED')) return 'IN_PROGRESS';
                if (status.includes('_COMPLETED') || status === 'COMPLETED') return 'COMPLETED';
                if (status === 'FAILED') return 'FAILED';
                if (status === 'UPLOAD_COMPLETED') return 'COMPLETED';
                return status;
            },

            formatStageDetails(progress) {
                if (!progress) return '';
                let html = '';
                // 백엔드 상태가 _COMPLETED로 끝나거나 COMPLETED인 경우 완료 상태로 처리
                const isCompleted = progress.status && (progress.status.includes('_COMPLETED') || progress.status === 'COMPLETED');
                if (isCompleted && progress.details) {
                    const details = progress.details.split(',').map(d => d.trim());
                    details.forEach(detail => {
                        if (detail) {
                            let badgeClass = 'badge-primary';
                            if (detail.includes('Master List') || detail.includes('ML')) badgeClass = 'badge-secondary';
                            else if (detail.includes('CSCA')) badgeClass = 'badge-success';
                            else if (detail.includes('DSC_NC')) badgeClass = 'badge-accent';
                            else if (detail.includes('DSC')) badgeClass = 'badge-info';
                            else if (detail.includes('CRL')) badgeClass = 'badge-warning';
                            else if (detail.includes('유효')) badgeClass = 'badge-success';
                            else if (detail.includes('무효') || detail.includes('실패')) badgeClass = 'badge-error';
                            html += `<div><span class="badge badge-sm ${badgeClass}">${detail}</span></div>`;
                        }
                    });
                } else if (progress.processedCount > 0 && progress.totalCount > 0) {
                    const percentage = Math.round((progress.processedCount / progress.totalCount) * 100);
                    html = `<div class="col-span-3 flex items-center gap-2">
                              <span class="text-xs font-medium">진행률: ${percentage}%</span>
                              <span class="text-xs text-gray-500">(${progress.processedCount} / ${progress.totalCount})</span>
                            </div>`;
                } else if (progress.details) {
                    html = `<div class="col-span-3"><span class="text-xs opacity-70">${progress.details}</span></div>`;
                }
                return html;
            },

            destroySseConnection() {
                if (this.sseReconnectTimer) clearTimeout(this.sseReconnectTimer);
                if (this.sseEventSource) this.sseEventSource.close();
                this.sseReconnectAttempts = 0;
            }
          };
        }

        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                console.warn('Toast container not found!');
                alert(message);
                return;
            }
            const toast = document.createElement('div');
            const alertClass = {
                success: 'alert-success', error: 'alert-error',
                warning: 'alert-warning', info: 'alert-info'
            }[type];

            const iconSvg = type === 'success'
                ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>';

            toast.className = `alert ${alertClass} shadow-lg transition-all duration-300 transform`;
            toast.innerHTML = `<div class="flex items-center gap-2">${iconSvg}<span>${message}</span></div>`;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.style.opacity = '0', 4700);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
    </th:block>
  </body>
</html>
