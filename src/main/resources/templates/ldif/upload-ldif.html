<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}"
>
  <body>
    <div layout:fragment="content">
      <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="flex justify-center">
          <div class="w-full max-w-2xl">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
              <!-- 페이지 헤더 -->
              <div class="bg-green-600 text-white px-6 py-4">
                <h1 class="text-2xl font-bold flex items-center gap-3">
                  <i class="fas fa-file-upload text-green-200"></i>
                  LDIF 파일 업로드
                </h1>
                <p class="text-green-100 text-sm mt-2">
                  LDIF 파일(.ldif)을 업로드하고 중복 여부를 확인합니다.
                </p>
              </div>
              <!-- 본문 -->
              <div class="p-6">
                <!-- Alert Messages -->
                <div
                  th:if="${error}"
                  class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-md auto-hide-alert"
                >
                  <div class="flex items-center">
                    <i
                      class="fas fa-exclamation-triangle text-red-500 mr-3"
                    ></i>
                    <div class="flex-1">
                      <span th:text="${error}" class="text-red-700"></span>
                    </div>
                    <button
                      type="button"
                      class="text-red-400 hover:text-red-600 transition-colors alert-close-btn"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <!-- Success Message -->
                <div
                  th:if="${success}"
                  class="mb-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-md auto-hide-alert"
                >
                  <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-3"></i>
                    <div class="flex-1">
                      <span th:text="${success}" class="text-green-700"></span>
                    </div>
                    <button
                      type="button"
                      class="text-green-400 hover:text-green-600 transition-colors alert-close-btn"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <!-- LD 연결 테스트 -->
                <div class="mb-6">
                  <button
                    id="testConnectionBtn"
                    class="bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100 hover:border-blue-300 px-4 py-2 rounded-md font-medium transition-all duration-200 flex items-center gap-2"
                  >
                    <i class="fas fa-plug"></i> LDAP 연결 테스트
                  </button>
                  <div id="connectionResult" class="mt-3"></div>
                </div>

                <!-- File Upload From with SSE -->
                <div class="mb-6">
                  <!-- File Upload Form -->
                  <div
                    id="sseContainer"
                    hx-ext="sse"
                    sse-connect="/parsing-progress"
                    hx-on::sse-connection-established="handleParsingSSEOpen(event)"
                    hx-on::sse-error="handleParsingSSEError(event)"
                    hx-on::sse-close="handleParsingSSEClose(event)"
                  >
                    <form
                      id="uploadForm"
                      hx-encoding="multipart/form-data"
                      hx-post="/ldif/upload"
                      hx-swap="none"
                      hx-disabled-elt="#uploadBtn, #file"
                      hx-on::before-request="handleUploadStart()"
                      hx-on::after-request="handleUploadComplete()"
                      hx-timeout="300000"
                      class="space-y-6"
                    >
                      <div>
                        <label
                          for="file"
                          class="block text-sm font-medium text-gray-700 mb-2"
                        >
                          <i class="fas fa-file text-blue-500 mr-2"></i> LDIF
                          파일 선택
                        </label>
                        <input
                          type="file"
                          class="file-input file-input-bordered w-full max-w-xs"
                          id="file"
                          name="file"
                          accept=".ldif"
                          required
                        />
                        <div
                          id="fileInfo"
                          class="mt-2 text-sm text-gray-600 hidden"
                        >
                          <i
                            class="fas fa-check-circle text-green-500 mr-1"
                          ></i>
                          <span id="fileName"></span>
                          <span id="fileSize" class="ml-2 text-gray-400"></span>
                        </div>

                        <p class="mt-2 text-sm text-gray-600">
                          LDIF (LDAP Data Interchange Format) 파일만 업로드할 수 있습니다.
                          <br/>최대 파일 크기:
                          <span class="font-semibold">100MB</span>
                        </p>
                      </div>

                      <!-- 파일 정보 미리보기 -->
                      <div id="file-preview" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                          <i class="fas fa-info-circle mr-2"></i>
                          파일 정보 미리보기
                        </h4>
                        <dl class="grid grid-cols-2 gap-3 text-sm">
                          <dt class="text-gray-600 font-medium">Collection:</dt>
                          <dd id="preview-collection" class="text-gray-900">-</dd>

                          <dt class="text-gray-600 font-medium">Format:</dt>
                          <dd id="preview-format" class="text-gray-900">-</dd>

                          <dt class="text-gray-600 font-medium">Version:</dt>
                          <dd id="preview-version" class="text-gray-900">-</dd>

                          <dt class="text-gray-600 font-medium">Type:</dt>
                          <dd id="preview-type" class="text-gray-900">-</dd>
                        </dl>
                      </div>

                      <!-- ICAO 공식 체크섬 입력 (선택사항) -->
                      <div class="mt-4">
                        <label
                          for="expectedChecksum"
                          class="block text-sm font-medium text-gray-700 mb-2"
                        >
                          <i class="fas fa-fingerprint text-purple-500 mr-2"></i>
                          ICAO 공식 SHA-1 체크섬 (선택사항)
                        </label>
                        <input
                          type="text"
                          id="expectedChecksum"
                          name="expectedChecksum"
                          placeholder="예: 82f8106001664427a7d686017aa49dc3fd3722f1"
                          pattern="[a-fA-F0-9]{40}"
                          maxlength="40"
                          class="input input-bordered w-full font-mono text-sm"
                        />
                        <p class="mt-1 text-xs text-gray-500 flex items-start gap-1">
                          <i class="fas fa-lightbulb text-yellow-500 mt-0.5"></i>
                          <span>ICAO PKD 다운로드 페이지의 Checksum 값을 입력하면 업로드 후 자동으로 검증됩니다.</span>
                        </p>
                      </div>
                      <div>
                        <button
                          type="submit"
                          id="uploadBtn"
                          class="btn btn-dash btn-primary"
                        >
                          <i class="fas fa-upload"></i> 파일 업로드 및 분석
                        </button>
                      </div>
                    </form>

                    <!-- 파싱 진행률 표시 영역 -->
                    <div
                      class="mt-4 card bg-base-100 card-lg shadow-sm"
                      id="progressCard"
                    >
                      <div class="card-body">
                        <h2 class="card-title flex items-center">
                          <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                          LDIF 분석 진행 상태
                        </h2>

                        <div
                          id="parsingProgressSection"
                          sse-swap="parsing-progress"
                          hx-on::sse-parsing-progress="handleParsingProgress(event)"
                          hx-on::sse-parsing-error="handleParsingError(event)"
                          class="min-h-16"
                        >
                          <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-clock mr-2"></i>
                            파싱 대기 중...
                            <div class="text-xs text-gray-400 mt-2">
                              파일을 업로드하면 실시간 진행률이 표시됩니다.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 주요 기능 소개 -->
                <div class="mt-8">
                  <h5 class="text-lg font-semibold text-gray-800 mb-4">
                    주요 기능
                  </h5>
                  <div
                    class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200"
                  >
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-search text-blue-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >LDIF 파일 구문 분석 및 검증</span
                        >
                      </div>

                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-chart-bar text-green-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >엔트리 통계 및 ObjectClass 분석</span
                        >
                      </div>

                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-cyan-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-database text-cyan-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >OpenLDAP 서버 직접 저장</span
                        >
                      </div>

                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-certificate text-purple-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >X.509 인증서 검증</span
                        >
                      </div>

                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center"
                        >
                          <i
                            class="fas fa-exclamation-triangle text-yellow-600"
                          ></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >실시간 오류 검출 및 보고</span
                        >
                      </div>

                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-bolt text-indigo-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >실시간 진행률 표시</span
                        >
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 시스템 요구 사항 -->
                <div
                  class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <h6 class="text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>시스템
                    요구사항
                  </h6>
                  <ul class="text-sm text-gray-600 space-y-1">
                    <li>• 최대 파일 크기: 100MB</li>
                    <li>• 지원 형식: LDIF (RFC 2849)</li>
                    <li>• 권장 브라우저: Chrome, Firefox, Safari</li>
                    <li>• 실시간 진행률을 위한 SSE 지원 필요</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-8 text-gray-500 text-sm">
              <p>
                © 2024 LDIF File Manager. 안전하고 효율적인 LDAP 데이터 관리.
              </p>
              <p class="mt-1">
                <i class="fas fa-shield-alt text-green-500 mr-1"></i>
                SSL 암호화 및 안전한 데이터 처리
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- 중복 파일 경고 모달 -->
      <div id="duplicateWarningModal" class="modal">
        <div class="modal-box max-w-2xl">
          <h3 class="font-bold text-lg flex items-center">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
            중복 파일 감지
          </h3>

          <div class="py-4">
            <p class="text-gray-700 mb-4" id="duplicateMessage"></p>

            <div class="bg-gray-50 p-4 rounded-lg mb-4">
              <h4 class="font-semibold mb-3 text-gray-800">기존 업로드 정보:</h4>
              <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <dt class="text-gray-600 font-medium">파일명:</dt>
                <dd id="existingFilename" class="font-mono text-gray-900">-</dd>

                <dt class="text-gray-600 font-medium">업로드 날짜:</dt>
                <dd id="existingUploadDate" class="text-gray-900">-</dd>

                <dt class="text-gray-600 font-medium">버전:</dt>
                <dd id="existingVersion" class="font-mono text-gray-900">-</dd>

                <dt class="text-gray-600 font-medium">상태:</dt>
                <dd id="existingStatus" class="text-gray-900">-</dd>
              </dl>
            </div>

            <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-2">
              <h5 class="font-semibold text-sm text-blue-800 mb-1">경고 유형:</h5>
              <p id="warningTypeInfo" class="text-sm"></p>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
              <h5 class="font-semibold text-sm text-yellow-800 mb-1">추가 정보:</h5>
              <p id="additionalInfo" class="text-sm text-gray-700"></p>
            </div>
          </div>

          <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeDuplicateModal()">
              <i class="fas fa-times mr-1"></i> 취소
            </button>
            <a class="btn btn-outline btn-info" id="viewHistoryBtn" href="#" target="_blank">
              <i class="fas fa-history mr-1"></i> 기존 이력 보기
            </a>
            <button class="btn btn-primary" id="forceUploadBtn" onclick="forceUpload()">
              <i class="fas fa-upload mr-1"></i> 강제 업로드
            </button>
          </div>
        </div>
      </div>
    </div>
    <th:block layout:fragment="script-content">
      <script type="text/javascript" th:src="@{/webjars/htmx-ext-sse/dist/sse.js}"></script>
      <script th:inline="javascript" type="text/javascript">
        // 전역 변수 (개선된 상태 관리)
        let isParsingInProgress = false;
        let currentSessionId = [[${sessionId}]] || generateSessionId();
        let sseRetryCount = 0;
        let maxRetryAttempts = 3;
        let progressUpdateCount = 0;


        // 페이지 로드 시 세션 ID 설정
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Current session ID:", currentSessionId);
            
            // 자동 알림 숨김 처리
            setupAutoHideAlerts();
            
            // 파일 크기 검증 리스너 추가
            setupFileSizeValidation();
        });

        // LDAP 연결 테스트 (개선된 버전)
        document.getElementById("testConnectionBtn").addEventListener("click", function () {
            const btn = this;
            const resultDiv = document.getElementById("connectionResult");
            const originalContent = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>테스트중...';
            btn.classList.add("opacity-75", "cursor-not-allowed");

            fetch("/ldap-test-connection")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const alertClass = data.success ? "green" : "red";
                    const iconClass = data.success ? "check" : "times";
                    
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-${alertClass}-50 border-l-4 border-${alertClass}-500 rounded-md animate-fadeIn">
                            <div class="flex items-center">
                                <i class="fas fa-${iconClass} text-${alertClass}-500 mr-3"></i>
                                <span class="text-${alertClass}-700 font-medium">${data.message}</span>
                            </div>
                        </div>
                    `;
                    
                    // 성공 메시지는 5초 후 자동 숨김
                    if (data.success) {
                        setTimeout(() => fadeOutElement(resultDiv.firstElementChild), 5000);
                    }
                })
                .catch(error => {
                    console.error("LDAP connection test error:", error);
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-md animate-fadeIn">
                            <div class="flex items-center">
                                <i class="fas fa-times text-red-500 mr-3"></i>
                                <span class="text-red-700 font-medium">연결 테스트 실패: ${error.message}</span>
                            </div>
                        </div>
                    `;
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                    btn.classList.remove("opacity-75", "cursor-not-allowed");
                });
        });

        // 파일 선택 처리 (개선된 검증 + 미리보기 + 중복 체크)
        function setupFileSizeValidation() {
            document.getElementById("file").addEventListener("change", async function () {
                const file = this.files[0];
                const fileInfo = document.getElementById("fileInfo");
                const fileName = document.getElementById("fileName");
                const fileSize = document.getElementById("fileSize");
                const filePreview = document.getElementById("file-preview");
                const maxSize = 100 * 1024 * 1024; // 100MB

                if (file) {
                    // 파일 크기 검증
                    if (file.size > maxSize) {
                        showFileError(`파일이 너무 큽니다. 최대 크기는 ${formatFileSize(maxSize)}입니다.`);
                        this.value = "";
                        fileInfo.classList.add("hidden");
                        filePreview.classList.add("hidden");
                        return;
                    }

                    // 파일 확장자 검증
                    if (!file.name.toLowerCase().endsWith(".ldif")) {
                        showFileError("LDIF 파일만 업로드할 수 있습니다.");
                        this.value = "";
                        fileInfo.classList.add("hidden");
                        filePreview.classList.add("hidden");
                        return;
                    }

                    fileName.textContent = file.name;
                    fileSize.textContent = `(${formatFileSize(file.size)})`;
                    fileInfo.classList.remove("hidden");

                    // 파일명으로부터 메타데이터 추출 및 미리보기 표시
                    parseAndDisplayFileMetadata(file.name);

                    // 기존 에러 메시지 제거
                    removeExistingFileErrors();

                    // 중복 체크 수행
                    await checkDuplicateBeforeUpload(file);
                } else {
                    fileInfo.classList.add("hidden");
                    filePreview.classList.add("hidden");
                }
            });
        }

        // 파일명에서 메타데이터 추출 및 표시
        function parseAndDisplayFileMetadata(filename) {
            const filePreview = document.getElementById("file-preview");
            const previewCollection = document.getElementById("preview-collection");
            const previewFormat = document.getElementById("preview-format");
            const previewVersion = document.getElementById("preview-version");
            const previewType = document.getElementById("preview-type");

            // LDIF 파일명 패턴: icaopkd-{collection}-{type}-{version}.ldif
            const ldifPattern = /icaopkd-(\d{3})-(complete|delta)-(\d+)\.ldif/i;
            const match = filename.toLowerCase().match(ldifPattern);

            if (match) {
                const collection = match[1];
                const type = match[2];
                const version = match[3];

                // Collection 설명
                let collectionDesc = '';
                let collectionBadge = '';
                if (collection === '001') {
                    collectionDesc = 'eMRTD PKI Objects';
                    collectionBadge = '<span class="badge badge-primary">Collection #001</span>';
                } else if (collection === '002') {
                    collectionDesc = 'CSCA Master Lists';
                    collectionBadge = '<span class="badge badge-success">Collection #002</span>';
                } else if (collection === '003') {
                    collectionDesc = 'Non-Conformant (Deprecated)';
                    collectionBadge = '<span class="badge badge-warning">Collection #003</span>';
                }

                // Type 설명
                const typeDesc = type === 'complete' ?
                    '<span class="badge badge-info">Complete</span>' :
                    '<span class="badge badge-accent">Delta</span>';

                // Format 설명
                let formatDesc = '';
                if (collection === '001' && type === 'complete') {
                    formatDesc = 'CSCA_COMPLETE_LDIF';
                } else if (collection === '001' && type === 'delta') {
                    formatDesc = 'CSCA_DELTA_LDIF';
                } else if (collection === '002' && type === 'complete') {
                    formatDesc = 'EMRTD_COMPLETE_LDIF';
                } else if (collection === '002' && type === 'delta') {
                    formatDesc = 'EMRTD_DELTA_LDIF';
                } else if (collection === '003' && type === 'complete') {
                    formatDesc = 'NON_CONFORMANT_COMPLETE_LDIF';
                } else if (collection === '003' && type === 'delta') {
                    formatDesc = 'NON_CONFORMANT_DELTA_LDIF';
                }

                previewCollection.innerHTML = `${collectionBadge} <span class="text-sm text-gray-600 ml-2">${collectionDesc}</span>`;
                previewFormat.innerHTML = `<code class="text-xs bg-gray-100 px-2 py-1 rounded">${formatDesc}</code>`;
                previewVersion.innerHTML = `<span class="font-mono font-semibold text-blue-600">${version}</span>`;
                previewType.innerHTML = typeDesc;

                filePreview.classList.remove("hidden");
            } else {
                // 패턴 불일치 시 경고 표시
                previewCollection.textContent = '알 수 없음';
                previewFormat.textContent = '비표준 파일명';
                previewVersion.textContent = '-';
                previewType.innerHTML = '<span class="text-yellow-600">⚠️ 파일명 형식 확인 필요</span>';

                filePreview.classList.remove("hidden");
            }
        }

        // 업로드 시작 처리 (개선된 버전)
        function handleUploadStart() {
            console.log("Upload started");
            isParsingInProgress = true;
            progressUpdateCount = 0;
            sseRetryCount = 0;
            
            // 업로드 버튼 상태 변경
            const uploadBtn = document.getElementById("uploadBtn");
            uploadBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>업로드 및 분석 중...';
            uploadBtn.disabled = true;
            
            // 진행률 섹션 준비
            prepareProgressSection();
        }

        // 업로드 완료 처리
        function handleUploadComplete() {
            console.log("Upload completed");
            
            // 버튼 상태 복원 (지연)
            setTimeout(() => {
                const uploadBtn = document.getElementById("uploadBtn");
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>파일 업로드 및 분석';
                    uploadBtn.disabled = false;
                }
                isParsingInProgress = false;
            }, 3000);
        }

        // 진행률 섹션 준비
        function prepareProgressSection() {
            const progressSection = document.getElementById("parsingProgressSection");
            if (progressSection) {
                progressSection.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-satellite-dish animate-pulse mr-2 text-blue-500"></i>
                            <div>
                                실시간 진행률 연결 중...
                                <div class="text-sm text-blue-600 mt-1">잠시만 기다려주세요.</div>
                            </div>
                        </div>
                    </div>
                `;
                progressSection.classList.remove("hidden");
            }
        }

        // SSE 연결 성공 처리 (개선된 버전)
        function handleParsingSSEOpen(event) {
            console.log("Parsing SSE connection established", event);
            sseRetryCount = 0; // 성공 시 재시도 카운트 리셋
        }

        // SSE 연결 확인 처리 (새로운 이벤트)
        function handleConnectionEstablished(event) {
            console.log("Connection established event received", event);
            // 이미 SSE에서 HTML을 받아서 자동으로 표시되므로 추가 처리 불필요
        }

        // SSE 연결 오류 처리 (개선된 재연결 로직)
        function handleParsingSSEError(event) {
            console.error("Parsing SSE connection error", event);
            sseRetryCount++;
            
            const progressSection = document.getElementById("parsingProgressSection");
            if (progressSection) {
                if (sseRetryCount <= maxRetryAttempts) {
                    progressSection.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
                                <div>
                                    연결 오류 발생. 재연결 시도 중... (${sseRetryCount}/${maxRetryAttempts})
                                    <div class="text-sm text-yellow-600 mt-1">잠시만 기다려주세요.</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 재연결 시도
                    setTimeout(() => attemptSSEReconnection(), 2000);
                } else {
                    progressSection.innerHTML = `
                        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                                <div>
                                    실시간 진행률 연결에 실패했습니다.
                                    <div class="text-sm text-red-600 mt-1">페이지를 새로고침해주세요.</div>
                                    <button onclick="location.reload()" 
                                            class="mt-2 text-sm bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded">
                                        새로고침
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // SSE 연결 종료 처리
        function handleParsingSSEClose(event) {
            console.log("Parsing SSE connection closed", event);
            
            if (isParsingInProgress && sseRetryCount < maxRetryAttempts) {
                // 파싱이 진행 중인데 연결이 끊어진 경우 재연결 시도
                console.log("Attempting SSE reconnection...");
                setTimeout(() => attemptSSEReconnection(), 1000);
            }
        }

        // 파싱 진행률 이벤트 처리 (개선된 버전)
        function handleParsingProgress(event) {
            console.log("Parsing progress event received", event);
            progressUpdateCount++;
            
            // HTMX가 자동으로 HTML을 업데이트하므로 추가 처리는 최소화
            if (progressUpdateCount % 10 === 0) {
                console.log(`Progress updates received: ${progressUpdateCount}`);
            }
        }

        // 파싱 오류 이벤트 처리
        function handleParsingError(event) {
            console.error("Parsing error event received", event);
            isParsingInProgress = false;
            sseRetryCount = maxRetryAttempts; // 오류 발생 시 재연결 중단
            
            // HTMX가 자동으로 오류 HTML을 표시하므로 추가 처리 불필요
        }

        // SSE 재연결 시도
        function attemptSSEReconnection() {
            try {
                const sseContainer = document.getElementById("sseContainer");
                if (sseContainer && isParsingInProgress) {
                    // HTMX SSE 재연결
                    htmx.trigger(sseContainer, "sse:close");
                    
                    setTimeout(() => {
                        htmx.trigger(sseContainer, "sse:connect", { url: "/parsing-progress" });
                    }, 500);
                    
                    console.log("SSE reconnection attempted");
                }
            } catch (error) {
                console.error("SSE reconnection failed:", error);
            }
        }

        // 파일 크기 포맷터
        function formatFileSize(bytes) {
            if (bytes === 0) return "0 Bytes";
            const k = 1024;
            const sizes = ["Bytes", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
        }

        // 파일 오류 표시 (개선된 버전)
        function showFileError(message) {
            // 기존 오류 메시지 제거
            removeExistingFileErrors();
            
            const errorDiv = document.createElement("div");
            errorDiv.className = "mt-2 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 animate-fadeIn file-error";
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                    <span>${message}</span>
                    <button type="button" class="ml-auto text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            const fileInput = document.getElementById("file");
            fileInput.parentNode.appendChild(errorDiv);

            // 10초 후 자동 제거
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    fadeOutElement(errorDiv);
                }
            }, 10000);
        }

        // 기존 파일 오류 메시지 제거
        function removeExistingFileErrors() {
            const existingErrors = document.querySelectorAll(".file-error");
            existingErrors.forEach(error => error.remove());
        }

        // 세션 ID 생성
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 자동 알림 숨김 설정 (개선된 버전)
        function setupAutoHideAlerts() {
            const alerts = document.querySelectorAll(".auto-hide-alert");
            
            alerts.forEach((alert) => {
                // 닫기 버튼 이벤트 리스너 추가
                const closeBtn = alert.querySelector(".alert-close-btn");
                if (closeBtn) {
                    closeBtn.addEventListener("click", () => fadeOutElement(alert));
                }
                
                // 자동 숨김 (성공 메시지는 5초, 오류 메시지는 10초)
                const isError = alert.classList.contains("border-red-500");
                const timeout = isError ? 10000 : 5000;
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        fadeOutElement(alert);
                    }
                }, timeout);
            });
        }

        // 부드러운 페이드 아웃 효과
        function fadeOutElement(element) {
            if (!element) return;
            
            element.style.opacity = "0";
            element.style.transform = "translateY(-10px)";
            element.style.transition = "all 0.3s ease-out";
            
            setTimeout(() => {
                if (element.parentNode) {
                    element.remove();
                }
            }, 300);
        }

        // HTMX 이벤트 리스너 설정 (디버깅 및 모니터링)
        document.addEventListener("htmx:beforeRequest", function(event) {
            if (event.detail.elt.id === "uploadForm") {
                console.log("HTMX upload request starting");
            }
        });

        document.addEventListener("htmx:afterRequest", function(event) {
            if (event.detail.elt.id === "uploadForm") {
                console.log("HTMX upload request completed", {
                    status: event.detail.xhr.status,
                    responseType: event.detail.xhr.getResponseHeader('content-type')
                });
            }
        });

        document.addEventListener("htmx:responseError", function(event) {
            console.error("HTMX response error:", event.detail);
            
            // 업로드 오류 시 버튼 상태 복원
            if (event.detail.elt.id === "uploadForm") {
                const uploadBtn = document.getElementById("uploadBtn");
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>파일 업로드 및 분석';
                    uploadBtn.disabled = false;
                }
                isParsingInProgress = false;
            }
        });

        // SSE 이벤트 디버깅
        document.addEventListener("htmx:sseConnecting", function(event) {
            console.log("SSE connecting...", event);
        });

        document.addEventListener("htmx:sseConnected", function(event) {
            console.log("SSE connected successfully", event);
        });

        document.addEventListener("htmx:sseError", function(event) {
            console.error("SSE error occurred", event);
        });

        // 페이지 언로드 시 정리
        window.addEventListener("beforeunload", function() {
            isParsingInProgress = false;
            console.log("Page unloading, cleaning up...");
        });

        // 페이지 가시성 변경 처리
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                console.log("Page hidden - SSE may be paused by browser");
            } else {
                console.log("Page visible - SSE should resume");
                // 페이지가 다시 보이고 파싱이 진행 중이면 연결 상태 확인
                if (isParsingInProgress && sseRetryCount < maxRetryAttempts) {
                    setTimeout(() => attemptSSEReconnection(), 1000);
                }
            }
        });

        // ====== 중복 파일 체크 기능 ======

        // SHA-256 해시 계산 (브라우저 Web Crypto API 사용)
        async function calculateFileHashSHA256(file) {
            try {
                const buffer = await file.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error('Error calculating file hash:', error);
                throw error;
            }
        }

        // 중복 파일 체크
        async function checkDuplicateBeforeUpload(file) {
            try {
                console.log('Starting duplicate check for:', file.name);

                // 해시 계산 중 표시
                showDuplicateCheckProgress('파일 해시 계산 중...');

                const fileHash = await calculateFileHashSHA256(file);
                console.log('File hash calculated:', fileHash);

                // 중복 검사 중 표시
                showDuplicateCheckProgress('중복 파일 검사 중...');

                const response = await fetch('/api/duplicate-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        fileSize: file.size,
                        fileHash: fileHash
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Duplicate check result:', result);

                // 진행 표시 제거
                removeDuplicateCheckProgress();

                if (result.isDuplicate) {
                    showDuplicateWarningModal(result);
                    return false;
                }

                return true;

            } catch (error) {
                console.error('Error checking duplicate:', error);
                removeDuplicateCheckProgress();
                showFileError('중복 검사 중 오류가 발생했습니다: ' + error.message);
                return true; // 오류 발생 시 업로드 허용
            }
        }

        // 중복 체크 진행 표시
        function showDuplicateCheckProgress(message) {
            removeDuplicateCheckProgress(); // 기존 진행 표시 제거

            const progressDiv = document.createElement('div');
            progressDiv.id = 'duplicate-check-progress';
            progressDiv.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 animate-fadeIn';
            progressDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-spinner animate-spin mr-2 text-blue-500"></i>
                    <span>${message}</span>
                </div>
            `;

            const fileInput = document.getElementById('file');
            fileInput.parentNode.appendChild(progressDiv);
        }

        // 중복 체크 진행 표시 제거
        function removeDuplicateCheckProgress() {
            const progress = document.getElementById('duplicate-check-progress');
            if (progress) {
                progress.remove();
            }
        }

        // 중복 파일 경고 모달 표시
        function showDuplicateWarningModal(data) {
            const modal = document.getElementById('duplicateWarningModal');
            const messageEl = document.getElementById('duplicateMessage');
            const filenameEl = document.getElementById('existingFilename');
            const uploadDateEl = document.getElementById('existingUploadDate');
            const versionEl = document.getElementById('existingVersion');
            const statusEl = document.getElementById('existingStatus');
            const warningTypeEl = document.getElementById('warningTypeInfo');
            const additionalInfoEl = document.getElementById('additionalInfo');
            const forceUploadBtn = document.getElementById('forceUploadBtn');
            const viewHistoryBtn = document.getElementById('viewHistoryBtn');

            // 모달 내용 설정
            messageEl.textContent = data.message || '중복 파일이 감지되었습니다.';
            filenameEl.textContent = data.existingFilename || '-';
            uploadDateEl.textContent = data.existingUploadDate ? formatDateTime(data.existingUploadDate) : '-';
            versionEl.textContent = data.existingVersion || '-';
            statusEl.textContent = data.existingStatus || '-';

            // 경고 유형에 따른 아이콘 및 색상
            let warningIcon = 'fa-exclamation-triangle';
            let warningColor = 'text-yellow-600';
            if (data.warningType === 'EXACT_DUPLICATE') {
                warningIcon = 'fa-copy';
                warningColor = 'text-red-600';
            } else if (data.warningType === 'SAME_VERSION') {
                warningIcon = 'fa-code-branch';
                warningColor = 'text-orange-600';
            } else if (data.warningType === 'OLDER_VERSION') {
                warningIcon = 'fa-history';
                warningColor = 'text-blue-600';
            }

            warningTypeEl.innerHTML = `<i class="fas ${warningIcon} ${warningColor} mr-2"></i>${data.warningType || ''}`;
            additionalInfoEl.textContent = data.additionalInfo || '';

            // 강제 업로드 버튼 활성화/비활성화
            if (data.canForceUpload) {
                forceUploadBtn.disabled = false;
                forceUploadBtn.classList.remove('btn-disabled');
            } else {
                forceUploadBtn.disabled = true;
                forceUploadBtn.classList.add('btn-disabled');
            }

            // 이력 보기 링크 설정
            if (data.existingUploadId) {
                viewHistoryBtn.href = `/upload-history?id=${data.existingUploadId}`;
            }

            // 모달 열기
            modal.classList.add('modal-open');
        }

        // 중복 모달 닫기
        function closeDuplicateModal() {
            const modal = document.getElementById('duplicateWarningModal');
            modal.classList.remove('modal-open');

            // 파일 입력 초기화
            const fileInput = document.getElementById('file');
            fileInput.value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('file-preview').classList.add('hidden');
        }

        // 강제 업로드
        function forceUpload() {
            // 강제 업로드 플래그를 폼에 추가
            const form = document.getElementById('uploadForm');
            let forceInput = document.getElementById('forceUploadInput');

            if (!forceInput) {
                forceInput = document.createElement('input');
                forceInput.type = 'hidden';
                forceInput.id = 'forceUploadInput';
                forceInput.name = 'forceUpload';
                form.appendChild(forceInput);
            }

            forceInput.value = 'true';

            // 모달 닫기
            closeDuplicateModal();

            // 폼 제출
            console.log('Force uploading file...');
            htmx.trigger(form, 'submit');
        }

        // 날짜/시간 포맷팅
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
      </script>

      <style>
        /* 애니메이션 정의 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        /* 스피너 애니메이션 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* 펄스 애니메이션 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* 진행률 바 애니메이션 */
        .progress-bar-animation {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 커스텀 파일 입력 스타일링 */
        input[type="file"]::-webkit-file-upload-button {
            transition: all 0.2s ease-in-out;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            color: #374151;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        input[type="file"]:hover::-webkit-file-upload-button {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 카드 호버 효과 개선 */
        .card {
            transition: all 0.3s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* 버튼 비활성화 상태 스타일 */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 반응형 텍스트 크기 조정 */
        @media (max-width: 768px) {
            .card-title {
                font-size: 1.1rem;
            }
            
            .text-2xl {
                font-size: 1.5rem;
            }
        }

        /* 접근성 개선 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* 포커스 스타일 개선 */
        button:focus,
        input:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
      </style>
    </th:block>
  </body>
</html>
