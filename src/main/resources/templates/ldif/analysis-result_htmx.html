<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}"
>
  <body>
    <div layout:fragment="content">
      <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-chart-line mr-3"></i> PKD LDIF 분석 결과
              </h1>
              <p class="text-gray-600 mt-1">
                세션ID:
                <span
                  th:text="${sessionId}"
                  class="font-medium text-blue-600"
                ></span>
              </p>
              <p class="text-gray-600 mt-1">
                파일:
                <span
                  th:text="${fileName}"
                  class="font-medium text-blue-600"
                ></span>
              </p>
            </div>
            <a
              href="/ldif"
              class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors shadow-md hover:shadow-lg"
            >
              <i class="fas fa-arrow-left mr-2"></i> 돌아가기
            </a>
          </div>
        </div>

        <!-- Alert Messages -->
        <div
          th:if="${error}"
          class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 animate-fadeIn"
          role="alert"
        >
          <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
            <span th:text="${error}" class="text-red-800"></span>
            <button
              type="button"
              class="ml-auto text-red-400 hover:text-red-600"
              onclick="this.parentElement.parentElement.remove()"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div
          th:if="${success}"
          class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 animate-fadeIn"
          role="alert"
        >
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span th:text="${success}" class="text-green-800"></span>
            <button
              type="button"
              class="ml-auto text-green-400 hover:text-green-600"
              onclick="this.parentElement.parentElement.remove()"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div
          th:if="${warning}"
          class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 animate-fadeIn"
          role="alert"
        >
          <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
            <span th:text="${warning}" class="text-yellow-800"></span>
            <button
              type="button"
              class="ml-auto text-yellow-400 hover:text-yellow-600"
              onclick="this.parentElement.parentElement.remove()"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Main Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div
            class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-6 shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center justify-between">
              <div>
                <h4
                  class="text-2xl font-bold"
                  th:text="${summary.totalEntries ?: 0}"
                >
                  0
                </h4>
                <p class="text-blue-100">총 엔트리</p>
              </div>
              <div class="text-blue-200">
                <i class="fas fa-list text-3xl"></i>
              </div>
            </div>
          </div>
          <div
            class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-6 shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center justify-between">
              <div>
                <h4
                  class="text-2xl font-bold"
                  th:text="${summary.addEntries ?: 0}"
                >
                  0
                </h4>
                <p class="text-green-100">추가 엔트리</p>
              </div>
              <div class="text-green-200">
                <i class="fas fa-plus text-3xl"></i>
              </div>
            </div>
          </div>
          <div
            class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-6 shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center justify-between">
              <div>
                <h4
                  class="text-2xl font-bold"
                  th:text="${(summary.certificateValidationStats['total'] ?: 0) + (summary.certificateValidationStats['totalMasterLists'] ?: 0)}"
                >
                  0
                </h4>
                <p class="text-purple-100">PKD 객체</p>
              </div>
              <div class="text-purple-200">
                <i class="fas fa-certificate text-3xl"></i>
              </div>
            </div>
          </div>
          <div
            th:class="'bg-gradient-to-br text-white rounded-lg p-6 shadow-lg hover:shadow-xl ' + ${(summary.totalErrors ?: #lists.size(summary.errors)) > 0 ? 'from-red-500 to-red-600' : 'from-gray-400 to-gray-500'}"
          >
            <div class="flex items-center justify-between">
              <div>
                <h4
                  class="text-2xl font-bold"
                  th:text="${summary.totalErrors ?: #lists.size(summary.errors)}"
                >
                  0
                </h4>
                <p
                  th:class="${(summary.totalErrors ?: #lists.size(summary.errors)) > 0 ? 'text-red-100' : 'text-gray-100'}"
                >
                  오류
                </p>
              </div>
              <div
                th:class="${(summary.totalErrors ?: #lists.size(summary.errors)) > 0 ? 'text-red-200' : 'text-gray-200'}"
              >
                <i class="fas fa-exclamation-triangle text-3xl"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- PKD Components Analysis -->
        <div
          th:if="${summary?.certificateValidationStats != null and !#maps.isEmpty(summary.certificateValidationStats)}"
          class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8"
        >
          <!-- Certificate Analysis -->
          <div
            th:if="${(summary.certificateValidationStats['total'] ?: 0) > 0}"
            class="bg-white rounded-lg shadow-md overflow-hidden"
          >
            <div
              class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-6 py-4"
            >
              <h5 class="text-xl font-semibold flex items-center">
                <i class="fas fa-certificate mr-2"></i> 인증서 분석
                <span
                  class="ml-2 bg-emerald-500 px-2 py-1 rounded-full text-sm"
                  th:text="${summary.certificateValidationStats['total']}"
                  >0</span
                >
              </h5>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div
                  class="text-center p-4 bg-green-50 rounded-lg border-2 border-green-200"
                >
                  <div
                    class="text-3xl font-bold text-green-600"
                    th:text="${summary.certificateValidationStats['valid'] ?: 0}"
                  >
                    0
                  </div>
                  <div class="text-gray-600 text-sm">유효한 인증서</div>
                </div>
                <div
                  class="text-center p-4 bg-red-50 rounded-lg border-2 border-red-200"
                >
                  <div
                    class="text-3xl font-bold text-red-600"
                    th:text="${summary.certificateValidationStats['invalid'] ?: 0}"
                  >
                    0
                  </div>
                  <div class="text-gray-600 text-sm">무효한 인증서</div>
                </div>
              </div>

              <!-- Certificate Success Rate Progress -->
              <div
                th:if="${(summary.certificateValidationStats['total'] ?: 0) > 0}"
              >
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">유효율</span>
                  <span
                    class="text-sm font-medium text-gray-900"
                    th:text="${T(java.lang.Math).round(((summary.certificateValidationStats['valid'] ?: 0) * 100.0) / (summary.certificateValidationStats['total'] ?: 1))} + '%'"
                    >0%</span
                  >
                </div>
                <div
                  class="w-full bg-gray-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${T(java.lang.Math).round(((summary.certificateValidationStats['valid'] ?: 0) * 100.0) / (summary.certificateValidationStats['total'] ?: 1))} + '%'"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Master List Analysis -->
          <div
            th:if="${(summary.certificateValidationStats['totalMasterLists'] ?: 0) > 0}"
            class="bg-white rounded-lg shadow-md overflow-hidden"
          >
            <div
              class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4"
            >
              <h5 class="text-xl font-semibold flex items-center">
                <i class="fas fa-list-alt mr-2"></i> Master List 분석
                <span
                  class="ml-2 bg-blue-500 px-2 py-1 rounded-full text-sm"
                  th:text="${summary.certificateValidationStats['totalMasterLists']}"
                  >0</span
                >
              </h5>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div
                  class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-200"
                >
                  <div
                    class="text-3xl font-bold text-blue-600"
                    th:text="${summary.certificateValidationStats['validMasterLists'] ?: 0}"
                  >
                    0
                  </div>
                  <div class="text-gray-600 text-sm">유효한 목록</div>
                </div>
                <div
                  class="text-center p-4 bg-orange-50 rounded-lg border-2 border-orange-200"
                >
                  <div
                    class="text-3xl font-bold text-orange-600"
                    th:text="${summary.certificateValidationStats['invalidMasterLists'] ?: 0}"
                  >
                    0
                  </div>
                  <div class="text-gray-600 text-sm">무효한 목록</div>
                </div>
              </div>

              <!-- Master List Success Rate Progress -->
              <div
                th:if="${(summary.certificateValidationStats['totalMasterLists'] ?: 0) > 0}"
              >
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">유효율</span>
                  <span
                    class="text-sm font-medium text-gray-900"
                    th:text="${T(java.lang.Math).round(((summary.certificateValidationStats['validMasterLists'] ?: 0) * 100.0) / (summary.certificateValidationStats['totalMasterLists'] ?: 1))} + '%'"
                    >0%</span
                  >
                </div>
                <div
                  class="w-full bg-gray-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${T(java.lang.Math).round(((summary.certificateValidationStats['validMasterLists'] ?: 0) * 100.0) / (summary.certificateValidationStats['totalMasterLists'] ?: 1))} + '%'"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Combined PKD Overview (when both certificates and master lists exist) -->
        <div
          th:if="${summary?.certificateValidationStats != null and !#maps.isEmpty(summary.certificateValidationStats) and (summary.certificateValidationStats['total'] ?: 0) > 0 and (summary.certificateValidationStats['totalMasterLists'] ?: 0) > 0}"
          class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"
        >
          <div
            class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-6 py-4"
          >
            <h5 class="text-xl font-semibold flex items-center">
              <i class="fas fa-shield-alt mr-2"></i> PKD 전체 현황
            </h5>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div
                class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200"
              >
                <div
                  class="text-2xl font-bold text-green-700 mb-1"
                  th:text="${(summary.certificateValidationStats['valid'] ?: 0) + (summary.certificateValidationStats['validMasterLists'] ?: 0)}"
                >
                  0
                </div>
                <div class="text-green-600 text-sm font-medium">총 유효</div>
              </div>
              <div
                class="text-center p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-xl border border-red-200"
              >
                <div
                  class="text-2xl font-bold text-red-700 mb-1"
                  th:text="${(summary.certificateValidationStats['invalid'] ?: 0) + (summary.certificateValidationStats['invalidMasterLists'] ?: 0)}"
                >
                  0
                </div>
                <div class="text-red-600 text-sm font-medium">총 무효</div>
              </div>
              <div
                class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200"
              >
                <div
                  class="text-2xl font-bold text-blue-700 mb-1"
                  th:text="${(summary.certificateValidationStats['total'] ?: 0) + (summary.certificateValidationStats['totalMasterLists'] ?: 0)}"
                >
                  0
                </div>
                <div class="text-blue-600 text-sm font-medium">총 객체</div>
              </div>
              <div
                class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border border-purple-200"
              >
                <div
                  class="text-2xl font-bold text-purple-700 mb-1"
                  th:text="${T(java.lang.Math).round((((summary.certificateValidationStats['valid'] ?: 0) + (summary.certificateValidationStats['validMasterLists'] ?: 0)) * 100.0) / ((summary.certificateValidationStats['total'] ?: 0) + (summary.certificateValidationStats['totalMasterLists'] ?: 0) ?: 1))} + '%'"
                >
                  0%
                </div>
                <div class="text-purple-600 text-sm font-medium">
                  전체 유효율
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Errors and Warnings Section -->
        <div
          th:if="${summary.hasValidationErrors}"
          class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"
        >
          <div
            class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-4"
          >
            <h5 class="text-xl font-semibold flex items-center">
              <i class="fas fa-exclamation-triangle mr-2"></i> 발견된 오류
              <span
                class="ml-2 bg-red-500 px-2 py-1 rounded-full text-sm"
                th:text="${#lists.size(summary.errors)}"
                >0</span
              >
              <span
                th:if="${summary.totalErrors > #lists.size(summary.errors)}"
                class="ml-2 text-red-200 text-sm"
              >
                (처음 10개만 표시, 총 [[${summary.totalErrors}]]개)
              </span>
            </h5>
          </div>
          <div class="p-6">
            <div
              class="bg-red-50 border border-red-200 rounded-lg p-4 max-h-60 overflow-y-auto"
            >
              <ul class="list-disc pl-5 space-y-2 text-red-800">
                <li
                  th:each="error : ${summary.errors}"
                  th:text="${error}"
                  class="leading-relaxed"
                ></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Warnings Section -->
        <div
          th:if="${!#lists.isEmpty(summary.warnings)}"
          class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"
        >
          <div
            class="bg-gradient-to-r from-yellow-600 to-yellow-700 text-white px-6 py-4"
          >
            <h5 class="text-xl font-semibold flex items-center">
              <i class="fas fa-exclamation-triangle mr-2"></i> 경고
              <span
                class="ml-2 bg-yellow-500 px-2 py-1 rounded-full text-sm"
                th:text="${#lists.size(summary.warnings)}"
                >0</span
              >
              <span
                th:if="${summary.totalWarnings > #lists.size(summary.warnings)}"
                class="ml-2 text-yellow-200 text-sm"
              >
                (처음 10개만 표시, 총 [[${summary.totalWarnings}]]개)
              </span>
            </h5>
          </div>
          <div class="p-6">
            <div
              class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 max-h-60 overflow-y-auto"
            >
              <ul class="list-disc pl-5 space-y-2 text-yellow-800">
                <li
                  th:each="warning : ${summary.warnings}"
                  th:text="${warning}"
                  class="leading-relaxed"
                ></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- EntryType Statistics Section -->
        <div
          th:if="${summary?.entryTypeCount != null and !#maps.isEmpty(summary.entryTypeCount)}"
          class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"
        >
          <div
            class="bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-4"
          >
            <h5 class="text-xl font-semibold flex items-center">
              <i class="fas fa-chart-pie mr-2"></i> EntryType 통계
              <span
                class="ml-2 bg-gray-500 px-2 py-1 rounded-full text-sm"
                th:text="${#maps.size(summary.entryTypeCount)}"
                >0</span
              >
            </h5>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- Master List -->
              <div
                th:if="${summary.entryTypeCount.containsKey('ML')}"
                class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-2 border-purple-200 hover:shadow-md transition-shadow duration-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <i class="fas fa-list-alt text-purple-600 mr-2"></i>
                    <span class="text-purple-800 font-semibold text-lg"
                      >Master List</span
                    >
                  </div>
                  <span
                    class="bg-purple-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm"
                    th:text="${summary.entryTypeCount['ML']}"
                    >0</span
                  >
                </div>
                <div
                  class="w-full bg-purple-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-purple-500 to-purple-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${summary.entryTypeCount['ML'] * 100 / summary.totalEntries} + '%'"
                  ></div>
                </div>
                <div
                  class="text-xs text-purple-600 mt-2 text-center font-medium"
                >
                  <span
                    th:text="${T(java.lang.Math).round(summary.entryTypeCount['ML'] * 100.0 / summary.totalEntries)}"
                    >0</span
                  >% of total
                </div>
              </div>

              <!-- DSC -->
              <div
                th:if="${summary.entryTypeCount.containsKey('DSC')}"
                class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-2 border-green-200 hover:shadow-md transition-shadow duration-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <i class="fas fa-certificate text-green-600 mr-2"></i>
                    <span class="text-green-800 font-semibold text-lg"
                      >DSC</span
                    >
                  </div>
                  <span
                    class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm"
                    th:text="${summary.entryTypeCount['DSC']}"
                    >0</span
                  >
                </div>
                <div
                  class="w-full bg-green-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${summary.entryTypeCount['DSC'] * 100 / summary.totalEntries} + '%'"
                  ></div>
                </div>
                <div
                  class="text-xs text-green-600 mt-2 text-center font-medium"
                >
                  <span
                    th:text="${T(java.lang.Math).round(summary.entryTypeCount['DSC'] * 100.0 / summary.totalEntries)}"
                    >0</span
                  >% of total
                </div>
              </div>

              <!-- CRL -->
              <div
                th:if="${summary.entryTypeCount.containsKey('CRL')}"
                class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border-2 border-orange-200 hover:shadow-md transition-shadow duration-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <i class="fas fa-ban text-orange-600 mr-2"></i>
                    <span class="text-orange-800 font-semibold text-lg"
                      >CRL</span
                    >
                  </div>
                  <span
                    class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm"
                    th:text="${summary.entryTypeCount['CRL']}"
                    >0</span
                  >
                </div>
                <div
                  class="w-full bg-orange-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-orange-500 to-orange-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${summary.entryTypeCount['CRL'] * 100 / summary.totalEntries} + '%'"
                  ></div>
                </div>
                <div
                  class="text-xs text-orange-600 mt-2 text-center font-medium"
                >
                  <span
                    th:text="${T(java.lang.Math).round(summary.entryTypeCount['CRL'] * 100.0 / summary.totalEntries)}"
                    >0</span
                  >% of total
                </div>
              </div>

              <!-- Country -->
              <div
                th:if="${summary.entryTypeCount.containsKey('C')}"
                class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-2 border-blue-200 hover:shadow-md transition-shadow duration-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <i class="fas fa-flag text-blue-600 mr-2"></i>
                    <span class="text-blue-800 font-semibold text-lg"
                      >Country</span
                    >
                  </div>
                  <span
                    class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm"
                    th:text="${summary.entryTypeCount['C']}"
                    >0</span
                  >
                </div>
                <div
                  class="w-full bg-blue-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${summary.entryTypeCount['C'] * 100 / summary.totalEntries} + '%'"
                  ></div>
                </div>
                <div class="text-xs text-blue-600 mt-2 text-center font-medium">
                  <span
                    th:text="${T(java.lang.Math).round(summary.entryTypeCount['C'] * 100.0 / summary.totalEntries)}"
                    >0</span
                  >% of total
                </div>
              </div>

              <!-- Organization -->
              <div
                th:if="${summary.entryTypeCount.containsKey('O')}"
                class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border-2 border-gray-200 hover:shadow-md transition-shadow duration-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <i class="fas fa-building text-gray-600 mr-2"></i>
                    <span class="text-gray-800 font-semibold text-lg"
                      >Organization</span
                    >
                  </div>
                  <span
                    class="bg-gray-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm"
                    th:text="${summary.entryTypeCount['O']}"
                    >0</span
                  >
                </div>
                <div
                  class="w-full bg-gray-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-gray-500 to-gray-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${summary.entryTypeCount['O'] * 100 / summary.totalEntries} + '%'"
                  ></div>
                </div>
                <div class="text-xs text-gray-600 mt-2 text-center font-medium">
                  <span
                    th:text="${T(java.lang.Math).round(summary.entryTypeCount['O'] * 100.0 / summary.totalEntries)}"
                    >0</span
                  >% of total
                </div>
              </div>

              <!-- DC (Domain Component) -->
              <div
                th:if="${summary.entryTypeCount.containsKey('DC')}"
                class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-lg p-4 border-2 border-teal-200 hover:shadow-md transition-shadow duration-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <i class="fas fa-globe text-teal-600 mr-2"></i>
                    <span class="text-teal-800 font-semibold text-lg"
                      >Domain</span
                    >
                  </div>
                  <span
                    class="bg-teal-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm"
                    th:text="${summary.entryTypeCount['DC']}"
                    >0</span
                  >
                </div>
                <div
                  class="w-full bg-teal-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-teal-500 to-teal-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${summary.entryTypeCount['DC'] * 100 / summary.totalEntries} + '%'"
                  ></div>
                </div>
                <div class="text-xs text-teal-600 mt-2 text-center font-medium">
                  <span
                    th:text="${T(java.lang.Math).round(summary.entryTypeCount['DC'] * 100.0 / summary.totalEntries)}"
                    >0</span
                  >% of total
                </div>
              </div>

              <!-- Unknown/Other Types -->
              <div
                th:if="${summary.entryTypeCount.containsKey('UNKNOWN')}"
                class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border-2 border-indigo-200 hover:shadow-md transition-shadow duration-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center">
                    <i class="fas fa-question-circle text-indigo-600 mr-2"></i>
                    <span class="text-indigo-800 font-semibold text-lg"
                      >기타</span
                    >
                  </div>
                  <span
                    class="bg-indigo-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm"
                    th:text="${summary.entryTypeCount['UNKNOWN']}"
                    >0</span
                  >
                </div>
                <div
                  class="w-full bg-indigo-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="bg-gradient-to-r from-indigo-500 to-indigo-600 h-3 rounded-full transition-all duration-1000 ease-out"
                    th:style="'width: ' + ${summary.entryTypeCount['UNKNOWN'] * 100 / summary.totalEntries} + '%'"
                  ></div>
                </div>
                <div
                  class="text-xs text-indigo-600 mt-2 text-center font-medium"
                >
                  <span
                    th:text="${T(java.lang.Math).round(summary.entryTypeCount['UNKNOWN'] * 100.0 / summary.totalEntries)}"
                    >0</span
                  >% of total
                </div>
              </div>
            </div>

            <!-- EntryType Description -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
              <h6 class="text-sm font-semibold text-gray-700 mb-3">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>EntryType
                설명
              </h6>
              <div
                class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-gray-600"
              >
                <div><strong>ML:</strong> Master List - PKD 마스터 목록</div>
                <div>
                  <strong>DSC:</strong> Document Signer Certificate - 문서 서명
                  인증서
                </div>
                <div>
                  <strong>CRL:</strong> Certificate Revocation List - 인증서
                  폐기 목록
                </div>
                <div><strong>C:</strong> Country - 국가 엔트리</div>
                <div><strong>O:</strong> Organization - 조직 엔트리</div>
                <div>
                  <strong>DC:</strong> Domain Component - 도메인 구성요소
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Save to LDAP Button -->
        <div
          th:if="${summary != null and !summary.hasValidationErrors and summary.totalEntries > 0}"
          class="bg-white rounded-lg shadow-md mb-8 overflow-hidden"
        >
          <div
            class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4"
          >
            <h5 class="text-xl font-semibold flex items-center">
              <i class="fas fa-database mr-2"></i> LDAP 저장
            </h5>
          </div>
          <div
            class="p-6"
            hx-ext="sse"
            sse-connect="/ldap-progress/{taskId}(taskId=${taskId})"
            hx-on::sse-error="document.getElementById('connectionAlert').classList.remove('hidden')"
            hx-on::sse-open="document.getElementById('connectionAlert').classList.add('hidden')"
          >
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-500 mr-3 mt-1"></i>
                <div>
                  <h6 class="font-semibold text-blue-900 mb-2">저장 정보</h6>
                  <p class="text-blue-800 text-sm leading-relaxed">
                    분석된 PKD 데이터를 OpenLDAP 서버에 저장합니다.
                    <br />• 총
                    <strong th:text="${summary.totalEntries}">0</strong>개의
                    엔트리가 저장됩니다. <br />• 인증서 및 Master List가
                    포함되어 있습니다. <br />• 저장 중에는 페이지를 닫지 마세요.
                  </p>
                </div>
              </div>
            </div>

            <form
              hx:post="@{/ldif/save-to-ldap/{sessionId}(sessionId=${sessionId})}"
              hx-swap="none"
              hx-disabled-elt=".disable-during-request"
              hx-on::afterRequest="handleLdapSaveResponse(event)"
              class="mb-4"
            >
              <div class="flex items-center space-x-4">
                <button
                  type="submit"
                  id="saveToLdapBtn"
                  class="disable-during-request inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-all duration-200 text-lg shadow-md hover:shadow-lg transform hover:scale-105"
                >
                  <i class="fas fa-save mr-2"></i> LDAP에 저장하기
                </button>

                <button
                  id="cancelTaskBtn"
                  class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-105"
                >
                  <i class="fas fa-times mr-2"></i> 작업 취소
                </button>
              </div>
            </form>

            <!-- LDAP 저장 진행률 표시 영역 (동적 SSE 연결) -->
            <div id="ldapProgressContainer" class="hidden">
              <!-- 이 영역은 JavaScript에서 동적으로 SSE 연결 설정됨 -->
            </div>

            <div id="saveResult" class="mt-4"></div>
          </div>
        </div>
      </div>
    </div>
    <th:block layout:fragment="script-content">
      <script type="text/javascript" th:src="@{/webjars/htmx-ext-sse/dist/sse.js}"></script>
      <script th:inline="javascript">
        const sessionId = /*[[${sessionId}]]*/ "";
        let currentTaskId = null;
        let sseConnected = false;

        document.addEventListener("DOMContentLoaded", function () {
          console.log(
            "Analysis result page loaded with sessionId: ",
            sessionId
          );

          setupEventListeners();
        });

        // 파싱 SSE 관련 함수들 (upload-ldif.html에서 사용)
        function handleParsingSSEError() {
          console.error("Parsing SSE connection error");
          parsingSSEConnected = false;
          showConnectionStatus("파싱 연결 오류", "error");

          // 3초 후 재연결 시도
          setTimeout(() => {
            console.log("Attempting parsing SSE reconnection...");
            reconnectParsingSSE();
          }, 3000);
        }

        function handleParsingSSEOpen() {
          console.log("Parsing SSE connection opened");
          parsingSSEConnected = true;
          showConnectionStatus("파싱 연결됨", "success");
        }

        function startParsingProgress() {
          console.log("Parsing progress started");
          const progressSection = document.getElementById(
            "parsingProgressSection"
          );
          if (progressSection) {
            progressSection.classList.remove("hidden");
          }
        }

        function reconnectParsingSSE() {
          const sseContainer = document.querySelector(
            '[sse-connect*="/parsing-progress/"]'
          );
          if (!sseContainer) {
            console.error("Parsing SSE container not found");
            return;
          }

          try {
            htmx.trigger(sseContainer, "htmx:abort");
            const sseConnect = sseContainer.getAttribute("sse-connect");
            sseContainer.removeAttribute("sse-connect");

            setTimeout(() => {
              sseContainer.setAttribute("sse-connect", sseConnect);
              htmx.process(sseContainer);
              console.log("Parsing SSE reconnection initiated");
            }, 1000);
          } catch (error) {
            console.error("Error during parsing SSE reconnection:", error);
          }
        }

        // LDAP 저장 SSE 관련 함수들 (analysis-result.html에서 사용)
        function setupEventListeners() {
          // LDAP 저장 버튼 이벤트
          const saveBtn = document.getElementById("saveToLdapBtn");
          if (saveBtn) {
            saveBtn.addEventListener("click", function () {
              console.log("LDAP save button clicked");
              handleSaveButtonClick(this);
            });
          }

          // 취소 버튼 이벤트
          const cancelBtn = document.getElementById("cancelTaskBtn");
          if (cancelBtn) {
            cancelBtn.addEventListener("click", function () {
              cancelSaveProcess();
            });
          }
        }

        function handleLdapSaveResponse(event) {
          try {
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.success && response.taskId) {
              console.log("LDAP save task started:", response.taskId);
              currentTaskId = response.taskId;
              setupLdapSSEConnection(response.taskId);
            } else {
              console.error(
                "LDAP save task failed to start:",
                response.message
              );
              handleSaveError(response.message || "LDAP 저장 시작 실패");
            }
          } catch (e) {
            console.error("Error parsing LDAP save response:", e);
            handleSaveError("응답 파싱 오류");
          }
        }

        function setupLdapSSEConnection(taskId) {
          const container = document.getElementById("ldapProgressContainer");
          if (!container) {
            console.error("LDAP progress container not found");
            return;
          }

          console.log("Setting up LDAP SSE connection for task:", taskId);

          // 동적으로 LDAP 진행률 SSE 연결 설정
          container.innerHTML = `
        <div hx-ext="sse"
             sse-connect="/ldap-progress/${taskId}"
             hx-on::sse-error="handleLdapSSEError()"
             hx-on::sse-open="handleLdapSSEOpen()"
             hx-on::sse-message="handleLdapSSEMessage(event)">
             
            <div id="ldapProgressSection" 
                 sse-swap="ldap-progress"
                 class="mt-6">
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 border border-indigo-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-indigo-800 font-semibold text-lg">LDAP 저장 준비 중...</span>
                        <span class="text-indigo-700 font-bold text-lg">0%</span>
                    </div>
                    <div class="w-full bg-indigo-100 rounded-full h-6 overflow-hidden shadow-inner">
                        <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 h-6 rounded-full transition-all duration-300" 
                             style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div id="ldapLogSection" 
                 sse-swap="ldap-log"
                 class="mt-4 hidden max-h-40 overflow-y-auto bg-gray-900 text-green-400 p-3 rounded font-mono text-sm">
                <!-- LDAP 저장 로그가 여기에 삽입됨 -->
            </div>
        </div>
    `;

          container.classList.remove("hidden");

          // HTMX 재처리하여 새로운 SSE 연결 활성화
          htmx.process(container);
          console.log("LDAP SSE connection setup completed");
        }

        function handleLdapSSEError() {
          console.error("LDAP SSE connection error");
          ldapSSEConnected = false;
          showConnectionStatus("LDAP 저장 연결 오류", "error");

          // 3초 후 재연결 시도
          setTimeout(() => {
            if (currentTaskId) {
              console.log(
                "Attempting LDAP SSE reconnection for task:",
                currentTaskId
              );
              reconnectLdapSSE(currentTaskId);
            }
          }, 3000);
        }

        function handleLdapSSEOpen() {
          console.log("LDAP SSE connection opened");
          ldapSSEConnected = true;
          showConnectionStatus("LDAP 저장 연결됨", "success");
        }

        function handleLdapSSEMessage(event) {
          console.log("LDAP SSE message received:", event.detail);

          // 연결 확인 메시지 처리
          if (event.detail.type === "connection-established") {
            console.log("LDAP SSE connection confirmed");
            return;
          }
        }

        function reconnectLdapSSE(taskId) {
          const sseContainer = document.querySelector(
            `[sse-connect*="/ldap-progress/${taskId}"]`
          );
          if (!sseContainer) {
            console.error("LDAP SSE container not found for task:", taskId);
            return;
          }

          try {
            htmx.trigger(sseContainer, "htmx:abort");
            const sseConnect = sseContainer.getAttribute("sse-connect");
            sseContainer.removeAttribute("sse-connect");

            setTimeout(() => {
              sseContainer.setAttribute("sse-connect", sseConnect);
              htmx.process(sseContainer);
              console.log("LDAP SSE reconnection initiated for task:", taskId);
            }, 1000);
          } catch (error) {
            console.error("Error during LDAP SSE reconnection:", error);
          }
        }

        function handleSaveButtonClick(button) {
          console.log("LDAP save button clicked");
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i> 저장 준비 중...';

          const cancelBtn = document.getElementById("cancelTaskBtn");
          if (cancelBtn) {
            cancelBtn.classList.remove("hidden");
          }

          const saveResult = document.getElementById("saveResult");
          if (saveResult) {
            saveResult.innerHTML = "";
          }
        }

        function cancelSaveProcess() {
          console.log("Cancel LDAP save process requested");

          const cancelBtn = document.getElementById("cancelTaskBtn");
          if (cancelBtn) {
            cancelBtn.disabled = true;
            cancelBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin mr-2"></i> 취소 중...';
          }

          if (currentTaskId) {
            fetch(`/ldif/cancel-task?taskId=${currentTaskId}`, {
              method: "GET",
            })
              .then((response) => response.json())
              .then((data) => {
                console.log("Cancel response:", data);
                if (data.success) {
                  handleCancelSuccess();
                } else {
                  handleCancelError(data.message);
                }
              })
              .catch((error) => {
                console.error("Cancel error:", error);
                handleCancelError("취소 요청 실패");
              });
          }
        }

        function handleCancelSuccess() {
          resetLdapUI();
          showToast("LDAP 저장 작업이 취소되었습니다.", "info");
        }

        function handleCancelError(message) {
          const cancelBtn = document.getElementById("cancelTaskBtn");
          if (cancelBtn) {
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i> 작업 취소';
          }
          showToast("취소 실패: " + message, "error");
        }

        function handleSaveError(message) {
          const saveResult = document.getElementById("saveResult");
          if (saveResult) {
            saveResult.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 animate-fadeIn">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3 text-2xl mt-1"></i>
                    <div class="flex-1">
                        <div class="text-red-800 font-bold text-lg mb-2">LDAP 저장 실패</div>
                        <div class="text-red-700 mb-3">${message}</div>
                    </div>
                </div>
            </div>
        `;
          }
          resetLdapUI();
        }

        function resetLdapUI() {
          const saveBtn = document.getElementById("saveToLdapBtn");
          const cancelBtn = document.getElementById("cancelTaskBtn");
          const progressContainer = document.getElementById(
            "ldapProgressContainer"
          );

          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML =
              '<i class="fas fa-save mr-2"></i> LDAP에 저장하기';
          }

          if (cancelBtn) {
            cancelBtn.classList.add("hidden");
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i> 작업 취소';
          }

          if (progressContainer) {
            progressContainer.classList.add("hidden");
          }

          currentTaskId = null;
        }

        function showConnectionStatus(message, type) {
          // 기존 상태 메시지 제거
          const existingStatus = document.getElementById("connectionStatus");
          if (existingStatus) {
            existingStatus.remove();
          }

          // 새로운 상태 메시지 생성
          const statusDiv = document.createElement("div");
          statusDiv.id = "connectionStatus";
          statusDiv.className = `fixed top-4 left-4 z-50 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300 ${
            type === "success"
              ? "bg-green-100 text-green-800 border border-green-200"
              : type === "error"
              ? "bg-red-100 text-red-800 border border-red-200"
              : type === "warning"
              ? "bg-yellow-100 text-yellow-800 border border-yellow-200"
              : "bg-blue-100 text-blue-800 border border-blue-200"
          }`;

          statusDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
              type === "success"
                ? "fa-check-circle"
                : type === "error"
                ? "fa-exclamation-circle"
                : type === "warning"
                ? "fa-exclamation-triangle"
                : "fa-info-circle"
            } mr-2"></i>
            SSE ${message}
        </div>
    `;

          document.body.appendChild(statusDiv);

          // 3초 후 자동 제거 (성공 메시지인 경우)
          if (type === "success") {
            setTimeout(() => {
              if (statusDiv && statusDiv.parentNode) {
                statusDiv.remove();
              }
            }, 3000);
          }
        }

        function showToast(message, type = "success") {
          const event = new CustomEvent("show-toast", {
            detail: { message, type },
          });
          document.dispatchEvent(event);
        }

        // Toast notification system
        document.addEventListener("show-toast", function (e) {
          const toast = document.createElement("div");
          toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full ${
            e.detail.type === "success"
              ? "bg-green-600"
              : e.detail.type === "info"
              ? "bg-blue-600"
              : "bg-red-600"
          }`;
          toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
              e.detail.type === "success"
                ? "fa-check"
                : e.detail.type === "info"
                ? "fa-info-circle"
                : "fa-exclamation-triangle"
            } mr-2"></i>
            ${e.detail.message}
        </div>
    `;

          document.body.appendChild(toast);

          // Show toast
          setTimeout(() => {
            toast.classList.remove("translate-x-full");
          }, 100);

          // Hide toast after 3 seconds
          setTimeout(() => {
            toast.classList.add("translate-x-full");
            setTimeout(() => {
              if (document.body.contains(toast)) {
                document.body.removeChild(toast);
              }
            }, 300);
          }, 3000);
        });

        // Handle beforeunload
        window.addEventListener("beforeunload", function () {
          console.log(
            "Page unloading, SSE connections will be automatically closed"
          );
        });
      </script>
      <style>
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }

        /* Custom scrollbar for tables and modals */
        .overflow-x-auto::-webkit-scrollbar,
        .overflow-y-auto::-webkit-scrollbar {
          height: 8px;
          width: 8px;
        }

        .overflow-x-auto::-webkit-scrollbar-track,
        .overflow-y-auto::-webkit-scrollbar-track {
          background: #f1f5f9;
          border-radius: 4px;
        }

        .overflow-x-auto::-webkit-scrollbar-thumb,
        .overflow-y-auto::-webkit-scrollbar-thumb {
          background: #cbd5e1;
          border-radius: 4px;
        }

        .overflow-x-auto::-webkit-scrollbar-thumb:hover,
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
          background: #94a3b8;
        }

        /* Enhanced hover effects for cards */
        .hover\:shadow-xl:hover {
          transform: translateY(-2px);
        }

        .hover\:scale-105:hover {
          transform: scale(1.05);
        }

        /* Loading spinner animation */
        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }

        .animate-spin {
          animation: spin 1s linear infinite;
        }
      </style>
    </th:block>
  </body>
</html>
