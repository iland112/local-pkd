<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}"
>
  <body>
    <div layout:fragment="content">
      <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="flex justify-center">
          <div class="w-full">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
              <!-- í˜ì´ì§€ í—¤ë” -->
              <div class="bg-blue-600 text-white px-6 py-4">
                <h1 class="text-2xl font-bold flex items-center gap-3">
                  <i class="fas fa-file-upload text-blue-200"></i>
                  ICAO CSCA Master List ì—…ë¡œë“œ
                </h1>
                <p class="text-blue-100 text-sm mt-2">
                  Master List íŒŒì¼(.ml)ì„ ì—…ë¡œë“œí•˜ê³  ì¤‘ë³µ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                </p>
              </div>

              <!-- ë³¸ë¬¸ -->
              <div class="p-6">
                <!-- Alert Messages -->
                <div
                  th:if="${error}"
                  class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-md auto-hide-alert"
                >
                  <div class="flex items-center">
                    <i
                      class="fas fa-exclamation-triangle text-red-500 mr-3"
                    ></i>
                    <div class="flex-1">
                      <span th:text="${error}" class="text-red-700"></span>
                    </div>
                    <button
                      type="button"
                      class="text-red-400 hover:text-red-600 transition-colors alert-close-btn"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <!-- Success Message -->
                <div
                  th:if="${success}"
                  class="mb-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-md auto-hide-alert"
                >
                  <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-3"></i>
                    <div class="flex-1">
                      <span th:text="${success}" class="text-green-700"></span>
                    </div>
                    <button
                      type="button"
                      class="text-green-400 hover:text-green-600 transition-colors alert-close-btn"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <!-- LD ì—°ê²° í…ŒìŠ¤íŠ¸ -->
                <div class="mb-6">
                  <button
                    id="testConnectionBtn"
                    class="bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100 hover:border-blue-300 px-4 py-2 rounded-md font-medium transition-all duration-200 flex items-center gap-2"
                  >
                    <i class="fas fa-plug"></i> LDAP ì—°ê²° í…ŒìŠ¤íŠ¸
                  </button>
                  <div id="connectionResult" class="mt-3"></div>
                </div>

                <!-- File Upload Form -->
                <div
                  class="mb-6"
                  hx-ext="sse"
                  sse-connect="/progress"
                  hx-on::sse-error="handleSseError()"
                  hx-on::sse-open="handleSseOpen()"
                >
                  <form
                    class="space-y-4"
                    hx-encoding="multipart/form-data"
                    hx-post="/icao/ml/upload"
                    hx-disabled-elt=".disable-during-request"
                    hx-target="#results-container"
                    hx-swap="innerHTML"
                    hx-on::before-request="beforeUpload()"
                    hx-on::after-request="afterUpload()"
                  >
                    <div class="flex flex-col lg:flex-row gap-4 items-end">
                      <div class="flex-1">
                        <label
                          for="file"
                          class="block text-sm font-medium text-gray-700 mb-2"
                        >
                          <i class="fas fa-file text-blue-500 mr-2"></i> Master
                          List íŒŒì¼ ì„ íƒ
                        </label>
                        <input
                          id="file"
                          type="file"
                          name="file"
                          accept=".ml"
                          class="file-input file-input-bordered w-full disable-during-request"
                          required
                        />
                        <div
                          id="fileInfo"
                          class="mt-2 text-sm text-gray-600 hidden"
                        >
                          <i
                            class="fas fa-check-circle text-green-500 mr-1"
                          ></i>
                          <span id="fileName"></span>
                          <span id="fileSize" class="ml-2 text-gray-400"></span>
                        </div>
                        <p class="mt-2 text-sm text-gray-600">
                          ICAO Master List íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                      </div>
                      <div>
                        <button
                          id="upload-button"
                          type="submit"
                          class="btn btn-dash btn-primary disable-during-request"
                        >
                          <i class="fas fa-upload"></i> íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„
                        </button>
                      </div>
                    </div>
                  </form>

                  <!-- ì§„í–‰ ìƒí™© í‘œì‹œ ì˜ì—­ -->
                  <div id="progress-container" class="mt-6 space-y-4">
                    <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                    <div
                      class="card bg-base-100 shadow-sm"
                      id="progress-card"
                      style="display: none"
                    >
                      <div class="card-body">
                        <h3 class="card-title text-lg">
                          <i
                            class="fas fa-spinner animate-spin text-blue-600"
                          ></i>
                          Master List ë¶„ì„ ì§„í–‰ ìƒí™©
                        </h3>
                        <div
                          sse-swap="progress-update"
                          id="progress-update"
                        ></div>
                        <div sse-swap="status-update" id="status-update"></div>
                      </div>
                    </div>

                    <!-- ë¡œê·¸ ì˜ì—­ -->
                    <div
                      class="card bg-base-100 shadow-sm"
                      id="log-card"
                      style="display: none"
                    >
                      <div class="card-body">
                        <h3 class="card-title text-lg">
                          <i class="fas fa-list-ul text-green-600"></i>
                          ë¶„ì„ ë¡œê·¸
                        </h3>
                        <div
                          id="log-update"
                          class="p-3 h-64 font-mono text-xs bg-gray-900 text-green-400 overflow-y-auto rounded-md border"
                          sse-swap="log-update"
                          hx-swap="beforeend"
                          hx-on::after-settle="this.scrollTo(0, this.scrollHeight);"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                <div id="results-container" class="mt-6">
                  <!-- ì—…ë¡œë“œ ë° ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>

                <!-- ì£¼ìš” ê¸°ëŠ¥ ì†Œê°œ -->
                <div class="mt-8">
                  <h5 class="text-lg font-semibold text-gray-800 mb-4">
                    ì£¼ìš” ê¸°ëŠ¥
                  </h5>
                  <div
                    class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200"
                  >
                    <div
                      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                    >
                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-search text-blue-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >Master List íŒŒì¼ êµ¬ë¬¸ ë¶„ì„ ë° ê²€ì¦</span
                        >
                      </div>
                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-shield-alt text-green-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >ë””ì§€í„¸ ì„œëª… ê²€ì¦</span
                        >
                      </div>
                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-cyan-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-database text-cyan-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >OpenLDAP ì„œë²„ ì§ì ‘ ì €ì¥</span
                        >
                      </div>
                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-certificate text-purple-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >X.509 ì¸ì¦ì„œ ìœ íš¨ì„± ê²€ì¦</span
                        >
                      </div>
                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-chart-bar text-yellow-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >ì‹¤ì‹œê°„ í†µê³„ ë° ë¶„ì„ ê²°ê³¼</span
                        >
                      </div>
                      <div
                        class="flex items-center gap-3 py-3 px-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div
                          class="flex-shrink-0 w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center"
                        >
                          <i class="fas fa-bolt text-indigo-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium"
                          >ì‹¤ì‹œê°„ ì§„í–‰ë¥  í‘œì‹œ</span
                        >
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ì‹œìŠ¤í…œ ìš”êµ¬ ì‚¬í•­ -->
                <div
                  class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <h6 class="text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>ì‹œìŠ¤í…œ
                    ìš”êµ¬ì‚¬í•­
                  </h6>
                  <ul class="text-sm text-gray-600 space-y-1">
                    <li>â€¢ ìµœëŒ€ íŒŒì¼ í¬ê¸°: 100MB</li>
                    <li>
                      â€¢ ì§€ì› í˜•ì‹: ml í™•ì¥ìë¥¼ ê°€ì§„ SignedData (CMS,
                      Cryptographic Message Syntax) í˜•ì‹
                    </li>
                    <li>â€¢ ê¶Œì¥ ë¸Œë¼ìš°ì €: Chrome, Firefox, Safari</li>
                  </ul>
                </div>
              </div>

              <!-- Footer -->
              <div class="text-center mt-8 text-gray-500 text-sm">
                <p>
                  Â© 2025 ICAO Master List File Manager. ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ LDAP
                  ë°ì´í„° ê´€ë¦¬.
                </p>
                <p class="mt-1">
                  <i class="fas fa-shield-alt text-green-500 mr-1"></i>
                  SSL ì•”í˜¸í™” ë° ì•ˆì „í•œ ë°ì´í„° ì²˜ë¦¬
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì¤‘ë³µ íŒŒì¼ ê²½ê³  ëª¨ë‹¬ -->
      <div id="duplicateWarningModal" class="modal">
        <div class="modal-box max-w-2xl">
          <h3 class="font-bold text-lg flex items-center">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
            ì¤‘ë³µ íŒŒì¼ ê°ì§€
          </h3>

          <div class="py-4">
            <p class="text-gray-700 mb-4" id="duplicateMessage"></p>

            <div class="bg-gray-50 p-4 rounded-lg mb-4">
              <h4 class="font-semibold mb-3 text-gray-800">ê¸°ì¡´ ì—…ë¡œë“œ ì •ë³´:</h4>
              <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <dt class="text-gray-600 font-medium">íŒŒì¼ëª…:</dt>
                <dd id="existingFilename" class="font-mono text-gray-900">-</dd>

                <dt class="text-gray-600 font-medium">ì—…ë¡œë“œ ë‚ ì§œ:</dt>
                <dd id="existingUploadDate" class="text-gray-900">-</dd>

                <dt class="text-gray-600 font-medium">ë²„ì „:</dt>
                <dd id="existingVersion" class="font-mono text-gray-900">-</dd>

                <dt class="text-gray-600 font-medium">ìƒíƒœ:</dt>
                <dd id="existingStatus" class="text-gray-900">-</dd>
              </dl>
            </div>

            <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-2">
              <h5 class="font-semibold text-sm text-blue-800 mb-1">ê²½ê³  ìœ í˜•:</h5>
              <p id="warningTypeInfo" class="text-sm"></p>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
              <h5 class="font-semibold text-sm text-yellow-800 mb-1">ì¶”ê°€ ì •ë³´:</h5>
              <p id="additionalInfo" class="text-sm text-gray-700"></p>
            </div>
          </div>

          <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeDuplicateModal()">
              <i class="fas fa-times mr-1"></i> ì·¨ì†Œ
            </button>
            <a class="btn btn-outline btn-info" id="viewHistoryBtn" href="#" target="_blank">
              <i class="fas fa-history mr-1"></i> ê¸°ì¡´ ì´ë ¥ ë³´ê¸°
            </a>
            <button class="btn btn-primary" id="forceUploadBtn" onclick="forceUpload()">
              <i class="fas fa-upload mr-1"></i> ê°•ì œ ì—…ë¡œë“œ
            </button>
          </div>
        </div>
      </div>
    </div>
    <th:block layout:fragment="script-content">
      <script type="text/javascript" th:src="@{/webjars/htmx-ext-sse/dist/sse.js}"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
      <script>
        // ì „ì—­ ë³€ìˆ˜ (ê°œì„ ëœ ìƒíƒœ ê´€ë¦¬)
        let isUploading = false;
        let sseRetryCount = 0;
        let maxRetryAttempts = 3;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener("DOMContentLoaded", function () {
            console.log("ML page loaded");

            // ìë™ ì•Œë¦¼ ìˆ¨ê¹€ ì²˜ë¦¬
            setupAutoHideAlerts();

            // íŒŒì¼ í¬ê¸° ê²€ì¦ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupFileSizeValidation();
        });

        // LDAP ì—°ê²° í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ (ê°œì„ ëœ ë²„ì „)
        document
          .getElementById("testConnectionBtn")
          .addEventListener("click", function () {
            const btn = this;
            const resultDiv = document.getElementById("connectionResult");

            btn.disabled = true;
            btn.innerHTML =
              '<i class="fas fa-spinner animate-spin mr-2"></i>í…ŒìŠ¤íŠ¸ì¤‘...';
            btn.classList.add("opacity-75", "cursor-not-allowed");

            fetch("/ldap-test-connection")
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  resultDiv.innerHTML = `
                  <div class="p-4 bg-green-50 border-l-4 border-green-500 rounded-md animate-fadeIn">
                    <div class="flex items-center">
                      <i class="fas fa-check text-green-500 mr-3"></i>
                      <span class="text-green-700 font-medium">${data.message}</span>
                    </div>
                  </div>
                `;
                } else {
                  resultDiv.innerHTML = `
                  <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-md animate-fadeIn">
                    <div class="flex items-center">
                      <i class="fas fa-times text-red-500 mr-3"></i>
                      <span class="text-red-700 font-medium">${data.message}</span>
                    </div>
                  </div>
                `;
                }
              })
              .catch((error) => {
                resultDiv.innerHTML = `
                <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-md animate-fadeIn">
                  <div class="flex items-center">
                    <i class="fas fa-times text-red-500 mr-3"></i>
                    <span class="text-red-700 font-medium">ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</span>
                  </div>
                </div>
              `;
              })
              .finally(() => {
                btn.disabled = false;
                btn.innerHTML =
                  '<i class="fas fa-plug mr-2"></i>LDAP ì—°ê²° í…ŒìŠ¤íŠ¸';
                btn.classList.remove("opacity-75", "cursor-not-allowed");
              });
          });

        // íŒŒì¼ ì…ë ¥ ê¸°ëŠ¥ í–¥ìƒ
        document.getElementById("file").addEventListener("change", function () {
          const file = this.files[0];
          const fileInfo = document.getElementById("fileInfo");
          const fileName = document.getElementById("fileName");
          const fileSize = document.getElementById("fileSize");

          if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = `(${formatFileSize(file.size)})`;
            fileInfo.classList.remove("hidden");

            // íŒŒì¼ í™•ì¥ì ìœ íš¨ì„± ê²€ì‚¬
            if (!file.name.toLowerCase().endsWith(".ml")) {
              showFileError(".ml í™•ì¥ì íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              this.value = "";
              fileInfo.classList.add("hidden");
            }
          } else {
            fileInfo.classList.add("hidden");
          }
        });

        // ì—…ë¡œë“œ ì „ ì²˜ë¦¬
        function beforeUpload() {
          if (isUploading) {
            return false;
          }

          isUploading = true;
          const btn = document.getElementById('upload-button');
          btn.disabled = true;
          btn.innerHTML =
            '<i class="fas fa-spinner animate-spin mr-2"></i>ë¶„ì„ ì¤‘...';

          // ì§„í–‰ ìƒí™© ì¹´ë“œ í‘œì‹œ
          document.getElementById("progress-card").style.display = "block";
          document.getElementById("log-card").style.display = "block";

          // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
          document.getElementById("results-container").innerHTML = "";

          showNotification("íŒŒì¼ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...", "info");
        }

        // ì—…ë¡œë“œ í›„ ì²˜ë¦¬
        function afterUpload() {
          isUploading = false;
          const btn = document.getElementById('upload-button');

          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-upload mr-2"></i>íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„';

          showNotification("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        }

        // SSE ì—°ê²° ìƒíƒœ ì²˜ë¦¬
        function handleSseError() {
          console.warn("SSE ì—°ê²° ì˜¤ë¥˜ - HTMXê°€ ìë™ìœ¼ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.");
          showNotification(
            "SSE ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...",
            "warning"
          );
        }

        function handleSseOpen() {
          console.log("SSE ì—°ê²° ì„±ê³µ");
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·í„°
        function formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        // íŒŒì¼ ì—ëŸ¬ í‘œì‹œ
        function showFileError(message) {
          const errorDiv = document.createElement("div");
          errorDiv.className =
            "mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-700 animate-fadeIn";
          errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${message}`;

          const fileInput = document.getElementById("file");
          fileInput.parentNode.insertBefore(errorDiv, fileInput.nextSibling);

          setTimeout(() => {
            errorDiv.remove();
          }, 3000);
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = "info") {
          const colors = {
            info: "bg-blue-50 border-blue-200 text-blue-700",
            success: "bg-green-50 border-green-200 text-green-700",
            warning: "bg-yellow-50 border-yellow-200 text-yellow-700",
            error: "bg-red-50 border-red-200 text-red-700",
          };

          const icons = {
            info: "fas fa-info-circle",
            success: "fas fa-check-circle",
            warning: "fas fa-exclamation-triangle",
            error: "fas fa-times-circle",
          };

          const notification = document.createElement("div");
          notification.className = `fixed top-4 right-4 p-4 rounded-lg border ${colors[type]} shadow-lg z-50 animate-slideIn max-w-md`;
          notification.innerHTML = `
            <div class="flex items-center">
              <i class="${icons[type]} mr-2"></i>
              <span class="flex-1">${message}</span>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-75">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;

          document.body.appendChild(notification);

          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 5000);
        }

        // í†µê³„ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadStatistics() {
          fetch("/icao/ml/statistics")
            .then((response) => response.json())
            .then((data) => {
              const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: "application/json",
              });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = `csca-statistics-${
                new Date().toISOString().split("T")[0]
              }.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
              showNotification("í†µê³„ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            })
            .catch((error) => {
              showNotification(
                "í†µê³„ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
                "error"
              );
            });
        }

        // ìƒì„¸ ë³´ê³ ì„œ ë³´ê¸°
        function viewDetailedReport() {
          fetch("/icao/ml/statistics")
            .then((response) => response.json())
            .then((data) => {
              showDetailedReportModal(data);
            })
            .catch((error) => {
              showNotification("ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            });
        }

        // êµ­ê°€ ì½”ë“œë¥¼ êµ­ê¸° ì´ëª¨ì§€ë¡œ ë³€í™˜
        function getCountryFlag(countryCode) {
          if (!countryCode || countryCode.length !== 2) return 'ğŸ³ï¸';
          
          const codePoints = countryCode
            .toUpperCase()
            .split('')
            .map(char => 127397 + char.charCodeAt());
          
          return String.fromCodePoint(...codePoints);
        }

        // êµ­ê°€ë³„ ì°¨íŠ¸ ìƒì„±
        function createCountryChart(countryData) {
          const ctx = document.getElementById('countryChart');
          if (!ctx) return;

          const entries = Object.entries(countryData)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10); // ìƒìœ„ 10ê°œ êµ­ê°€ë§Œ í‘œì‹œ

          const labels = entries.map(([country]) => country);
          const data = entries.map(([,count]) => count);
          const backgroundColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
            '#4BC0C0', '#FF6384'
          ];

          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const country = context.label;
                      const count = context.parsed;
                      const flag = getCountryFlag(country);
                      const percentage = ((count / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                      return `${flag} ${country}: ${count}ê°œ (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });

          // ë²”ë¡€ ìƒì„±
          const legendContainer = document.getElementById('countryLegend');
          if (legendContainer) {
            legendContainer.innerHTML = entries.map(([country, count], index) => {
              const flag = getCountryFlag(country);
              const percentage = ((count / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
              const color = backgroundColors[index];
              
              return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${color}"></div>
                    <span class="text-2xl">${flag}</span>
                    <span class="font-medium text-gray-800">${country}</span>
                  </div>
                  <div class="text-right">
                    <div class="font-bold text-gray-900">${count}</div>
                    <div class="text-sm text-gray-500">${percentage}%</div>
                  </div>
                </div>
              `;
            }).join('');
          }
        }

        // ìƒì„¸ ë³´ê³ ì„œ ëª¨ë‹¬ í‘œì‹œ
        function showDetailedReportModal(data) {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
          modal.innerHTML = `
            <div class="bg-white rounded-lg max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold">CSCA Master List ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ</h3>
                  <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
                <div class="space-y-6">
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">ë¶„ì„ ìš”ì•½</h4>
                    <p class="text-gray-700">${data.summary || "N/A"}</p>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <h4 class="font-semibold text-blue-800">ì´ ì¸ì¦ì„œ ìˆ˜</h4>
                      <p class="text-2xl font-bold text-blue-600">${
                        data.totalCertificates || 0
                      }</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                      <h4 class="font-semibold text-green-800">ìœ íš¨ìœ¨</h4>
                      <p class="text-2xl font-bold text-green-600">${(data.validityRate || 0).toFixed(
                        1
                      )}%</p>
                    </div>
                  </div>
                  <div class="bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">
                      <i class="fas fa-globe text-blue-600"></i>
                      êµ­ê°€ë³„ ì¸ì¦ì„œ í˜„í™©
                    </h4>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <div class="relative h-80">
                        <canvas id="countryChart"></canvas>
                      </div>
                      <div class="space-y-2 max-h-80 overflow-y-auto">
                        <div id="countryLegend" class="grid grid-cols-1 gap-2"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          
          // ì°¨íŠ¸ ìƒì„±
          setTimeout(() => {
            createCountryChart(data.countByCountry || {});
          }, 100);
        }

        // LDIF ë‚´ë³´ë‚´ê¸°
        function exportToLdif() {
          showNotification("LDIF ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.", "info");
          // TODO: LDIF ë‚´ë³´ë‚´ê¸° API êµ¬í˜„ í›„ ì—°ê²°
        }

        // íŒŒì¼ í¬ê¸° ê²€ì¦ ì„¤ì • (ê°œì„ ëœ ë²„ì „ + ì¤‘ë³µ ì²´í¬)
        function setupFileSizeValidation() {
            const fileInput = document.getElementById("file");
            if (!fileInput) return;

            fileInput.addEventListener("change", async function () {
                const file = this.files[0];
                const fileInfo = document.getElementById("fileInfo");
                const fileName = document.getElementById("fileName");
                const fileSize = document.getElementById("fileSize");
                const maxSize = 100 * 1024 * 1024; // 100MB

                if (file) {
                    // íŒŒì¼ í¬ê¸° ê²€ì¦
                    if (file.size > maxSize) {
                        showFileError(`íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ í¬ê¸°ëŠ” ${formatFileSize(maxSize)}ì…ë‹ˆë‹¤.`);
                        this.value = "";
                        fileInfo.classList.add("hidden");
                        return;
                    }

                    // íŒŒì¼ í™•ì¥ì ê²€ì¦
                    if (!file.name.toLowerCase().endsWith(".ml")) {
                        showFileError(".ml í™•ì¥ì íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                        this.value = "";
                        fileInfo.classList.add("hidden");
                        return;
                    }

                    fileName.textContent = file.name;
                    fileSize.textContent = `(${formatFileSize(file.size)})`;
                    fileInfo.classList.remove("hidden");

                    // ê¸°ì¡´ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
                    removeExistingFileErrors();

                    // ì¤‘ë³µ ì²´í¬ ìˆ˜í–‰
                    await checkDuplicateBeforeUpload(file);
                } else {
                    fileInfo.classList.add("hidden");
                }
            });
        }

        // ê¸°ì¡´ íŒŒì¼ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
        function removeExistingFileErrors() {
            const existingErrors = document.querySelectorAll(".file-error");
            existingErrors.forEach(error => error.remove());
        }

        // ê°œì„ ëœ íŒŒì¼ ì˜¤ë¥˜ í‘œì‹œ
        function showFileError(message) {
            // ê¸°ì¡´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
            removeExistingFileErrors();

            const errorDiv = document.createElement("div");
            errorDiv.className = "mt-2 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 animate-fadeIn file-error";
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                    <span>${message}</span>
                    <button type="button" class="ml-auto text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            const fileInput = document.getElementById("file");
            fileInput.parentNode.appendChild(errorDiv);

            // 10ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    fadeOutElement(errorDiv);
                }
            }, 10000);
        }

        // ìë™ ì•Œë¦¼ ìˆ¨ê¹€ ì„¤ì • (ê°œì„ ëœ ë²„ì „)
        function setupAutoHideAlerts() {
            const alerts = document.querySelectorAll(".auto-hide-alert");

            alerts.forEach((alert) => {
                // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                const closeBtn = alert.querySelector(".alert-close-btn");
                if (closeBtn) {
                    closeBtn.addEventListener("click", () => fadeOutElement(alert));
                }

                // ìë™ ìˆ¨ê¹€ (ì„±ê³µ ë©”ì‹œì§€ëŠ” 5ì´ˆ, ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” 10ì´ˆ)
                const isError = alert.classList.contains("border-red-500");
                const timeout = isError ? 10000 : 5000;

                setTimeout(() => {
                    if (alert.parentNode) {
                        fadeOutElement(alert);
                    }
                }, timeout);
            });
        }

        // ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œ ì•„ì›ƒ íš¨ê³¼
        function fadeOutElement(element) {
            if (!element) return;

            element.style.opacity = "0";
            element.style.transform = "translateY(-10px)";
            element.style.transition = "all 0.3s ease-out";

            setTimeout(() => {
                if (element.parentNode) {
                    element.remove();
                }
            }, 300);
        }

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                console.log("Page hidden - SSE may be paused by browser");
            } else {
                console.log("Page visible - SSE should resume");
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ê³  ì—…ë¡œë“œê°€ ì§„í–‰ ì¤‘ì´ë©´ ì—°ê²° ìƒíƒœ í™•ì¸
                if (isUploading && sseRetryCount < maxRetryAttempts) {
                    console.log("Checking SSE connection after page visibility change");
                }
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener("beforeunload", function() {
            isUploading = false;
            console.log("Page unloading, cleaning up...");
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener("keydown", function (e) {
          // Ctrl + U: íŒŒì¼ ì„ íƒ
          if (e.ctrlKey && e.key === "u") {
            e.preventDefault();
            document.getElementById("file").click();
          }

          // Escape: ëª¨ë‹¬ ë‹«ê¸°
          if (e.key === "Escape") {
            const modal = document.querySelector(".fixed.inset-0");
            if (modal) {
              modal.remove();
            }
          }
        });

        // ====== ì¤‘ë³µ íŒŒì¼ ì²´í¬ ê¸°ëŠ¥ ======

        // SHA-256 í•´ì‹œ ê³„ì‚° (ë¸Œë¼ìš°ì € Web Crypto API ì‚¬ìš©)
        async function calculateFileHashSHA256(file) {
            try {
                const buffer = await file.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error('Error calculating file hash:', error);
                throw error;
            }
        }

        // ì¤‘ë³µ íŒŒì¼ ì²´í¬
        async function checkDuplicateBeforeUpload(file) {
            try {
                console.log('Starting duplicate check for:', file.name);

                // í•´ì‹œ ê³„ì‚° ì¤‘ í‘œì‹œ
                showDuplicateCheckProgress('íŒŒì¼ í•´ì‹œ ê³„ì‚° ì¤‘...');

                const fileHash = await calculateFileHashSHA256(file);
                console.log('File hash calculated:', fileHash);

                // ì¤‘ë³µ ê²€ì‚¬ ì¤‘ í‘œì‹œ
                showDuplicateCheckProgress('ì¤‘ë³µ íŒŒì¼ ê²€ì‚¬ ì¤‘...');

                const response = await fetch('/api/duplicate-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        fileSize: file.size,
                        fileHash: fileHash
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Duplicate check result:', result);

                // ì§„í–‰ í‘œì‹œ ì œê±°
                removeDuplicateCheckProgress();

                if (result.isDuplicate) {
                    showDuplicateWarningModal(result);
                    return false;
                }

                return true;

            } catch (error) {
                console.error('Error checking duplicate:', error);
                removeDuplicateCheckProgress();
                showNotification('ì¤‘ë³µ ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                return true; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì—…ë¡œë“œ í—ˆìš©
            }
        }

        // ì¤‘ë³µ ì²´í¬ ì§„í–‰ í‘œì‹œ
        function showDuplicateCheckProgress(message) {
            removeDuplicateCheckProgress(); // ê¸°ì¡´ ì§„í–‰ í‘œì‹œ ì œê±°

            const progressDiv = document.createElement('div');
            progressDiv.id = 'duplicate-check-progress';
            progressDiv.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 animate-fadeIn';
            progressDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-spinner animate-spin mr-2 text-blue-500"></i>
                    <span>${message}</span>
                </div>
            `;

            const fileInput = document.getElementById('file');
            fileInput.parentNode.appendChild(progressDiv);
        }

        // ì¤‘ë³µ ì²´í¬ ì§„í–‰ í‘œì‹œ ì œê±°
        function removeDuplicateCheckProgress() {
            const progress = document.getElementById('duplicate-check-progress');
            if (progress) {
                progress.remove();
            }
        }

        // ì¤‘ë³µ íŒŒì¼ ê²½ê³  ëª¨ë‹¬ í‘œì‹œ
        function showDuplicateWarningModal(data) {
            const modal = document.getElementById('duplicateWarningModal');
            const messageEl = document.getElementById('duplicateMessage');
            const filenameEl = document.getElementById('existingFilename');
            const uploadDateEl = document.getElementById('existingUploadDate');
            const versionEl = document.getElementById('existingVersion');
            const statusEl = document.getElementById('existingStatus');
            const warningTypeEl = document.getElementById('warningTypeInfo');
            const additionalInfoEl = document.getElementById('additionalInfo');
            const forceUploadBtn = document.getElementById('forceUploadBtn');
            const viewHistoryBtn = document.getElementById('viewHistoryBtn');

            // ëª¨ë‹¬ ë‚´ìš© ì„¤ì •
            messageEl.textContent = data.message || 'ì¤‘ë³µ íŒŒì¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.';
            filenameEl.textContent = data.existingFilename || '-';
            uploadDateEl.textContent = data.existingUploadDate ? formatDateTime(data.existingUploadDate) : '-';
            versionEl.textContent = data.existingVersion || '-';
            statusEl.textContent = data.existingStatus || '-';

            // ê²½ê³  ìœ í˜•ì— ë”°ë¥¸ ì•„ì´ì½˜ ë° ìƒ‰ìƒ
            let warningIcon = 'fa-exclamation-triangle';
            let warningColor = 'text-yellow-600';
            if (data.warningType === 'EXACT_DUPLICATE') {
                warningIcon = 'fa-copy';
                warningColor = 'text-red-600';
            } else if (data.warningType === 'SAME_VERSION') {
                warningIcon = 'fa-code-branch';
                warningColor = 'text-orange-600';
            } else if (data.warningType === 'OLDER_VERSION') {
                warningIcon = 'fa-history';
                warningColor = 'text-blue-600';
            }

            warningTypeEl.innerHTML = `<i class="fas ${warningIcon} ${warningColor} mr-2"></i>${data.warningType || ''}`;
            additionalInfoEl.textContent = data.additionalInfo || '';

            // ê°•ì œ ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            if (data.canForceUpload) {
                forceUploadBtn.disabled = false;
                forceUploadBtn.classList.remove('btn-disabled');
            } else {
                forceUploadBtn.disabled = true;
                forceUploadBtn.classList.add('btn-disabled');
            }

            // ì´ë ¥ ë³´ê¸° ë§í¬ ì„¤ì •
            if (data.existingUploadId) {
                viewHistoryBtn.href = `/upload-history?id=${data.existingUploadId}`;
            }

            // ëª¨ë‹¬ ì—´ê¸°
            modal.classList.add('modal-open');
        }

        // ì¤‘ë³µ ëª¨ë‹¬ ë‹«ê¸°
        function closeDuplicateModal() {
            const modal = document.getElementById('duplicateWarningModal');
            modal.classList.remove('modal-open');

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            const fileInput = document.getElementById('file');
            fileInput.value = '';
            document.getElementById('fileInfo').classList.add('hidden');
        }

        // ê°•ì œ ì—…ë¡œë“œ
        function forceUpload() {
            // ê°•ì œ ì—…ë¡œë“œ í”Œë˜ê·¸ë¥¼ í¼ì— ì¶”ê°€
            const form = document.querySelector('form');
            let forceInput = document.getElementById('forceUploadInput');

            if (!forceInput) {
                forceInput = document.createElement('input');
                forceInput.type = 'hidden';
                forceInput.id = 'forceUploadInput';
                forceInput.name = 'forceUpload';
                form.appendChild(forceInput);
            }

            forceInput.value = 'true';

            // ëª¨ë‹¬ ë‹«ê¸°
            closeDuplicateModal();

            // í¼ ì œì¶œ
            console.log('Force uploading file...');
            htmx.trigger(form, 'submit');
        }

        // ë‚ ì§œ/ì‹œê°„ í¬ë§·íŒ…
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
      </script>

      <style>
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(100%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }

        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }
        .animate-slideIn {
          animation: slideIn 0.3s ease-out;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }
        .animate-spin {
          animation: spin 1s linear infinite;
        }

        /* ì»¤ìŠ¤í…€ íŒŒì¼ ì…ë ¥ ìŠ¤íƒ€ì¼ë§ */
        input[type="file"]::-webkit-file-upload-button {
          transition: all 0.2s ease-in-out;
        }
        input[type="file"]:hover::-webkit-file-upload-button {
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆï¿½ï¿½ì´ì…˜ */
        .progress {
          background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
          overflow: hidden;
        }
        .progress::-webkit-progress-bar {
          background-color: #f3f4f6;
          border-radius: 4px;
        }
        .progress::-webkit-progress-value {
          background: linear-gradient(45deg, #3b82f6, #1d4ed8);
          border-radius: 4px;
          transition: width 0.3s ease;
        }

        /* ë¡œê·¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #log-update {
          font-family: "Courier New", monospace;
          line-height: 1.4;
        }
        #log-update .log-entry {
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          padding: 2px 0;
        }
        #log-update .log-entry:hover {
          background-color: rgba(255, 255, 255, 0.05);
        }

        /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
        @media (max-width: 768px) {
          .grid {
            grid-template-columns: 1fr;
          }
          .container {
            padding: 1rem;
          }
        }
      </style>
    </th:block>
  </body>
</html>
