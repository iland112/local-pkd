<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}"
>
  <body>
    <div layout:fragment="content">
      <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 성공 메시지 -->
        <div
          th:if="${successMessage}"
          class="mb-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-md"
          x-data="{ show: true }"
          x-show="show"
          x-init="setTimeout(() => show = false, 5000)"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
              <span class="text-green-700 font-medium" th:text="${successMessage}">
                파일 업로드가 완료되었습니다.
              </span>
            </div>
            <button @click="show = false" class="text-green-500 hover:text-green-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- 에러 메시지 -->
        <div
          th:if="${errorMessage}"
          class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-md"
          x-data="{ show: true }"
          x-show="show"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-exclamation-circle text-red-500 mr-3 text-xl"></i>
              <span class="text-red-700 font-medium" th:text="${errorMessage}">
                오류가 발생했습니다.
              </span>
            </div>
            <button @click="show = false" class="text-red-500 hover:text-red-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- 페이지 헤더 -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4">
            <div class="flex items-center justify-between">
              <h1 class="text-2xl font-bold flex items-center gap-3">
                <i class="fas fa-history"></i>
                파일 업로드 이력
              </h1>
              <button
                onclick="location.reload()"
                class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-md transition-colors flex items-center gap-2"
              >
                <i class="fas fa-sync-alt"></i>
                새로고침
              </button>
            </div>
          </div>

          <!-- 통계 카드 -->
          <div class="bg-gray-50 px-6 py-4 border-b">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <!-- 전체 업로드 -->
              <div class="stat-card bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                  <div class="w-full">
                    <div class="text-sm text-gray-600 mb-2 flex items-center gap-2">
                      <i class="fas fa-database text-blue-500"></i>
                      전체 업로드
                    </div>
                    <div class="text-3xl font-bold text-blue-600">
                      <span th:text="${statistics.totalCount ?: 0}">0</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">총 업로드 건수</div>
                  </div>
                </div>
              </div>

              <!-- 성공 -->
              <div class="stat-card bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                  <div class="w-full">
                    <div class="text-sm text-gray-600 mb-2 flex items-center gap-2">
                      <i class="fas fa-check-circle text-green-500"></i>
                      성공
                    </div>
                    <div class="text-3xl font-bold text-green-600">
                      <span th:text="${statistics.successCount ?: 0}">0</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">처리 완료 건수</div>
                  </div>
                </div>
              </div>

              <!-- 실패 -->
              <div class="stat-card bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                  <div class="w-full">
                    <div class="text-sm text-gray-600 mb-2 flex items-center gap-2">
                      <i class="fas fa-times-circle text-red-500"></i>
                      실패
                    </div>
                    <div class="text-3xl font-bold text-red-600">
                      <span th:text="${statistics.failedCount ?: 0}">0</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">오류 발생 건수</div>
                  </div>
                </div>
              </div>

              <!-- 성공률 -->
              <div class="stat-card bg-white p-4 rounded-lg shadow-sm border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                  <div class="w-full">
                    <div class="text-sm text-gray-600 mb-2 flex items-center gap-2">
                      <i class="fas fa-chart-line text-purple-500"></i>
                      성공률
                    </div>
                    <div class="text-3xl font-bold text-purple-600">
                      <span th:text="${statistics.successRate != null ? statistics.successRate : 0.0}">0.0</span>%
                    </div>
                    <div class="text-xs text-gray-500 mt-1">전체 대비 성공률</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 필터 영역 -->
          <div class="p-6 bg-white">
            <form method="get" action="/upload-history" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- 파일 포맷 필터 -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-file-alt text-blue-500 mr-1"></i>
                    파일 포맷
                  </label>
                  <select
                    name="format"
                    class="select select-bordered w-full"
                    th:value="${criteria?.fileFormat}"
                  >
                    <option value="">전체</option>
                    <option
                      th:each="fmt : ${fileFormatOptions}"
                      th:value="${fmt}"
                      th:text="${fmt.description}"
                      th:selected="${criteria?.fileFormat == fmt}"
                    >
                      Format
                    </option>
                  </select>
                </div>

                <!-- 업로드 상태 필터 -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-info-circle text-green-500 mr-1"></i>
                    업로드 상태
                  </label>
                  <select
                    name="status"
                    class="select select-bordered w-full"
                    th:value="${criteria?.uploadStatus}"
                  >
                    <option value="">전체</option>
                    <option
                      th:each="stat : ${uploadStatusOptions}"
                      th:value="${stat}"
                      th:text="${stat.displayName}"
                      th:selected="${criteria?.uploadStatus == stat}"
                    >
                      Status
                    </option>
                  </select>
                </div>

                <!-- 시작 날짜 -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-calendar-alt text-purple-500 mr-1"></i>
                    시작 날짜
                  </label>
                  <input
                    type="date"
                    name="startDate"
                    class="input input-bordered w-full"
                    th:value="${criteria?.startDate != null ? #temporals.format(criteria.startDate, 'yyyy-MM-dd') : ''}"
                  />
                </div>

                <!-- 종료 날짜 -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-calendar-check text-purple-500 mr-1"></i>
                    종료 날짜
                  </label>
                  <input
                    type="date"
                    name="endDate"
                    class="input input-bordered w-full"
                    th:value="${criteria?.endDate != null ? #temporals.format(criteria.endDate, 'yyyy-MM-dd') : ''}"
                  />
                </div>

                <!-- 파일명 검색 -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-search text-gray-500 mr-1"></i>
                    파일명 검색
                  </label>
                  <input
                    type="text"
                    name="fileName"
                    placeholder="파일명 입력..."
                    class="input input-bordered w-full"
                    th:value="${criteria?.fileName}"
                  />
                </div>
              </div>

              <div class="flex gap-2">
                <button
                  type="submit"
                  class="btn btn-primary"
                >
                  <i class="fas fa-filter mr-2"></i>
                  필터 적용
                </button>
                <a
                  href="/upload-history"
                  class="btn btn-outline"
                >
                  <i class="fas fa-redo mr-2"></i>
                  초기화
                </a>
              </div>
            </form>
          </div>
        </div>

        <!-- 결과 테이블 -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
              <thead class="bg-gray-100">
                <tr>
                  <th class="text-center">ID</th>
                  <th>파일명</th>
                  <th class="text-center">포맷</th>
                  <th class="text-center">크기</th>
                  <th class="text-center">상태</th>
                  <th class="text-center">업로드 시간</th>
                  <th class="text-center">작업</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  th:each="history : ${uploadHistory.content}"
                  th:id="'row-' + ${history.id}"
                  th:class="${highlightId != null && highlightId == history.id} ? 'bg-green-100 hover:bg-green-200 cursor-pointer transition-colors duration-500' : 'hover:bg-gray-50 cursor-pointer'"
                >
                  <td class="text-center font-mono text-sm" th:text="${history.id}">1</td>
                  <td>
                    <div class="flex items-center gap-2">
                      <i class="fas fa-file text-blue-500"></i>
                      <span class="font-medium" th:text="${history.filename}">filename.ldif</span>
                    </div>
                  </td>
                  <td class="text-center">
                    <span
                      class="badge badge-info"
                      th:text="${history.fileFormat?.description}"
                      th:classappend="${history.fileFormat?.name() == 'LDIF' ? 'badge-primary' : 'badge-secondary'}"
                    >
                      LDIF
                    </span>
                  </td>
                  <td class="text-center font-mono text-sm" th:text="${history.fileSizeDisplay}">45 MB</td>
                  <td class="text-center">
                    <span
                      class="badge"
                      th:text="${history.status?.displayName}"
                      th:classappend="${history.status?.name() == 'SUCCESS' ? 'badge-success' :
                                       history.status?.name() == 'FAILED' ? 'badge-error' :
                                       'badge-warning'}"
                    >
                      성공
                    </span>
                  </td>
                  <td class="text-center text-sm" th:text="${#temporals.format(history.uploadedAt, 'yyyy-MM-dd HH:mm:ss')}">
                    2025-10-17 12:00:00
                  </td>
                  <td class="text-center">
                    <button
                      class="btn btn-sm btn-ghost"
                      th:onclick="|showDetailModal(${history.id})|"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
                <tr th:if="${uploadHistory.empty}">
                  <td colspan="7" class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-2"></i>
                    <div>업로드 이력이 없습니다.</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 페이지네이션 -->
          <div class="flex justify-between items-center p-4 bg-gray-50 border-t" th:if="${!uploadHistory.empty}">
            <div class="text-sm text-gray-600">
              전체 <span class="font-semibold" th:text="${totalElements}">0</span>개 중
              <span class="font-semibold" th:text="${uploadHistory.numberOfElements}">0</span>개 표시
            </div>

            <div class="btn-group">
              <!-- 이전 페이지 -->
              <a
                th:if="${currentPage > 0}"
                th:href="@{/upload-history(page=${currentPage - 1}, size=${size}, format=${criteria?.fileFormat}, status=${criteria?.uploadStatus}, startDate=${criteria?.startDate}, endDate=${criteria?.endDate}, fileName=${criteria?.fileName})}"
                class="btn btn-sm"
              >
                <i class="fas fa-chevron-left"></i>
              </a>
              <button class="btn btn-sm" disabled th:if="${currentPage == 0}">
                <i class="fas fa-chevron-left"></i>
              </button>

              <!-- 페이지 번호 -->
              <button class="btn btn-sm btn-active">
                <span th:text="${currentPage + 1}">1</span> / <span th:text="${totalPages}">10</span>
              </button>

              <!-- 다음 페이지 -->
              <a
                th:if="${currentPage < totalPages - 1}"
                th:href="@{/upload-history(page=${currentPage + 1}, size=${size}, format=${criteria?.fileFormat}, status=${criteria?.uploadStatus}, startDate=${criteria?.startDate}, endDate=${criteria?.endDate}, fileName=${criteria?.fileName})}"
                class="btn btn-sm"
              >
                <i class="fas fa-chevron-right"></i>
              </a>
              <button class="btn btn-sm" disabled th:if="${currentPage >= totalPages - 1}">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>

            <!-- 페이지 크기 선택 -->
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600">페이지당</label>
              <select
                class="select select-sm select-bordered"
                onchange="changePageSize(this.value)"
              >
                <option value="10" th:selected="${size == 10}">10</option>
                <option value="20" th:selected="${size == 20}">20</option>
                <option value="50" th:selected="${size == 50}">50</option>
                <option value="100" th:selected="${size == 100}">100</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- 상세 정보 모달 (Alpine.js) -->
      <div x-data="{ open: false, detail: null }" @keydown.escape.window="open = false" @show-detail.window="open = true; detail = $event.detail">
        <div x-show="open" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
          <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">
                  <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                  업로드 이력 상세 정보
                </h3>
                <button @click="open = false" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>

              <div x-show="detail" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="font-semibold text-gray-700">파일명:</label>
                    <div class="text-gray-900" x-text="detail?.originalFileName || 'N/A'"></div>
                  </div>
                  <div>
                    <label class="font-semibold text-gray-700">파일 포맷:</label>
                    <div class="text-gray-900" x-text="detail?.fileFormat?.description || 'N/A'"></div>
                  </div>
                  <div>
                    <label class="font-semibold text-gray-700">파일 크기:</label>
                    <div class="text-gray-900" x-text="detail?.fileSizeDisplay || 'N/A'"></div>
                  </div>
                  <div>
                    <label class="font-semibold text-gray-700">업로드 상태:</label>
                    <div class="text-gray-900">
                      <span class="badge" :class="{
                        'badge-success': detail?.uploadStatus?.name === 'SUCCESS',
                        'badge-error': detail?.uploadStatus?.name === 'FAILED',
                        'badge-warning': detail?.uploadStatus?.name !== 'SUCCESS' && detail?.uploadStatus?.name !== 'FAILED'
                      }" x-text="detail?.uploadStatus?.displayName || 'N/A'"></span>
                    </div>
                  </div>
                  <div>
                    <label class="font-semibold text-gray-700">업로드 시간:</label>
                    <div class="text-gray-900" x-text="detail?.uploadedAt ? new Date(detail.uploadedAt).toLocaleString('ko-KR') : 'N/A'"></div>
                  </div>
                  <div>
                    <label class="font-semibold text-gray-700">파일 해시:</label>
                    <div class="text-gray-900 font-mono text-xs break-all" x-text="detail?.fileHash || 'N/A'"></div>
                  </div>
                  <template x-if="detail?.calculatedChecksum">
                    <div class="col-span-2">
                      <label class="font-semibold text-gray-700">계산된 체크섬:</label>
                      <div class="text-gray-900 font-mono text-xs break-all" x-text="detail.calculatedChecksum"></div>
                    </div>
                  </template>
                  <template x-if="detail?.errorMessage">
                    <div class="col-span-2">
                      <label class="font-semibold text-red-700">오류 메시지:</label>
                      <div class="text-red-600 bg-red-50 p-3 rounded-md" x-text="detail.errorMessage"></div>
                    </div>
                  </template>
                </div>
              </div>

              <div class="mt-6 flex justify-end">
                <button @click="open = false" class="btn btn-primary">닫기</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <th:block layout:fragment="script-content">
      <script>
        // 상세 정보 모달 표시 (Alpine.js 이벤트 기반)
        async function showDetailModal(id) {
          try {
            const response = await fetch(`/upload-history/${id}`);
            if (!response.ok) {
              throw new Error('Failed to fetch detail');
            }
            const data = await response.json();

            // Alpine.js 이벤트로 모달 표시
            window.dispatchEvent(new CustomEvent('show-detail', {
              detail: data
            }));
          } catch (error) {
            console.error('Error fetching detail:', error);
            showNotification('상세 정보를 불러오는 중 오류가 발생했습니다.', 'error');
          }
        }

        // 페이지 크기 변경
        function changePageSize(size) {
          const url = new URL(window.location.href);
          url.searchParams.set('size', size);
          url.searchParams.set('page', '0');
          window.location.href = url.toString();
        }

        // 페이지 로드 시 하이라이트된 행으로 스크롤
        document.addEventListener('DOMContentLoaded', function() {
          const highlightId = /*[[${highlightId}]]*/ null;
          if (highlightId) {
            const row = document.getElementById('row-' + highlightId);
            if (row) {
              // 약간의 지연 후 스크롤 (페이지 렌더링 완료 대기)
              setTimeout(() => {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 300);
            }
          }
        });

        // 알림 표시 함수
        function showNotification(message, type = 'info') {
          const colors = {
            info: 'bg-blue-50 border-blue-200 text-blue-700',
            success: 'bg-green-50 border-green-200 text-green-700',
            warning: 'bg-yellow-50 border-yellow-200 text-yellow-700',
            error: 'bg-red-50 border-red-200 text-red-700'
          };

          const icons = {
            info: 'fas fa-info-circle',
            success: 'fas fa-check-circle',
            warning: 'fas fa-exclamation-triangle',
            error: 'fas fa-times-circle'
          };

          const notification = document.createElement('div');
          notification.className = `fixed top-4 right-4 p-4 rounded-lg border ${colors[type]} shadow-lg z-50 max-w-md animate-slideIn`;
          notification.innerHTML = `
            <div class="flex items-center">
              <i class="${icons[type]} mr-2"></i>
              <span class="flex-1">${message}</span>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-75">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;

          document.body.appendChild(notification);

          setTimeout(() => {
            if (notification.parentNode) {
              notification.style.opacity = '0';
              notification.style.transform = 'translateX(100%)';
              setTimeout(() => notification.remove(), 300);
            }
          }, 5000);
        }
      </script>

      <style>
        /* Badge 스타일 */
        .badge {
          display: inline-block;
          padding: 0.25rem 0.75rem;
          font-size: 0.75rem;
          font-weight: 600;
          line-height: 1;
          border-radius: 0.375rem;
        }

        .badge-success {
          background-color: rgb(220 252 231);
          color: rgb(22 163 74);
        }

        .badge-error {
          background-color: rgb(254 226 226);
          color: rgb(220 38 38);
        }

        .badge-warning {
          background-color: rgb(254 249 195);
          color: rgb(202 138 4);
        }

        .badge-info {
          background-color: rgb(219 234 254);
          color: rgb(29 78 216);
        }

        /* 통계 카드 애니메이션 */
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .stat-card {
          animation: fadeInUp 0.5s ease-out;
        }

        .stat-card:nth-child(1) { animation-delay: 0s; }
        .stat-card:nth-child(2) { animation-delay: 0.1s; }
        .stat-card:nth-child(3) { animation-delay: 0.2s; }
        .stat-card:nth-child(4) { animation-delay: 0.3s; }

        .stat-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
        }

        /* 슬라이드 애니메이션 */
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(100%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }

        .animate-slideIn {
          animation: slideIn 0.3s ease-out;
        }
      </style>
    </th:block>
  </body>
</html>
