<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="head-content">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${pageTitle} ?: 'ICAO PKD Download File Manager'">ICAO PKD Download File Manager</title>
    <link rel="stylesheet" th:href="@{/css/application.css}" />
    <link rel="stylesheet" th:href="@{/css/dashboard.css}" />
    <!-- Heroicons sizing utilities -->
    <style>
        .hero-icon { width: 1.25rem; height: 1.25rem; display: inline-block; vertical-align: middle; }
        .hero-icon-sm { width: 1rem; height: 1rem; }
        .hero-icon-lg { width: 1.5rem; height: 1.5rem; }
        .hero-icon-xl { width: 2rem; height: 2rem; }
        .hero-icon-2xl { width: 2.5rem; height: 2.5rem; }
        .hero-icon-3xl { width: 3rem; height: 3rem; }
    </style>

    <!-- Apache ECharts (Apache License 2.0) -->
    <script type="text/javascript" th:src="@{/js/vendor/echarts/echarts.min.js}"></script>

    <!-- Alpine.js Core -->
    <script
      type="text/javascript"
      th:src="@{/webjars/alpinejs/dist/cdn.min.js}"
      defer
    ></script>

    <!-- Global Alpine Store & Components -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('theme', {
                darkMode: localStorage.getItem('theme') === 'dark' || 
                          (localStorage.getItem('theme') === null && window.matchMedia('(prefers-color-scheme: dark)').matches),

                init() {
                    this.updateTheme();
                    // OS theme change listener
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                        // Only switch if no theme is explicitly set in localStorage
                        if (localStorage.getItem('theme') === null) {
                            this.darkMode = e.matches;
                            this.updateTheme();
                        }
                    });
                },

                toggle() {
                    this.darkMode = !this.darkMode;
                    // When toggling, always set a value in localStorage
                    localStorage.setItem('theme', this.darkMode ? 'dark' : 'winter');
                    this.updateTheme();
                },
                
                updateTheme() {
                    // This ensures the theme is set on the HTML tag on initial load and on change
                    document.documentElement.setAttribute('data-theme', this.darkMode ? 'dark' : 'winter');
                }
            });

            Alpine.store('app', {
              ldapStatus: {
                connected: false,
                message: '확인 중...',
              },
              ldapTesting: false,
    
              async checkLdapStatus() {
                try {
                  const response = await fetch('/api/ldap/health'); 
                  const data = await response.json();
                  this.ldapStatus.connected = data.success;
                  this.ldapStatus.message = data.message || '연결 실패';
                } catch (error) {
                  console.error('LDAP status check failed:', error);
                  this.ldapStatus.connected = false;
                  this.ldapStatus.message = '연결 확인 불가';
                }
              },
    
              async testLdapConnection() {
                this.ldapTesting = true;
                try {
                  const response = await fetch('/api/ldap/health');
                  const data = await response.json();
                  showNotification(data.message, data.success ? 'success' : 'error');
                  await this.checkLdapStatus();
                } catch (error) {
                  showNotification('LDAP 연결 테스트에 실패했습니다.', 'error');
                } finally {
                  this.ldapTesting = false;
                }
              }
            });
        });

        // Global component functions
        function dashboardApp() {
            return {
              // 상태 데이터
              currentDate: '',
              currentTime: '',
              dbConnected: false,
              dbMessage: '확인 중...',
              dbTesting: false,
              statistics: {
                totalCount: 0,
                successCount: 0,
                failedCount: 0,
                successRate: 0
              },
              certificateStatistics: {
                  totalCertificates: 0,
                  validCertificates: 0,
                  invalidCertificates: 0,
                  totalCrls: 0,
                  lastUpdated: null,
                  certificatesByType: {},
                  certificatesByCountry: {}
              },
              recentActivity: [],
              loadingRecent: false,

              // ECharts instances (initialized to null)
              certificateStatusChartInstance: null,
              certificateTypeChartInstance: null,

              // Pastel color palette for charts
              pastelColors: {
                light: ['#A5B4FC', '#FCA5A5', '#86EFAC', '#FDE68A', '#C4B5FD', '#FBCFE8', '#99F6E4', '#FED7AA', '#A7F3D0', '#DDD6FE'],
                dark: ['#818CF8', '#F87171', '#4ADE80', '#FBBF24', '#A78BFA', '#F472B6', '#2DD4BF', '#FB923C', '#34D399', '#C4B5FD']
              },
              statusColors: {
                valid: { light: '#86EFAC', dark: '#4ADE80' },
                invalid: { light: '#FCA5A5', dark: '#F87171' }
              },


              // 초기화
              init() {
                this.updateDateTime();
                this.checkDatabaseStatus();
                Alpine.store('app').checkLdapStatus();
                this.loadStatistics();
                this.loadRecentActivity();
                this.loadCertificateStatistics();
  
                setInterval(() => this.updateDateTime(), 60000);
                setInterval(() => {
                  this.checkDatabaseStatus();
                  Alpine.store('app').checkLdapStatus();
                }, 300000);

                this.$watch('$store.theme.darkMode', () => {
                    this.recreateAllCharts();
                });

                // Window resize handler for ECharts
                window.addEventListener('resize', () => {
                  this.resizeAllCharts();
                });
              },

              resizeAllCharts() {
                if (this.certificateStatusChartInstance) this.certificateStatusChartInstance.resize();
                if (this.certificateTypeChartInstance) this.certificateTypeChartInstance.resize();
              },
  
              // 날짜/시간 업데이트
              updateDateTime() {
                const now = new Date();
                this.currentDate = now.toLocaleDateString('ko-KR', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  weekday: 'short'
                });
                this.currentTime = now.toLocaleTimeString('ko-KR');
              },
  
              // DB 상태 확인
              async checkDatabaseStatus() {
                try {
                  const response = await fetch('/api/database-health');
                  const data = await response.json();
                  this.dbConnected = data.success;
                  this.dbMessage = data.success ? `${data.database} ${data.version}` : (data.message || '연결 실패');
                } catch (error) {
                  console.error('Database status check failed:', error);
                  this.dbConnected = false;
                  this.dbMessage = '연결 확인 불가';
                }
              },
  
              async testDatabaseConnection() {
                this.dbTesting = true;
                try {
                  const response = await fetch('/api/database-health');
                  const data = await response.json();
                  showNotification(data.message, data.success ? 'success' : 'error');
                  this.checkDatabaseStatus();
                } catch (error) {
                  showNotification('연결 테스트에 실패했습니다.', 'error');
                } finally {
                  this.dbTesting = false;
                }
              },
  
              // 통계 로드
              async loadStatistics() {
                try {
                  const response = await fetch('/upload-history/statistics');
                  if (response.ok) {
                    const data = await response.json();
                    this.statistics = {
                      totalCount: data.totalCount || 0,
                      successCount: data.successCount || 0,
                      failedCount: data.failedCount || 0,
                      successRate: 0
                    };
                  }
                } catch (error) {
                  console.error('Failed to load statistics:', error);
                }
              },

              // 이미지 프리로드
  
              // 인증서 통계 로드
              async loadCertificateStatistics() {
                  try {
                      const response = await fetch('/api/certificates/statistics'); 
                      if (response.ok) {
                          const data = await response.json();
                          this.certificateStatistics = {
                              totalCertificates: data.totalCertificates || 0,
                              validCertificates: data.validCertificates || 0,
                              invalidCertificates: data.invalidCertificates || 0,
                              totalCrls: data.totalCrls || 0,
                              lastUpdated: data.lastUpdated ? new Date(data.lastUpdated) : null,
                              certificatesByType: data.certificatesByType || {},
                              certificatesByCountry: data.certificatesByCountry || {}
                          };
                          
                          this.$nextTick(() => {
                              this.createCertificateStatusDonutChart();
                              this.createCertificateTypeDonutChart();
                          });

                      } else {
                          console.warn('Failed to load certificate statistics, API might not be implemented yet.');
                      }
                  } catch (error) {
                      console.error('Error loading certificate statistics:', error);
                  }
              },
  
              // 최근 활동 로드
              async loadRecentActivity() {
                this.loadingRecent = true;
                try {
                  const response = await fetch('/upload-history/recent?limit=5');
                  if (response.ok) {
                    const data = await response.json();
                    this.recentActivity = data.map(item => ({
                      ...item,
                      statusDisplay: this.getStatusDisplay(item.status)
                    }));
                  }
                } catch (error) {
                  console.error('Failed to load recent activity:', error);
                } finally {
                  this.loadingRecent = false;
                }
              },
  
              // 상태 표시명 가져오기
              getStatusDisplay(status) {
                const statusMap = {'RECEIVED': '수신됨','VALIDATING': '검증 중','VALIDATED': '검증 완료','PARSING': '파싱 중','PARSED': '파싱 완료','UPLOADING_TO_LDAP': 'LDAP 업로드 중','COMPLETED': '완료','FAILED': '실패'};
                return statusMap[status] || status;
              },
  
              // 날짜 포맷팅
              formatDateTime(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) { // Invalid Date 객체인지 확인
                  console.error('Invalid date string provided:', dateString);
                  return 'Invalid Date'; // 또는 다른 적절한 오류 메시지
                }
                return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
              },

              // ECharts Helpers
              getCurrentPastelColors() {
                return this.$store.theme.darkMode ? this.pastelColors.dark : this.pastelColors.light;
              },

              getTextColor() {
                return this.$store.theme.darkMode ? '#9CA3AF' : '#6B7280';
              },

              // Recreate all charts on theme change
              recreateAllCharts() {
                this.createCertificateStatusDonutChart();
                this.createCertificateTypeDonutChart();
              },

              // Helper functions for Certificate Country List (PKD Dashboard)
              getTopCountriesCert() {
                const entries = Object.entries(this.certificateStatistics.certificatesByCountry);
                if (entries.length === 0) return [];
                const sorted = entries.sort((a, b) => b[1] - a[1]).slice(0, 18);
                const maxCount = sorted[0][1];
                return sorted.map(([country, count]) => ({
                  country,
                  count,
                  percentage: Math.max(5, (count / maxCount) * 100) // minimum 5% for visibility
                }));
              },

              getCountryColorCert(index) {
                const colors = [
                  '#06B6D4', '#0891B2', '#0E7490', '#14B8A6', '#0D9488',
                  '#6366F1', '#4F46E5', '#8B5CF6', '#7C3AED', '#A855F7',
                  '#EC4899', '#DB2777', '#F97316', '#EA580C', '#EAB308',
                  '#84CC16', '#22C55E', '#10B981'
                ];
                return colors[index % colors.length];
              },

              // Create Donut Chart for Certificate Status (Valid/Invalid)
              createCertificateStatusDonutChart() {
                const container = document.getElementById('certificateStatusChart');
                if (!container) return;

                if (this.certificateStatusChartInstance) {
                  this.certificateStatusChartInstance.dispose();
                }

                const isDark = this.$store.theme.darkMode;
                const total = this.certificateStatistics.validCertificates + this.certificateStatistics.invalidCertificates;

                this.certificateStatusChartInstance = echarts.init(container, isDark ? 'dark' : null);

                const option = {
                  backgroundColor: 'transparent',
                  tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}개 ({d}%)'
                  },
                  legend: {
                    bottom: '5%',
                    left: 'center',
                    textStyle: { color: this.getTextColor() }
                  },
                  graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'center',
                    style: {
                      text: `총 인증서\n${total.toLocaleString()}`,
                      textAlign: 'center',
                      fill: isDark ? '#F3F4F6' : '#1F2937',
                      fontSize: 14,
                      fontWeight: 'bold'
                    }
                  },
                  series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 4, borderColor: 'transparent', borderWidth: 2 },
                    label: { show: false },
                    emphasis: {
                      label: { show: true, fontSize: 14, fontWeight: 'bold' },
                      itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.3)' }
                    },
                    labelLine: { show: false },
                    data: [
                      { value: this.certificateStatistics.validCertificates, name: '유효', itemStyle: { color: isDark ? this.statusColors.valid.dark : this.statusColors.valid.light } },
                      { value: this.certificateStatistics.invalidCertificates, name: '무효', itemStyle: { color: isDark ? this.statusColors.invalid.dark : this.statusColors.invalid.light } }
                    ]
                  }]
                };

                this.certificateStatusChartInstance.setOption(option);
              },

              // Create Donut Chart for Certificate Type Statistics
              createCertificateTypeDonutChart() {
                const container = document.getElementById('certificateTypeChart');
                if (!container) return;

                if (this.certificateTypeChartInstance) {
                  this.certificateTypeChartInstance.dispose();
                }

                const isDark = this.$store.theme.darkMode;
                const colors = this.getCurrentPastelColors();
                const typeData = this.certificateStatistics.certificatesByType;
                const total = Object.values(typeData).reduce((a, b) => a + b, 0);

                this.certificateTypeChartInstance = echarts.init(container, isDark ? 'dark' : null);

                const seriesData = Object.entries(typeData).map(([name, value], index) => ({
                  value,
                  name,
                  itemStyle: { color: colors[index % colors.length] }
                }));

                const option = {
                  backgroundColor: 'transparent',
                  tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}개 ({d}%)'
                  },
                  legend: {
                    bottom: '5%',
                    left: 'center',
                    textStyle: { color: this.getTextColor() }
                  },
                  graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'center',
                    style: {
                      text: `총 인증서\n${total.toLocaleString()}`,
                      textAlign: 'center',
                      fill: isDark ? '#F3F4F6' : '#1F2937',
                      fontSize: 14,
                      fontWeight: 'bold'
                    }
                  },
                  series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 4, borderColor: 'transparent', borderWidth: 2 },
                    label: { show: false },
                    emphasis: {
                      label: { show: true, fontSize: 14, fontWeight: 'bold' },
                      itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.3)' }
                    },
                    labelLine: { show: false },
                    data: seriesData
                  }]
                };

                this.certificateTypeChartInstance.setOption(option);
              },

            }
          }
    </script>
</head>
</html>
