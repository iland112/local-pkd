<!DOCTYPE html>
<html
  th:lang="|${#locale.language}-${#locale.country}|"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${pageTitle} ?: 'ICAO PKD Download File Manager'">ICAO PKD Download File Manager</title>
    <link rel="stylesheet" th:href="@{/css/application.css}" />
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/css/all.min.css}" />
  </head>
  <body class="bg-gray-50">
    <!-- 네비게이션 바 -->
    <nav class="bg-white shadow-md border-b border-gray-200 sticky top-0 z-40">
      <div class="container mx-auto max-w-7xl">
        <div class="flex items-center justify-between h-16 px-4">
          <!--  로고 및 브랜드 -->
          <div class="flex items-center space-x-4">
            <a href="/" class="flex items-center space-x-3 hover:opacity-80 transition-opacity">
              <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-shield-alt text-white text-lg"></i>
              </div>
              <div class="hidden md:block">
                <h1 class="text-xl font-bold text-gray-900">ICAO Local PKD Manager</h1>
                <p class="text-xs text-gray-500">CSCA MasterList,DSC,CRL,DL from which downloaded ICAO Management System</p>
              </div>
            </a>
          </div>

          <!--데스크톱 네비게이션 메뉴 -->
          <div class="hidden md:flex items-center space-x-1">
            <a href="/"
              th:class="'px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center gap-2 ' + (${currentPage} == 'home' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
            >
              <i class="fas fa-home">
                대시 보드
              </i>
            </a>
            <a href="/masterlist/upload"
              th:class="'px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center gap-2 ' + (${currentPage} == 'masterlist' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
            >
              <i class="fas fa-file-upload"></i>
              Master List
            </a>
            <a href="/ldif/upload"
              th:class="'px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center gap-2 ' + (${currentPage} == 'ldif' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
            >
              <i class="fas fa-file-code"></i>
              LDIF 파일
            </a>
            <a href="/upload-history"
              th:class="'px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center gap-2 ' + (${currentPage} == 'upload-history' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
            >
              <i class="fas fa-history"></i>
              업로드 이력
            </a>
          </div>

          <!-- 우측 유틸리티 메뉴 -->
          <div class="flex items-center space-x-3">
            <!-- LDAP 상태 표시 (Alpine.js) -->
            <div class="hidden md:flex items-center space-x-2">
              <div class="w-3 h-3 rounded-full" :class="$store.app.ldapStatus.class"></div>
              <span class="text-xs text-gray-500" x-text="$store.app.ldapStatus.message"></span>
            </div> 

            <!--  도구 드롭다운 -->
            <div class="relative" x-data="{open: false}">
              <button
                @click="open = !open"
                @click.away="open = false"
                class="p-2 text-gray-600 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-colors duration-200"
                aria-label="도구 메뉴"
              >
                <i class="fas fa-cog"></i>
              </button>
              <div
                x-show="open"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="transform opacity-0 scale-95"
                x-transition:enter-end="transform opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="transform opacity-100 scale-100"
                x-transition:leave-end="transform opacity-0 scale-95"
                class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 border border-gray-200"
                style="display: none;"
              >
                <button
                  @click="showSystemInfo()"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                >
                  <i class="fas fa-info-circle"></i>
                  시스템 정보
                </button>
                <button
                  @click="showHelp()"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                >
                  <i class="fas fa-question-circle"></i>
                  도움말
                </button>
              </div>
            </div>

            <!-- 모바일 메뉴 버튼 -->
            <div id="mobileMenu" class="md:hidden hidden bg-white border-t border-gray-200">
              <div class="px-4 py-3 space-y-2">
                <a
                  href="/"
                  th:class="'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 ' + (${currentPage} == 'home' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
                >
                  <i class="fas fa-home"></i>
                  대시보드
                </a>
                <a
                  href="/masterlist/upload"
                  th:class="'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 ' + (${currentPage} == 'masterlist' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
                >
                  <i class="fas fa-file-upload"></i>
                  Master List 업로드
                </a>
                <a
                  href="/ldif/upload"
                  th:class="'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 ' + (${currentPage} == 'ldif' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
                >
                  <i class="fas fa-file-code"></i>
                  LDIF 파일 업로드
                </a>
                <a
                  href="/upload-history"
                  th:class="'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 ' + (${currentPage} == 'upload-history' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-blue-700 hover:bg-blue-50')"
                >
                  <i class="fas fa-history"></i>
                  업로드 이력
                </a>
                <div class="border-t border-gray-200 pt-2 mt-2">
                  <button
                    @click="showSystemInfo()"
                    class="w-full text-left flex items-center gap-3 px-3 py-2 text-sm text-gray-600 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-colors duration-200"
                  >
                    <i class="fas fa-info-circle"></i>
                    시스템 정보
                  </button>
                  <button
                    @click="showHelp()"
                    class="w-full text-left flex items-center gap-3 px-3 py-2 text-sm text-gray-600 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-colors duration-200"
                  >
                    <i class="fas fa-question-circle"></i>
                    도움말
                  </button>
                </div>
              </div>
            </div> 
          </div> 
        </div>
      </div>
    </nav>

    <!-- 메인 컨텐츠 영역 -->
    <main class="min-h-screen pb-8">
      <!-- Page Content -->
      <div layout:fragment="content"></div>
    </main>
    
    <!-- 푸터 -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
      <div class="container mx-auto max-w-7xl px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
          <div class="text-sm text-gray-600">
            <p>&copy; 2025 ICAO Master List & LDIF File Manager. 안전하고 효율적인 LDAP 데이터 관리.</p>
          </div>
          <div class="flex items-center space-x-4 text-sm text-gray-500">
            <div class="flex items-center">
              <i class="fas fa-shield-alt text-green-500 mr-1"></i>
              SSL 암호화 보안
            </div>
            <div class="flex items-center">
              <i class="fas fa-server mr-1"></i>
              <span id="serverStatus">서버 정상</span>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- 시스템 정보 모달 (Alpine.js) -->
    <div x-data="{ open: false }" @keydown.escape.window="open = false">
      <div x-show="open" @show-system-info.window="open = true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">시스템 정보</h3>
              <button @click="open = false" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
              </button>
            </div>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">시스템 버전:</span>
              <span class="font-medium">v1.0.0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">빌드 날짜:</span>
              <span class="font-medium">2025-09-01</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">LDAP 버전:</span>
              <span class="font-medium">OpenLDAP 2.6</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">지원 파일 형식:</span>
              <span class="font-medium">ML, LDIF</span>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 도움말 모달 (Alpine.js) -->
    <div x-data="{ open: false }" @keydown.escape.window="open = false">
      <div x-show="open" @show-help.window="open = true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">도움말</h3>
              <button @click="open = false" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
              </button>
            </div>
          <div class="space-y-4">
            <div>
              <h4 class="font-medium text-blue-600 mb-2">키보드 단축키</h4>
              <div class="text-sm text-gray-600 space-y-1">
                <p><kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl + 1</kbd> - Master List 페이지로 이동</p>
                <p><kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl + 2</kbd> - LDIF 파일 페이지로 이동</p>
                <p><kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl + H</kbd> - 홈 페이지로 이동</p>
                <p><kbd class="bg-gray-100 px-2 py-1 rounded">ESC</kbd> - 모달 닫기</p>
              </div>
            </div>
            <div>
              <h4 class="font-medium text-green-600 mb-2">지원 파일 형식</h4>
              <div class="text-sm text-gray-600 space-y-1">
                <p><strong>Master List:</strong> .ml 확장자 (CMS SignedData 형식)</p>
                <p><strong>LDIF:</strong> .ldif 확장자 (RFC 2849 표준)</p>
                <p><strong>최대 파일 크기:</strong> 100MB</p>
              </div>
            </div>
            <div>
              <h4 class="font-medium text-purple-600 mb-2">브라우저 지원</h4>
              <div class="text-sm text-gray-600">
                <p>Chrome 80+, Firefox 75+, Safari 13+, Edge 80+</p>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 알림 컨테이너 -->
    <div id="notificationContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <script
        type="text/javascript"
        th:src="@{/webjars/alpinejs/dist/cdn.min.js}"
    ></script>
    <script
        type="text/javascript"
        th:src="@{/webjars/htmx.org/dist/htmx.min.js}"
    ></script>
    <script>
        htmx.logAll();
    </script>

    <!-- Alpine.js Global State -->
    <script>
        document.addEventListener('alpine:init', () => {
          // Global app state
          Alpine.store('app', {
            ldapStatus: {
              connected: false,
              message: '연결 확인 중',
              class: 'bg-yellow-500 animate-pulse'
            },

            init() {
              // LDAP 상태 초기 확인
              this.checkLdapStatus();

              // 5분마다 LDAP 상태 확인
              setInterval(() => this.checkLdapStatus(), 300000);
            },

            async checkLdapStatus() {
              try {
                const response = await fetch('/ldap-test-connection');
                const data = await response.json();

                if (data.success) {
                  this.ldapStatus = {
                    connected: true,
                    message: 'LDAP 연결됨',
                    class: 'bg-green-500'
                  };
                } else {
                  this.ldapStatus = {
                    connected: false,
                    message: 'LDAP 오류',
                    class: 'bg-red-500'
                  };
                }
              } catch (error) {
                this.ldapStatus = {
                  connected: false,
                  message: '연결 확인 중',
                  class: 'bg-yellow-500 animate-pulse'
                };
              }
            }
          });

          // Initialize app store
          Alpine.store('app').init();
        });

        // 시스템 정보 모달 표시 (Alpine.js 이벤트)
        function showSystemInfo() {
          window.dispatchEvent(new CustomEvent('show-system-info'));
        }

        // 도움말 모달 표시 (Alpine.js 이벤트)
        function showHelp() {
          window.dispatchEvent(new CustomEvent('show-help'));
        }

        // 키보드 단축키 설정 (Alpine.js와 호환)
        document.addEventListener('keydown', function(e) {
          // Ctrl + H: 홈으로
          if (e.ctrlKey && e.key == 'h') {
            e.preventDefault();
            window.location.href = '/';
          }

          // Ctrl + 1: Master List
          if (e.ctrlKey && e.key == '1') {
            e.preventDefault();
            window.location.href = '/icao/ml';
          }

          // Ctrl + 2: LDIF
          if (e.ctrlKey && e.key == '2') {
            e.preventDefault();
            window.location.href = '/ldif';
          }
        });

        // 알림 시스템
        function showNotification(message, type = 'info', duration = 50000) {
          const colors = {
            info: 'bg-blue-50 border-blue-200 text-blue-700',
            success: 'bg-green-50 border-green-200 text-green-700',
            warning: 'bg-yellow-50 border-yellow-200 text-yellow-700',
            error: 'bg-red-50 border-red-200 text-red-700'
          };

          const icons = {
            info: 'fas fa-info-circle',
            success: 'fas fa-check-circle',
            warning: 'fas fa-exclamation-triangle',
            error: 'fas fa-times-circle'
          };

          const notification = document.createElement('div')
          notification.className = `p-4 rounded-lg border ${colors[type]} shadow-lg max-w-md animate-slideIn`;
          notification.innerHTML = `
            <div class="flex items-center">
              <i class="${icons[type]} mr-2"></i>
              <span class="flex-1 text-sm">${message}</span>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-75">
                <i class="fas fa-times text-sm"></i>
              </button>
            </div>
          `;

          const container = document.getElementById('notificationContainer');
          container.appendChild(notification);

          setTimeout(() => {
            if (notification.parentNode) {
              notification.style.opacity = '0';
              notification.style.transform = 'translateX(100%)';
              setTimeout(() => {
                if (notification.parentNode) {
                  notification.remove();
                }
              }, 300);
            }
          }, duration);
        }

    </script>

    <th:block layout:fragment="script-content">
    </th:block>

    <style>
      /* Alpine.js x-cloak */
      [x-cloak] { display: none !important; }

      /* 애니메이션 정의 */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-slideIn {
        animation: slideIn 0.3s ease-out;
      }

      .animate-slideDown {
        animation: slideDown 0.2s ease-out;
      }

      /* 키보드 단축키 스타일 */
      kbd {
        font-family: monospace;
        font-size: 0.875rem;
        font-weight: bold;
      }

      /* 네비게이션 호버 효과 개선 */
      .nav-link {
        position: relative;
        overflow: hidden;
      }

      .nav-link::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(to right, #3b82f6, #1d4ed8);
        transition: width 0.3s ease;
      }

      .nav-link:hover::before {
        width: 100%;
      }

      /* 스크롤바 스타일 */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* 반응형 개선 */
      @media (max-width: 768px) {
        .container {
          padding-left: 1rem;
          padding-right: 1rem;
        }

        .nav-brand h1 {
          font-size: 1.125rem;
        }

        .mobile-menu-overlay {
          background-color: rgba(0, 0, 0, 0.3);
        }
      }

      /* 포커스 스타일 개선 */
      button:focus,
      a:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
        border-radius: 0.375rem;
      }

      /* 로딩 상태 */
      .loading {
        position: relative;
        overflow: hidden;
      }

      .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      /* 알림 스타일 개선 */
      .notification-enter {
        animation: notificationEnter 0.3s ease-out;
      }

      @keyframes notificationEnter {
        from {
          opacity: 0;
          transform: translateX(100%) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
      }

      /* 다크모드 지원 준비 */
      @media (prefers-color-scheme: dark) {
        .dark-mode-ready {
          transition: background-color 0.3s ease, color 0.3s ease;
        }
      }
    </style>
  </body>
</html>
